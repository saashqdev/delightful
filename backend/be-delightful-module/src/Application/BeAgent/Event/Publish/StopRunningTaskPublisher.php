<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Application\BeAgent\Event\Publish; use Delightful\BeDelightful\Domain\BeAgent\Event\StopRunningTaskEvent; use Hyperf\Amqp\Annotation\Producer; use Hyperf\Amqp\Message\ProducerMessage; use PhpAmqpLib\Message\AMQPMessage; use PhpAmqpLib\Wire\AMQPTable; /** * StopRun in TaskMessagePublishdevice.*/ #[Producer(exchange: 'be_delightful_stop_task', routingKey: 'be_delightful_stop_task')] class StopRunningTaskPublisher extends ProducerMessage { /** * ConstructFunction.*/ public function __construct(StopRunningTaskEvent $event) { $this->payload = $event->toArray(); // set AMQP MessageProperty/Attribute, includeOriginalTimetimestamp $this->properties = [ 'delivery_mode' => AMQPMessage::DELIVERY_MODE_PERSISTENT, // KeepMessagePersistence 'application_headers' => new AMQPTable([ 'x-original-timestamp' => time(), // SetOriginalTimetimestamp（ seconds level） 'x-data-type' => $event->getDataType()->value, // SetDataTypeConvenient for routing and monitoring 'x-organization-code' => $event->getOrganizationCode(), // SetOrganization code ]), ]; } } 
