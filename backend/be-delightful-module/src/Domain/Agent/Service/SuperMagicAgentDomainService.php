<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperDelightful\Domain\Agent\Service; use App\Infrastructure\Core\Exception\ExceptionBuilder; use App\Infrastructure\Core\ValueObject\Page; use DateTime; use Delightful\AsyncEvent\AsyncEventUtil; use Delightful\SuperDelightful\Domain\Agent\Entity\SuperDelightfulAgentEntity; use Delightful\SuperDelightful\Domain\Agent\Entity\ValueObject\BuiltinAgent; use Delightful\SuperDelightful\Domain\Agent\Entity\ValueObject\Query\SuperDelightfulAgentQuery; use Delightful\SuperDelightful\Domain\Agent\Entity\ValueObject\SuperDelightfulAgentDataIsolation; use Delightful\SuperDelightful\Domain\Agent\Entity\ValueObject\SuperDelightfulAgentLimit; use Delightful\SuperDelightful\Domain\Agent\Event\SuperDelightfulAgentDeletedEvent; use Delightful\SuperDelightful\Domain\Agent\Event\SuperDelightfulAgentDisabledEvent; use Delightful\SuperDelightful\Domain\Agent\Event\SuperDelightfulAgentEnabledEvent; use Delightful\SuperDelightful\Domain\Agent\Event\SuperDelightfulAgentSavedEvent; use Delightful\SuperDelightful\Domain\Agent\Repository\Facade\SuperDelightfulAgentRepositoryInterface; use Delightful\SuperDelightful\ErrorCode\SuperDelightfulErrorCode; readonly class SuperDelightfulAgentDomainService { public function __construct( protected SuperDelightfulAgentRepositoryInterface $superDelightfulAgentRepository ) { } public function getByCode(SuperDelightfulAgentDataIsolation $dataIsolation, string $code): ?SuperDelightfulAgentEntity { $this->checkBuiltinAgentOperation($code); return $this->superDelightfulAgentRepository->getByCode($dataIsolation, $code); } /** * @return array{total: int, list: array<SuperDelightfulAgentEntity>} */ public function queries(SuperDelightfulAgentDataIsolation $dataIsolation, SuperDelightfulAgentQuery $query, Page $page): array { return $this->superDelightfulAgentRepository->queries($dataIsolation, $query, $page); } public function save(SuperDelightfulAgentDataIsolation $dataIsolation, SuperDelightfulAgentEntity $savingEntity): SuperDelightfulAgentEntity { $savingEntity->setCreator($dataIsolation->getCurrentUserId()); $savingEntity->setOrganizationCode($dataIsolation->getCurrentOrganizationCode()); $isCreate = $savingEntity->shouldCreate(); if ($isCreate) { // CheckuserCreateAgentQuantitywhetherexceedLimit $currentCount = $this->superDelightfulAgentRepository->countByCreator($dataIsolation, $dataIsolation->getCurrentUserId()); if ($currentCount >= SuperDelightfulAgentLimit::MAX_AGENTS_PER_USER) { ExceptionBuilder::throw( SuperDelightfulErrorCode::AgentLimitExceeded, 'super_magic.agent.limit_exceeded', ['limit' => SuperDelightfulAgentLimit::MAX_AGENTS_PER_USER] ); } $entity = clone $savingEntity; $entity->prepareForCreation(); } else { $this->checkBuiltinAgentOperation($savingEntity->getCode()); $entity = $this->superDelightfulAgentRepository->getByCode($dataIsolation, $savingEntity->getCode()); if (! $entity) { ExceptionBuilder::throw(SuperDelightfulErrorCode::NotFound, 'common.not_found', ['label' => $savingEntity->getCode()]); } $savingEntity->prepareForModification($entity); } $savedEntity = $this->superDelightfulAgentRepository->save($dataIsolation, $entity); AsyncEventUtil::dispatch(new SuperDelightfulAgentSavedEvent($savedEntity, $isCreate)); return $savedEntity; } public function delete(SuperDelightfulAgentDataIsolation $dataIsolation, string $code): bool { $this->checkBuiltinAgentOperation($code); $entity = $this->superDelightfulAgentRepository->getByCode($dataIsolation, $code); if (! $entity) { ExceptionBuilder::throw(SuperDelightfulErrorCode::NotFound, 'common.not_found', ['label' => $code]); } $result = $this->superDelightfulAgentRepository->delete($dataIsolation, $code); if ($result) { AsyncEventUtil::dispatch(new SuperDelightfulAgentDeletedEvent($entity)); } return $result; } public function enable(SuperDelightfulAgentDataIsolation $dataIsolation, string $code): SuperDelightfulAgentEntity { $this->checkBuiltinAgentOperation($code); $entity = $this->getByCodeWithException($dataIsolation, $code); $entity->setEnabled(true); $entity->setModifier($dataIsolation->getCurrentUserId()); $entity->setUpdatedAt(new DateTime()); $savedEntity = $this->superDelightfulAgentRepository->save($dataIsolation, $entity); AsyncEventUtil::dispatch(new SuperDelightfulAgentEnabledEvent($savedEntity)); return $savedEntity; } public function disable(SuperDelightfulAgentDataIsolation $dataIsolation, string $code): SuperDelightfulAgentEntity { $this->checkBuiltinAgentOperation($code); $entity = $this->getByCodeWithException($dataIsolation, $code); $entity->setEnabled(false); $entity->setModifier($dataIsolation->getCurrentUserId()); $entity->setUpdatedAt(new DateTime()); $savedEntity = $this->superDelightfulAgentRepository->save($dataIsolation, $entity); AsyncEventUtil::dispatch(new SuperDelightfulAgentDisabledEvent($savedEntity)); return $savedEntity; } public function getByCodeWithException(SuperDelightfulAgentDataIsolation $dataIsolation, string $code): SuperDelightfulAgentEntity { $this->checkBuiltinAgentOperation($code); $entity = $this->superDelightfulAgentRepository->getByCode($dataIsolation, $code); if (! $entity) { ExceptionBuilder::throw(SuperDelightfulErrorCode::NotFound, 'common.not_found', ['label' => $code]); } return $entity; } /** * CheckwhetherForBuilt-inAgent, If is Then throwAbnormal.*/ private function checkBuiltinAgentOperation(string $code): void { $builtinAgent = BuiltinAgent::tryFrom($code); if ($builtinAgent) { ExceptionBuilder::throw(SuperDelightfulErrorCode::BuiltinAgentNotAllowed, 'super_magic.agent.builtin_not_allowed'); } } } 