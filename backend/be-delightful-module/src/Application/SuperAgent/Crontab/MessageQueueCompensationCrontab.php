<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Application\BeAgent\Crontab; use Delightful\BeDelightful\Application\BeAgent\Service\MessageQueueCompensationAppService; use Hyperf\Contract\StdoutLoggerInterface; use Hyperf\Crontab\Annotation\Crontab; use Throwable; /** * Message Queue Compensation Crontab. * MessageQueueCompensationScheduledTask - Process/HandleomitMessageQueueCompensation.*/ #[Crontab( rule: '*/30 * * * * *', // Execute every 30 seconds name: 'MessageQueueCompensationCrontab', singleton: true, // Singleton mode to prevent duplicate execution mutexExpires: 60, // Mutex lock expires in 60 seconds onOneServer: true, // Execute on only one server callback: 'execute', memo: 'Message queue compensation scheduled task for handling missed message queues' )] readonly class MessageQueueCompensationCrontab { public function __construct( private MessageQueueCompensationAppService $messageQueueCompensationAppService, private StdoutLoggerInterface $logger, ) { } /** * Main execution method. * MainExecutemethod.*/ public function execute(): void { // Check if compensation is enabled in configuration $enabled = config('be-delightful.user_message_queue.enabled', true); if (! $enabled) { return; } $startTime = microtime(true); $this->logger->info('Message queue compensation task started'); try { // Execute compensation through application service $stats = $this->messageQueueCompensationAppService->executeCompensation(); $this->logger->info('Message queue compensation task completed', $stats); } catch (Throwable $e) { $this->logger->error('Message queue compensation task failed', [ 'error' => $e->getMessage(), 'file' => $e->getFile(), 'line' => $e->getLine(), ]); } } } 