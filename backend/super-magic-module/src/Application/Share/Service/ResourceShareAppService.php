<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Dtyq\SuperMagic\Application\Share\Service; use App\Infrastructure\Core\Exception\BusinessException; use App\Infrastructure\Core\Exception\ExceptionBuilder; use App\Interfaces\Authorization\Web\MagicUserAuthorization; use Dtyq\SuperMagic\Application\Share\Factory\ShareableResourceFactory; use Dtyq\SuperMagic\Domain\Share\Constant\ResourceType; use Dtyq\SuperMagic\Domain\Share\Constant\ShareAccessType; use Dtyq\SuperMagic\Domain\Share\Entity\ResourceShareEntity; use Dtyq\SuperMagic\Domain\Share\Service\ResourceShareDomainService; use Dtyq\SuperMagic\ErrorCode\ShareErrorCode; use Dtyq\SuperMagic\Infrastructure\Utils\AccessTokenUtil; use Dtyq\SuperMagic\Infrastructure\Utils\PasswordCrypt; use Dtyq\SuperMagic\Interfaces\Share\Assembler\ShareAssembler; use Dtyq\SuperMagic\Interfaces\Share\DTO\Request\CreateShareRequestDTO; use Dtyq\SuperMagic\Interfaces\Share\DTO\Request\GetShareDetailDTO; use Dtyq\SuperMagic\Interfaces\Share\DTO\Request\ResourceListRequestDTO; use Dtyq\SuperMagic\Interfaces\Share\DTO\Response\ShareItemDTO; use Dtyq\SuperMagic\Interfaces\Share\DTO\Response\ShareItemWithPasswordDTO; use Exception; use Hyperf\Logger\LoggerFactory; use Psr\Log\LoggerInterface; use RuntimeException; /** * ResourceshareApplicationService.*/ class ResourceShareAppService extends AbstractShareAppService { protected LoggerInterface $logger; public function __construct( private ShareableResourceFactory $resourceFactory, private ResourceShareDomainService $shareDomainService, private ShareAssembler $shareAssembler, public readonly LoggerFactory $loggerFactory ) { $this->logger = $loggerFactory->get(get_class($this)); } /** * Createshare. * * @param MagicUserAuthorization $userAuthorization Currentuser * @param CreateShareRequestDTO $dto CreateshareRequestDTO * @return ShareItemDTO shareProjectDTO * @throws Exception CreateshareAbnormal*/ public function createShare(MagicUserAuthorization $userAuthorization, CreateShareRequestDTO $dto): ShareItemDTO { $resourceId = $dto->resourceId; $userId = $userAuthorization->getId(); $organizationCode = $userAuthorization->getOrganizationCode(); // ValidateResourceType $resourceType = ResourceType::from($dto->resourceType); // 1. getPair should TypeResourceFactory try { $factory = $this->resourceFactory->create($resourceType); } catch (RuntimeException $e) { // Use ExceptionBuilder Throw not SupportResourceTypeAbnormal ExceptionBuilder::throw(ShareErrorCode::RESOURCE_TYPE_NOT_SUPPORTED, 'share.resource_type_not_supported', [$resourceType->name]); } // 2. ValidateResourcewhether store inAnd canshare if (! $factory->isResourceShareable($resourceId, $organizationCode)) { ExceptionBuilder::throw(ShareErrorCode::RESOURCE_NOT_FOUND, 'share.resource_not_found_or_not_shareable', [$resourceId]); } // 3. ValidateResourceAll person Permission if (! $factory->hasSharePermission($resourceId, $userId, $organizationCode)) { ExceptionBuilder::throw(ShareErrorCode::PERMISSION_DENIED, 'share.no_permission_to_share', [$resourceId]); } // 4. Saveshare (Create orUpdate) - UseDomainService $attributes = [ 'resource_name' => $factory->getResourceName($resourceId), 'share_type' => $dto->shareType ?? ShareAccessType::Internet->value, ]; try { $savedEntity = $this->shareDomainService->saveShare( $resourceId, $resourceType->value, $userId, $organizationCode, $attributes, $dto->password, $dto->expireDays ); } catch (Exception $e) { $this->logger->error('SaveTopicshareFailedï¼ŒResult: ' . $e->getMessage()); ExceptionBuilder::throw(ShareErrorCode::CREATE_RESOURCES_ERROR, 'share.create_resources_error', [$resourceId]); } // 5. BuildResponse return $this->shareAssembler->toDto($savedEntity); } /** * Cancelshare. * * @param MagicUserAuthorization $userAuthorization Currentuser * @param int $shareId share ID * @return bool whetherSuccess * @throws Exception Cancelshare time happenAbnormal*/ public function cancelShare(MagicUserAuthorization $userAuthorization, int $shareId): bool { $userId = $userAuthorization->getId(); $organizationCode = $userAuthorization->getOrganizationCode(); // callDomainServiceCancelsharemethod return $this->shareDomainService->cancelShare($shareId, $userId, $organizationCode); } /** * @throws Exception */ public function cancelShareByResourceId(MagicUserAuthorization $userAuthorization, string $resourceId): bool { $userId = $userAuthorization->getId(); $organizationCode = $userAuthorization->getOrganizationCode(); $shareEntity = $this->shareDomainService->getShareByResourceId($resourceId); if (is_Null($shareEntity)) { return false; } // ValidateResourceType $resourceType = ResourceType::from($shareEntity->getResourceType()); // 1. getPair should TypeResourceFactory try { $factory = $this->resourceFactory->create($resourceType); } catch (RuntimeException $e) { // Use ExceptionBuilder Throw not SupportResourceTypeAbnormal ExceptionBuilder::throw(ShareErrorCode::RESOURCE_TYPE_NOT_SUPPORTED, 'share.resource_type_not_supported', [$resourceType->name]); } // 2. ValidateResourceAll person Permission if (! $factory->hasSharePermission($resourceId, $userId, $organizationCode)) { ExceptionBuilder::throw(ShareErrorCode::PERMISSION_DENIED, 'share.no_permission_to_share', [$resourceId]); } $shareEntity->setDeletedAt(date('Y-m-d H:i:s')); $shareEntity->setUpdatedAt(date('Y-m-d H:i:s')); $shareEntity->setUpdatedUid($userId); // callDomainServiceCancelsharemethod $this->shareDomainService->saveShareByEntity($shareEntity); return true; } public function checkShare(?MagicUserAuthorization $userAuthorization, string $shareCode): array { $shareEntity = $this->shareDomainService->getShareByCode($shareCode); if (empty($shareEntity)) { ExceptionBuilder::throw(ShareErrorCode::RESOURCE_NOT_FOUND, 'share.not_found', [$shareCode]); } return [ 'has_password' => ! empty($shareEntity->getPassword()), 'user_id' => ! is_Null($userAuthorization) ? $userAuthorization->getId() : '', ]; } public function getShareDetail(?MagicUserAuthorization $userAuthorization, string $shareCode, GetShareDetailDTO $detailDTO): array { //  first getDetailsContent $shareEntity = $this->shareDomainService->getShareByCode($shareCode); if (empty($shareEntity)) { ExceptionBuilder::throw(ShareErrorCode::RESOURCE_NOT_FOUND, 'share.not_found', [$shareCode]); } // ChecksumPermission, targetbeforeOnlyOnly havePermissionControl if ($shareEntity->getShareType() == ShareAccessType::SelfOnly->value && ($userAuthorization === Null || $shareEntity->getCreatedUid() != $userAuthorization->getId())) { ExceptionBuilder::throw(ShareErrorCode::PERMISSION_DENIED, 'share.permission_denied', [$shareCode]); } // Judgepasswordwhethercorrect if (! empty($shareEntity->getPassword()) && ($detailDTO->getPassword() != PasswordCrypt::decrypt($shareEntity->getPassword()))) { ExceptionBuilder::throw(ShareErrorCode::PASSWORD_ERROR, 'share.password_error', [$shareCode]); } // callFactoryClass, get divide  shareContentData try { $resourceType = ResourceType::tryFrom($shareEntity->getResourceType()); $factory = $this->resourceFactory->create($resourceType); } catch (RuntimeException $e) { // Use ExceptionBuilder Throw not SupportResourceTypeAbnormal ExceptionBuilder::throw(ShareErrorCode::RESOURCE_TYPE_NOT_SUPPORTED, 'share.resource_type_not_supported', [$resourceType->name]); } // ReturnData return [ 'resource_type' => $resourceType, 'resource_name' => $shareEntity->getResourceName(), 'temporary_token' => AccessTokenUtil::generate((string) $shareEntity->getId(), $shareEntity->getOrganizationCode()), 'data' => $factory->getResourceContent( $shareEntity->getResourceId(), $shareEntity->getCreatedUid(), $shareEntity->getOrganizationCode(), $detailDTO->getPage(), $detailDTO->getPageSize() ), ]; } public function getShareList(MagicUserAuthorization $userAuthorization, ResourceListRequestDTO $dto): array { $conditions = ['created_uid' => $userAuthorization->getId()]; if (! empty($dto->getKeyword())) { $conditions['keyword'] = $dto->getKeyword(); } $result = $this->shareDomainService->getShareList($dto->getPage(), $dto->getPageSize(), $conditions); if (empty($result)) { return [ 'total' => 0, 'list' => [], ]; } // Extensioninformation try { $resourceType = ResourceType::from($dto->getResourceType()); $factory = $this->resourceFactory->create($resourceType); } catch (RuntimeException $e) { // Use ExceptionBuilder Throw not SupportResourceTypeAbnormal ExceptionBuilder::throw(ShareErrorCode::RESOURCE_TYPE_NOT_SUPPORTED, 'share.resource_type_not_supported', [$resourceType->name]); } $result['list'] = $factory->getResourceExtendList($result['list']); return $result; } /** * through sharecodegetshare information (Not containpassword). * * @param Null|MagicUserAuthorization $userAuthorization Currentuser (Can beNull) * @param string $shareCode sharecode * @return ShareItemDTO shareProjectDTO * @throws Exception getshare informationAbnormal*/ public function getShareByCode(?MagicUserAuthorization $userAuthorization, string $shareCode): ShareItemDTO { // getAndValidateEntity $shareEntity = $this->getAndValidateShareEntity($userAuthorization, $shareCode); // UseassemblydeviceCreateBaseDTO (Not containpassword) return $this->shareAssembler->toDto($shareEntity); } /** * through sharecodegetshare information (containplaintextpassword). * attention: thismethodOnly shouldinspecificScenario next Use, needcautiousProcess/HandleReturnpasswordinformation. * * @param Null|MagicUserAuthorization $userAuthorization Currentuser (Can beNull) * @param string $shareCode sharecode * @return ShareItemWithPasswordDTO containingpasswordshareProjectDTO * @throws Exception getshare informationAbnormal*/ public function getShareWithPasswordByCode(?MagicUserAuthorization $userAuthorization, string $shareCode): ShareItemWithPasswordDTO { // getAndValidateEntity try { $shareEntity = $this->getAndValidateShareEntity($userAuthorization, $shareCode); // if ($shareEntity->getCreatedUid() !== $userAuthorization->getId()) { // ExceptionBuilder::throw(ShareErrorCode::PERMISSION_DENIED, 'share.permission_denied', [$shareCode]); // } // UseassemblydeviceCreatecontainingpasswordDTO return $this->shareAssembler->toDtoWithPassword($shareEntity); } catch (BusinessException $e) { return new ShareItemWithPasswordDTO(); } } /** * By/According toshare codegetshareEntity. * * @param string $shareCode share code * @return Null|ResourceShareEntity shareEntity, IfDoes not existin then ReturnNull*/ public function getShare(string $shareCode): ?ResourceShareEntity { return $this->shareDomainService->getShareByCode($shareCode); } /** * getAndValidateshareEntity. * * @param Null|MagicUserAuthorization $userAuthorization Currentuser (Can beNull) * @param string $shareCode sharecode * @return ResourceShareEntity Validatethrough shareEntity * @throws Exception IfValidateFailed*/ private function getAndValidateShareEntity(?MagicUserAuthorization $userAuthorization, string $shareCode): ResourceShareEntity { // throughDomainServicegetshareEntity $shareEntity = $this->shareDomainService->getShareByCode($shareCode); // Validatesharewhether store in if (empty($shareEntity)) { ExceptionBuilder::throw(ShareErrorCode::RESOURCE_NOT_FOUND, 'share.not_found', [$shareCode]); } // ChecksumPermission, IfshareType is onlyselfVisible,  then NeedValidateuseridentity if ($shareEntity->getShareType() == ShareAccessType::SelfOnly->value && ($userAuthorization === Null || $shareEntity->getCreatedUid() != $userAuthorization->getId())) { ExceptionBuilder::throw(ShareErrorCode::PERMISSION_DENIED, 'share.permission_denied', [$shareCode]); } return $shareEntity; } } 