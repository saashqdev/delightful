<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Domain\SuperAgent\Service; use Delightful\BeDelightful\Domain\SuperAgent\Entity\ProjectMemberEntity; use Delightful\BeDelightful\Domain\SuperAgent\Entity\ProjectMemberSettingEntity; use Delightful\BeDelightful\Domain\SuperAgent\Entity\ValueObject\MemberJoinMethod; use Delightful\BeDelightful\Domain\SuperAgent\Entity\ValueObject\MemberRole; use Delightful\BeDelightful\Domain\SuperAgent\Entity\ValueObject\MemberType; use Delightful\BeDelightful\Domain\SuperAgent\Repository\Facade\ProjectMemberRepositoryInterface; use Delightful\BeDelightful\Domain\SuperAgent\Repository\Facade\ProjectMemberSettingRepositoryInterface; use Hyperf\DbConnection\Db; /** * ProjectMemberDomainService * * Process/HandleProjectMemberRelatedAllbusiness logic, includePermissionValidateã€Membermanagementwait*/ class ProjectMemberDomainService { public function __construct( private readonly ProjectMemberRepositoryInterface $projectMemberRepository, private readonly ProjectMemberSettingRepositoryInterface $projectMemberSettingRepository, ) { } /** * UpdateProjectMember - Main businessmethod. * * @param ProjectMemberEntity[] $memberEntities MemberEntityArray*/ public function updateProjectMembers( string $organizationCode, int $projectId, array $memberEntities ): void { // 1. For eachMemberEntitysetProject IDAndOrganization code foreach ($memberEntities as $memberEntity) { $memberEntity->setProjectId($projectId); $memberEntity->setOrganizationCode($organizationCode); } // 2. ExecuteUpdateOperation Db::transaction(function () use ($projectId, $memberEntities) { //  first DeleteAllExistingMember $this->projectMemberRepository->deleteByProjectId($projectId, [MemberRole::MANAGE->value, MemberRole::EDITOR->value, MemberRole::VIEWER->value]); // againBatchInsert new Member if (! empty($memberEntities)) { $this->projectMemberRepository->insert($memberEntities); } }); } /** * CheckuserwhetherForProjectuserlevelMember.*/ public function isProjectMemberByUser(int $projectId, string $userId): bool { return $this->projectMemberRepository->existsByProjectAndUser($projectId, $userId); } /** * CheckuserwhetherForProjectDepartmentlevelMember.*/ public function isProjectMemberByDepartments(int $projectId, array $departmentIds): bool { return $this->projectMemberRepository->existsByProjectAndDepartments($projectId, $departmentIds); } /** * By/According toProject IDgetProjectMemberlist. * * @return ProjectMemberEntity[] Array of project member entities*/ public function getProjectMembers(int $projectId, array $roles = []): array { return $this->projectMemberRepository->findByProjectId($projectId, $roles); } /** * By/According touserAndDepartmentgetProject IDlist.*/ public function deleteByProjectId(int $projectId): bool { return (bool) $this->projectMemberRepository->deleteByProjectId($projectId); } /** * Get project ID list and total by user and department. * * @return array ['total' => int, 'list' => array]*/ public function getProjectIdsByUserAndDepartmentsWithTotal( string $userId, array $departmentIds = [], ?string $name = Null, ?string $sortField = Null, string $sortDirection = 'desc', array $creatorUserIds = [], ?string $joinMethod = Null, array $organizationCodes = [] ): array { return $this->projectMemberRepository->getProjectIdsByUserAndDepartments( $userId, $departmentIds, $name, $sortField, $sortDirection, $creatorUserIds, $joinMethod, $organizationCodes ); } /** * Batch get project member counts. * * @return array [project_id => total_count]*/ public function getProjectMembersCounts(array $projectIds): array { return $this->projectMemberRepository->getProjectMembersCounts($projectIds); } /** * Batch get preview of first N members. * * @return ProjectMemberEntity[][]*/ public function getProjectMembersPreview(array $projectIds, int $limit = 4): array { return $this->projectMemberRepository->getProjectMembersPreview($projectIds, $limit); } /** * Get project ID list and total created by user with members. * * @return array ['total' => int, 'list' => array]*/ public function getSharedProjectIdsByUserWithTotal( string $userId, string $organizationCode, ?string $name = Null, int $page = 1, int $pageSize = 10, ?string $sortField = Null, string $sortDirection = 'desc', array $creatorUserIds = [] ): array { return $this->projectMemberRepository->getSharedProjectIdsByUser( $userId, $organizationCode, $name, $page, $pageSize, $sortField, $sortDirection, $creatorUserIds ); } /** * UpdateProjectPinStatus.*/ public function updateProjectPinStatus(string $userId, int $projectId, string $organizationCode, bool $isPinned): bool { // 1. CheckDatawhether store in, IfDoes not existin first CreatedefaultData $setting = $this->projectMemberSettingRepository->findByUserAndProject($userId, $projectId); if ($setting === Null) { $this->projectMemberSettingRepository->create($userId, $projectId, $organizationCode); } // 2. UpdatePinStatus return $this->projectMemberSettingRepository->updatePinStatus($userId, $projectId, $isPinned); } /** * getuserPinProject IDlist. * * @return array PinProject IDArray*/ public function getUserPinnedProjectIds(string $userId, string $organizationCode): array { return $this->projectMemberSettingRepository->getPinnedProjectIds($userId, $organizationCode); } /** * BatchgetuserinMultipleProjectset. * * @return array [project_id => ProjectMemberSettingEntity,...]*/ public function getUserProjectSettings(string $userId, array $projectIds): array { return $this->projectMemberSettingRepository->findByUserAndProjects($userId, $projectIds); } /** * UpdateuserinProjectLast active inTime.*/ public function updateUserLastActiveTime(string $userId, int $projectId, string $organizationCode): bool { // 1. CheckDatawhether store in, IfDoes not existin first CreatedefaultData $setting = $this->projectMemberSettingRepository->findByUserAndProject($userId, $projectId); if ($setting === Null) { $this->projectMemberSettingRepository->create($userId, $projectId, $organizationCode); } return $this->projectMemberSettingRepository->updateLastActiveTime($userId, $projectId); } /** * DeleteProject time CleanRelatedMemberset.*/ public function cleanupProjectSettings(int $projectId): bool { $this->projectMemberSettingRepository->deleteByProjectId($projectId); return true; } /** * Get collaboration project creator user ID list. * * @param string $userId Current user ID * @param array $departmentIds Array of department IDs user belongs to * @param string $organizationCode Organization code * @return array Array of creator user IDs*/ public function getCollaborationProjectCreatorIds( string $userId, array $departmentIds, string $organizationCode ): array { return $this->projectMemberRepository->getCollaborationProjectCreatorIds( $userId, $departmentIds, $organizationCode ); } /** * setProjectShortcut. * * @param string $userId User ID * @param int $projectId Project ID * @param int $workspaceId Workspace ID * @param string $organizationCode Organization code * @return bool setSuccessReturntrue*/ public function setProjectShortcut(string $userId, int $projectId, int $workspaceId, string $organizationCode): bool { return $this->projectMemberSettingRepository->setProjectShortcut($userId, $projectId, $workspaceId, $organizationCode); } /** * CancelProjectShortcut. * * @param string $userId User ID * @param int $projectId Project ID * @return bool CancelSuccessReturntrue*/ public function cancelProjectShortcut(string $userId, int $projectId): bool { return $this->projectMemberSettingRepository->cancelProjectShortcut($userId, $projectId); } /** * CheckProjectwhether already setShortcut. * * @param string $userId User ID * @param int $projectId Project ID * @param int $workspaceId Workspace ID * @return bool  already setReturntrue*/ public function hasProjectShortcut(string $userId, int $projectId, int $workspaceId): bool { return $this->projectMemberSettingRepository->hasProjectShortcut($userId, $projectId, $workspaceId); } /** * Get user participated project list (SupportCollaborationProjectFilter). * * @param string $userId User ID * @param int $workspaceId Workspace ID (0Tableshow not LimitWorkspace) * @param bool $showCollaboration Whether to display collaboration projects * @param Null|string $projectName Project name fuzzy search * @param int $page Page number * @param int $pageSize Page size * @param string $sortField Sort field * @param string $sortDirection Sort direction * @param Null|array $organizationCodes Organization code * @return array ['total' => int, 'list' => array]*/ public function getParticipatedProjectsWithCollaboration( string $userId, int $workspaceId, bool $showCollaboration = true, ?string $projectName = Null, int $page = 1, int $pageSize = 10, ?array $organizationCodes = Null, string $sortField = 'last_active_at', string $sortDirection = 'desc', ): array { // JudgewhetherLimitWorkspace $limitWorkspace = $workspaceId > 0; return $this->projectMemberRepository->getParticipatedProjects( $userId, $limitWorkspace ? $workspaceId : Null, $showCollaboration, $projectName, $page, $pageSize, $sortField, $sortDirection, $organizationCodes ); } /** * InitializeProjectMemberAndset. * * @param string $userId User ID * @param int $projectId Project ID * @param int $workspaceId Workspace ID * @param string $organizationCode Organization code*/ public function initializeProjectMemberAndSettings( string $userId, int $projectId, int $workspaceId, string $organizationCode ): void { // CreateProjectMemberRecord (setForAll person Role) $memberEntity = new ProjectMemberEntity(); $memberEntity->setProjectId($projectId); $memberEntity->setTargetTypeFromString('User'); $memberEntity->setTargetId($userId); $memberEntity->setRole(MemberRole::OWNER); $memberEntity->setOrganizationCode($organizationCode); $memberEntity->setInvitedBy($userId); // BatchInsertMemberRecord $this->projectMemberRepository->insert([$memberEntity]); // CreateProjectMembersetRecord (BindTo workspace) $this->projectMemberSettingRepository->setProjectShortcut($userId, $projectId, $workspaceId, $organizationCode); } /** * throughInvitation linkaddProjectMember. * * @param string $projectId Project ID * @param string $userId User ID * @param MemberRole $role MemberRole * @param string $organizationCode Organization code * @param string $invitedBy Invite user ID * @return ProjectMemberEntity CreateMemberEntity*/ public function addMemberByInvitation( string $projectId, string $userId, MemberRole $role, string $organizationCode, string $invitedBy ): ProjectMemberEntity { // Checkwhether already through is Member $isExistingMember = $this->getMemberByProjectAndUser((int) $projectId, $userId); if ($isExistingMember) { return $isExistingMember; } // Create new ProjectMemberRecord $memberEntity = new ProjectMemberEntity(); $memberEntity->setProjectId((int) $projectId); $memberEntity->setTargetTypeFromString(MemberType::USER->value); $memberEntity->setTargetId($userId); $memberEntity->setRole($role); $memberEntity->setOrganizationCode($organizationCode); $memberEntity->setInvitedBy($invitedBy); $memberEntity->setJoinMethod(MemberJoinMethod::LINK); // InsertMemberRecord $this->projectMemberRepository->insert([$memberEntity]); return $memberEntity; } /** * DeletespecifieduserProjectMemberRelationship. * * @param int $projectId Project ID * @param string $userId User ID * @return bool DeletewhetherSuccess*/ public function removeMemberByUser(int $projectId, string $userId): bool { $deletedCount = $this->projectMemberRepository->deleteByProjectAndUser($projectId, $userId); return $deletedCount > 0; } /** * DeletespecifieduserAndTarget typeProjectMemberRelationship. * * @param int $projectId Project ID * @param string $targetType Target type (User/Department) * @param string $targetId Target ID * @return bool DeletewhetherSuccess*/ public function removeMemberByTarget(int $projectId, string $targetType, string $targetId): bool { $deletedCount = $this->projectMemberRepository->deleteByProjectAndTarget($projectId, $targetType, $targetId); return $deletedCount > 0; } /** * By/According toProject IDAndUser IDgetProjectMemberinformation. * * @param int $projectId Project ID * @param string $userId User ID * @return Null|ProjectMemberEntity ProjectMemberEntity*/ public function getMemberByProjectAndUser(int $projectId, string $userId): ?ProjectMemberEntity { return $this->projectMemberRepository->getMemberByProjectAndUser($projectId, $userId); } /** * By/According toProject IDAndArray of department IDsgetProjectMemberlist. * * @param int $projectId Project ID * @param array $departmentIds Array of department IDs * @return ProjectMemberEntity[] Array of project member entities*/ public function getMembersByProjectAndDepartmentIds(int $projectId, array $departmentIds): array { return $this->projectMemberRepository->getMembersByProjectAndDepartmentIds($projectId, $departmentIds); } /** * By/According toProject IDAndArray of member IDsgetMemberlist. * * @param int $projectId Project ID * @param array $memberIds Array of member IDs * @return ProjectMemberEntity[] Array of project member entities*/ public function getMembersByIds(int $projectId, array $memberIds): array { return $this->projectMemberRepository->getMembersByIds((int) $projectId, $memberIds); } /** * BatchUpdateMemberPermission ( new format: target_type + target_id). * * @param int $projectId Project ID * @param array $roleUpdates [['target_type' => '', 'target_id' => '', 'role' => ''],...] * @return int UpdateRecord count */ public function batchUpdateRole(int $projectId, array $roleUpdates): int { $updateData = []; foreach ($roleUpdates as $member) { $memberRole = MemberRole::validatePermissionLevel($member['role']); $updateData[] = [ 'target_type' => $member['target_type'], 'target_id' => $member['target_id'], 'role' => $memberRole->value, ]; } return $this->projectMemberRepository->batchUpdateRole($projectId, $updateData); } /** * BatchDeleteMember. * * @param int $projectId Project ID * @param array $memberIds Array of member IDs * @return int Number of deleted records*/ public function deleteMembersByIds(int $projectId, array $memberIds): int { return $this->projectMemberRepository->deleteMembersByIds($projectId, $memberIds); } /** * addProjectMember (InternalInvite). * * @param ProjectMemberEntity[] $memberEntities MemberEntityArray * @param string $organizationCode Organization code*/ public function addInternalMembers(array $memberEntities, string $organizationCode): void { if (empty($memberEntities)) { return; } // For eachMemberEntitysetOrganization code foreach ($memberEntities as $memberEntity) { $memberEntity->setJoinMethod(MemberJoinMethod::INTERNAL); $memberEntity->setOrganizationCode($organizationCode); } // BatchInsertMember $this->projectMemberRepository->insert($memberEntities); } public function getProjectIdsByCollaboratorTargets(array $targetIds): array { $roles = [MemberRole::MANAGE->value, MemberRole::EDITOR->value, MemberRole::VIEWER->value]; return $this->projectMemberRepository->getProjectIdsByCollaboratorTargets($targetIds, $roles); } /** * BatchgetuserinProjectHighest inPermissionRole. * * @param array $projectIds Project IDArray * @param array $targetIds Target IDArray (User IDAndDepartmentID) * @return array [project => role] Project IDMapping to Role*/ public function getUserHighestRolesInProjects(array $projectIds, array $targetIds): array { // 1. fromRepositorygetMemberEntityData $memberEntities = $this->projectMemberRepository->getProjectMembersByTargetIds($projectIds, $targetIds); if (empty($memberEntities)) { return []; } // 2. business logic:  by ProjectGroup, calculateeveryProject most highPermissionRole $projectRoles = []; foreach ($memberEntities as $entity) { $projectId = $entity->getProjectId(); $role = $entity->getRole(); $permissionLevel = $role->getPermissionLevel(); // IfthisProjectstillNo/NoneRecord,  or CurrentRolePermission more high,  then Update if (! isset($projectRoles[$projectId]) || $permissionLevel > $projectRoles[$projectId]['level']) { $projectRoles[$projectId] = [ 'role' => $role->value, 'level' => $permissionLevel, ]; } } // 3.  only ReturnRoleValue,  not containingPermissionLevel return array_map(fn ($data) => $data['role'], $projectRoles); } } 