<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Application\BeAgent\Event\Subscribe; use App\Infrastructure\Core\Exception\BusinessException; use App\Infrastructure\Util\IdGenerator\IdGenerator; use App\Infrastructure\Util\Locker\LockerInterface; use Delightful\BeDelightful\Application\BeAgent\Service\HandleAgentMessageAppService; use Hyperf\Amqp\Annotation\Consumer; use Hyperf\Amqp\Message\ConsumerMessage; use Hyperf\Amqp\Result; use Hyperf\Contract\StdoutLoggerInterface; use PhpAmqpLib\Message\AMQPMessage; use Throwable; /** * TopicMessageProcess/Handlesubscribe person  (Based onData database Queue). * consumeLightweightTopicMessageProcessEvent, fromData database in orderProcess/HandleMessage.*/ #[Consumer( exchange: 'be_delightful_topic_message_process', routingKey: 'be_delightful_topic_message_process', queue: 'be_delightful_topic_message_process', nums: 1 )] class TopicMessageProcessSubscriber extends ConsumerMessage { /** * @var Null|array QoS configuration, Used forControl prefetchQuantitywait*/ protected ?array $qos = [ 'prefetch_count' => 1, // every times  only Prefetch1conditionMessage 'prefetch_size' => 0, 'global' => false, ]; /** * ConstructFunction.*/ public function __construct( private readonly HandleAgentMessageAppService $handleAgentMessageAppService, protected LockerInterface $locker, private readonly StdoutLoggerInterface $logger, ) { } /** * consumeMessage. * * @param mixed $data MessageData * @param AMQPMessage $message OriginalMessageObject * @return Result Process/HandleResult*/ public function consumeMessage($data, AMQPMessage $message): Result { try { // RecordReceived lightweightEvent $this->logger->debug(sprintf( 'ReceivedTopicMessageProcess/HandleEvent: %s', json_encode($data, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) )); // ValidateEventformat $this->validateEventFormat($data); // gettopic_id $topicId = (int) ($data['topic_id'] ?? 0); $taskId = (int) ($data['task_id'] ?? 0); if ($topicId <= 0) { $this->logger->warning('Invalidtopic_id，SkipProcess/Handle', [ 'topic_id' => $topicId, 'event_data' => $data, ]); return Result::ACK; } // trygetTopicGrade lock  $lockKey = 'handle_topic_message_lock:' . $topicId; $lockOwner = IdGenerator::getUniqueId32(); $lockExpireSeconds = 50; //  give BatchProcess/Handle more multipleTime $lockAcquired = $this->acquireLock($lockKey, $lockOwner, $lockExpireSeconds); if (! $lockAcquired) { $this->logger->info(sprintf( 'Unable toGettopic %d lock ，May haveOtherInstancecorrectinProcess/HandleThisTopicMessage，directlyACK', $topicId )); return Result::ACK; // directlyACK， not Retry } $this->logger->info(sprintf( 'AlreadyGettopic %d lock ，Holder: %s，StartBatchProcess/HandleMessage', $topicId, $lockOwner )); try { // callBatchProcess/Handlemethod $processedCount = $this->handleAgentMessageAppService->batchHandleAgentMessage($topicId, 0); $this->logger->info(sprintf( 'topic %d BatchProcess/HandleComplete，Process/HandleMessageQuantity: %d', $topicId, $processedCount )); return Result::ACK; } finally { if ($this->releaseLock($lockKey, $lockOwner)) { $this->logger->info(sprintf( 'Alreadyreleasetopic %d lock ，Holder: %s', $topicId, $lockOwner )); } else { $this->logger->error(sprintf( 'releasetopic %d lock Failed，Holder: %s，May/PossibleNeedManual intervention', $topicId, $lockOwner )); } } } catch (BusinessException $e) { $this->logger->error(sprintf( 'Process/HandleTopicMessageEventFailed，BusinessAbnormal: %s, EventContent: %s', $e->getMessage(), json_encode($data, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) )); return Result::ACK; } catch (Throwable $e) { $this->logger->error(sprintf( 'Process/HandleTopicMessageEventFailed，SystemAbnormal: %s, EventContent: %s', $e->getMessage(), json_encode($data, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) )); return Result::ACK; } } /** * getDistribute style  lock .*/ public function acquireLock(string $lockKey, string $lockOwner, int $lockExpireSeconds): bool { return $this->locker->spinLock($lockKey, $lockOwner, $lockExpireSeconds); } /** * releaseDistribute style  lock .*/ private function releaseLock(string $lockKey, string $lockOwner): bool { return $this->locker->release($lockKey, $lockOwner); } /** * ValidateEventformat. * * @param mixed $data EventData * @throws BusinessException IfEventformatIncorrectThen throwAbnormal*/ private function validateEventFormat($data): void { if (! is_array($data)) { throw new BusinessException('EventDataFormatError：Must is Array'); } if (! isset($data['topic_id']) || ! is_numeric($data['topic_id'])) { throw new BusinessException('EventDataFormatError：missingValidtopic_idField'); } } } 