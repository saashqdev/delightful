<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Domain\Share\Service; use App\Infrastructure\Core\Exception\ExceptionBuilder; use BeDelightful\BeDelightful\Domain\Share\Entity\ResourceShareEntity; use BeDelightful\BeDelightful\Domain\Share\Repository\Facade\ResourceShareRepositoryInterface; use BeDelightful\BeDelightful\ErrorCode\ShareErrorCode; use BeDelightful\BeDelightful\Infrastructure\Utils\PasswordCrypt; use BeDelightful\BeDelightful\Infrastructure\Utils\ShareCodeGenerator; use Exception; /** * ResourceshareDomainService.*/ class ResourceShareDomainService { public function __construct( protected ResourceShareRepositoryInterface $shareRepository ) { } public function saveShareByEntity(ResourceShareEntity $shareEntity): ResourceShareEntity { try { return $this->shareRepository->save($shareEntity); } catch (Exception $e) { //  re ThrowAbnormal ExceptionBuilder::throw(ShareErrorCode::OPERATION_FAILED, 'share.cancel_failed: ' . $shareEntity->getId()); } } /** * Cancelshare (LogicDelete). * * @param int $shareId share ID * @param string $userId User ID * @param string $organizationCode Organization code * @return bool whetherCancelSuccess * @throws Exception IfCancelshareFailed*/ public function cancelShare(int $shareId, string $userId, string $organizationCode): bool { // 1. getshareEntity $shareEntity = $this->shareRepository->getShareById($shareId); // 2. Validatesharewhether store in if (! $shareEntity) { ExceptionBuilder::throw(ShareErrorCode::NOT_FOUND, 'share.not_found', [$shareId]); } // 3. Validatewhether have PermissionCancelshare (OnlyshareCreator or AdministratorCanCancel) if ($shareEntity->getCreatedUid() !== $userId) { // HereCanaddextraPermissionCheck, For exampleCheckuserwhether is Administrator ExceptionBuilder::throw(ShareErrorCode::PERMISSION_DENIED, 'share.no_permission_to_cancel', [$shareId]); } // 4. ValidateOrganizationwhetherMatch if ($shareEntity->getOrganizationCode() !== $organizationCode) { ExceptionBuilder::throw(ShareErrorCode::PERMISSION_DENIED, 'share.organization_mismatch', [$shareId]); } // 5. setDeleted atAndUpdateinformation $shareEntity->setDeletedAt(date('Y-m-d H:i:s')); $shareEntity->setUpdatedAt(date('Y-m-d H:i:s')); $shareEntity->setUpdatedUid($userId); // 6. SaveEntity try { $this->shareRepository->save($shareEntity); return true; } catch (Exception $e) { //  re ThrowAbnormal ExceptionBuilder::throw(ShareErrorCode::OPERATION_FAILED, 'share.cancel_failed', [$shareId]); } } /** * getshareDetails. * * @param string $resourceId ResourceID * @return Null|ResourceShareEntity shareEntity*/ public function getShareByResourceId(string $resourceId): ?ResourceShareEntity { return $this->shareRepository->getShareByResourceId($resourceId); } public function getShareByCode(string $code): ?ResourceShareEntity { return $this->shareRepository->getShareByCode($code); } /** * getValidshare * Validshare is point un DeleteAnd notExpireshare. * * @param string $shareId share ID * @return Null|ResourceShareEntity shareEntity*/ public function getValidShareById(string $shareId): ?ResourceShareEntity { $share = $this->shareRepository->getShareById((int) $shareId); if (! $share || ! $share->isValid()) { return Null; } return $share; } /** * through sharecodegetValidshare. * * @param string $shareCode sharecode * @return Null|ResourceShareEntity shareEntity*/ public function getValidShareByCode(string $shareCode): ?ResourceShareEntity { $share = $this->shareRepository->getShareByCode($shareCode); if (! $share || ! $share->isValid()) { return Null; } return $share; } /** * Addshareview count. * * @param string $shareId share ID * @return bool whetherSuccess*/ public function incrementViewCount(string $shareId): bool { $share = $this->shareRepository->getShareById((int) $shareId); if (! $share) { return false; } $share->incrementViewCount(); $this->shareRepository->save($share); return true; } public function getShareList(int $page, int $pageSize, array $conditions = [], string $select = '*'): array { // defineNeedReturnfieldlist $allowedFields = [ 'id', 'resource_id', 'resource_name', 'resource_type', 'created_at', 'created_uid', 'share_type', ]; $result = $this->shareRepository->paginate($conditions, $page, $pageSize); // Filterfield $filteredList = []; foreach ($result['list'] as $item) { $filteredItem = []; // ConvertEntityconvertForArray $itemArray = $item instanceof ResourceShareEntity ? $item->toArray() : (array) $item; //  only ReserveAllowfield foreach ($allowedFields as $field) { if (isset($itemArray[$field])) { $filteredItem[$field] = $itemArray[$field]; } } $filteredList[] = $filteredItem; } return ['total' => $result['total'], 'list' => $filteredList]; } /** * Saveshare (Create orUpdate). * * @param string $resourceId ResourceID * @param int $resourceType ResourceType * @param string $userId User ID * @param string $organizationCode Organization code * @param array $attributes extraProperty/Attribute * @param Null|string $password password (Optional) * @param Null|int $expireDays Expired at (Optional) * @return ResourceShareEntity Save after shareEntity * @throws Exception IfOperation failed*/ public function saveShare( string $resourceId, int $resourceType, string $userId, string $organizationCode, array $attributes = [], ?string $password = Null, ?int $expireDays = Null ): ResourceShareEntity { // 1. FindwhetherAlready existsinshare $shareEntity = $this->findExistingShare($resourceId, $resourceType, ''); // 2. IfDoes not existin, Create new shareEntity if (! $shareEntity) { // Generatesharecode - Preferentially use passed-inshare_code, Use resource_id Instead sharecode $shareCode = $attributes['share_code'] ?? $resourceId; // BuildBasicshareData $shareData = [ 'resource_id' => $resourceId, 'resource_type' => $resourceType, 'resource_name' => $attributes['resource_name'], 'share_code' => $shareCode, 'share_type' => $attributes['share_type'] ?? 0, 'created_uid' => $userId, 'organization_code' => $organizationCode, ]; // Create new Entity $shareEntity = new ResourceShareEntity($shareData); // setCreated at $shareEntity->setCreatedAt(date('Y-m-d H:i:s')); } // 3. UpdateEntityProperty/Attribute (Regardless is Create newstill is Already existsin) // UpdateshareType (IfProvide) if (isset($attributes['share_type'])) { $shareEntity->setShareType($attributes['share_type']); } // UpdateextraProperty/Attribute (IfProvide) if (isset($attributes['extra'])) { $shareEntity->setExtra($attributes['extra']); } // setpassword (IfProvide) if (! empty($password)) { // UseReversibleEncryptreplacesingletoHash $shareEntity->setPassword(PasswordCrypt::encrypt($password)); } else { $shareEntity->setPassword(''); } $shareEntity->setIsPasswordEnabled((bool) $shareEntity->getPassword()); // setExpired at (IfProvide) if ($expireDays > 0) { // EnsureExpired at is Stringformat $expireAt = date('Y-m-d H:i:s', strtotime("+{$expireDays} days")); $shareEntity->setExpireAt($expireAt); } // setUpdateinformation $shareEntity->setUpdatedAt(date('Y-m-d H:i:s')); $shareEntity->setUpdatedUid($userId); $shareEntity->setDeletedAt(Null); // 4. SaveEntity try { return $this->shareRepository->save($shareEntity); } catch (Exception $e) { //  re ThrowAbnormal ExceptionBuilder::throw( ShareErrorCode::OPERATION_FAILED, 'share.save_failed', [$shareEntity->getId() ?: '(new)'] ); } } /** * Generatesharecode. * * @return string Generatesharecode (12bitRandomCharacter)*/ public function generateShareCode(): string { return (new ShareCodeGenerator()) ->setCodeLength(12) // SetFor12bit ->generate(); } /** * By/According toID re Generatesharecode. * * @param int $shareId share ID * @throws Exception IfOperation failed*/ public function regenerateShareCodeById(int $shareId): ResourceShareEntity { // 1. getshareEntity $shareEntity = $this->shareRepository->getShareById($shareId); if (! $shareEntity) { ExceptionBuilder::throw(ShareErrorCode::NOT_FOUND); } // 3.  re Generatesharecode $newShareCode = $this->generateShareCode(); $shareEntity->setShareCode($newShareCode); $shareEntity->setUpdatedAt(date('Y-m-d H:i:s')); // 4. SaveUpdate try { $this->shareRepository->save($shareEntity); return $shareEntity; } catch (Exception $e) { ExceptionBuilder::throw(ShareErrorCode::OPERATION_FAILED); } } /** * Modifypassword. * * @param int $shareId share ID * @throws Exception IfOperation failed*/ public function changePasswordById(int $shareId, string $password): ResourceShareEntity { // 1. getshareEntity $shareEntity = $this->shareRepository->getShareById($shareId); if (! $shareEntity) { ExceptionBuilder::throw(ShareErrorCode::NOT_FOUND); } // 3. setpassword if (! empty($password)) { // UseReversibleEncryptreplacesingletoHash $shareEntity->setPassword(PasswordCrypt::encrypt($password)); } else { $shareEntity->setPassword(''); } $shareEntity->setIsPasswordEnabled((bool) $shareEntity->getPassword()); $shareEntity->setUpdatedAt(date('Y-m-d H:i:s')); // 4. SaveUpdate try { $this->shareRepository->save($shareEntity); return $shareEntity; } catch (Exception $e) { ExceptionBuilder::throw(ShareErrorCode::OPERATION_FAILED); } } /** * getDecrypt after sharepassword * * @param ResourceShareEntity $shareEntity shareEntity * @return string Decrypt after password*/ public function getDecryptedPassword(ResourceShareEntity $shareEntity): string { $encryptedPassword = $shareEntity->getPassword(); if (empty($encryptedPassword)) { return ''; } return PasswordCrypt::decrypt($encryptedPassword); } /** * Validatesharepasswordwhethercorrect. * * @param ResourceShareEntity $shareEntity shareEntity * @param string $password wantValidatepassword * @return bool passwordwhethercorrect*/ public function verifyPassword(ResourceShareEntity $shareEntity, string $password): bool { if (empty($shareEntity->getPassword())) { return true; // nopasswordshare，directlyReturnValidatethrough } $decryptedPassword = $this->getDecryptedPassword($shareEntity); return $decryptedPassword === $password; } /** * SwitchshareStatus (Enable/Disable). * * @param int $shareId share ID * @param bool $enabled whetherEnable * @param string $userId OperationUser ID * @return ResourceShareEntity Update after shareEntity * @throws Exception IfOperation failed*/ public function toggleShareStatus(int $shareId, bool $enabled, string $userId): ResourceShareEntity { // 1. getshareEntity $shareEntity = $this->shareRepository->getShareById($shareId); if (! $shareEntity) { ExceptionBuilder::throw(ShareErrorCode::NOT_FOUND, 'share.not_found', [$shareId]); } // 2. PermissionCheck (OnlyCreatorCanOperation) if ($shareEntity->getCreatedUid() !== $userId) { ExceptionBuilder::throw(ShareErrorCode::PERMISSION_DENIED, 'share.no_permission', [$shareId]); } // 3. UpdateEnableStatus $shareEntity->setIsEnabled($enabled); $shareEntity->setUpdatedAt(date('Y-m-d H:i:s')); $shareEntity->setUpdatedUid($userId); // 4. SaveAndReturn try { return $this->shareRepository->save($shareEntity); } catch (Exception $e) { ExceptionBuilder::throw(ShareErrorCode::OPERATION_FAILED, 'share.toggle_status_failed', [$shareId]); } } /** * getspecifiedResourceshare. * * @param string $resourceId ResourceID * @param int $resourceType ResourceType * @return Null|ResourceShareEntity shareEntity*/ public function getShareByResource(string $resourceId, int $resourceType): ?ResourceShareEntity { return $this->shareRepository->getShareByResource('', $resourceId, $resourceType, false); } /** * DeletespecifiedResourceshare. * * @param string $resourceId ResourceID * @param int $resourceType ResourceType * @param string $userId User ID (Optional, Used forPermissionCheck) * @param bool $forceDelete whetherForceDelete (PhysicalDelete), defaultfalseFor softDelete * @return bool DeletewhetherSuccess*/ public function deleteShareByResource(string $resourceId, int $resourceType, string $userId = '', bool $forceDelete = false): bool { $shareEntity = $this->shareRepository->getShareByResource($userId, $resourceId, $resourceType); if (! $shareEntity) { return true; // IfDoes not existin，viewForDeleted successfully } return $this->shareRepository->delete($shareEntity->getId(), $forceDelete); } /** * Deletespecifiedsharecodeshare. * * @param string $shareCode sharecode * @return bool DeletewhetherSuccess*/ public function deleteShareByCode(string $shareCode): bool { $shareEntity = $this->shareRepository->getShareByCode($shareCode); if (! $shareEntity) { return true; // IfDoes not existin，viewForDeleted successfully } return $this->shareRepository->delete($shareEntity->getId()); } /** * BatchDeletespecifiedResourceTypeshare. * * @param string $resourceId ResourceID * @param int $resourceType ResourceType * @return bool DeletewhetherSuccess*/ public function deleteAllSharesByResource(string $resourceId, int $resourceType): bool { try { // HereCanExtensionForBatchDelete, targetbefore first usesingleDelete $shareEntity = $this->shareRepository->getShareByResource('', $resourceId, $resourceType); if (! $shareEntity) { return true; } return $this->shareRepository->delete($shareEntity->getId()); } catch (Exception $e) { ExceptionBuilder::throw(ShareErrorCode::OPERATION_FAILED, 'share.delete_failed: ' . $resourceId); } } /** * FindAlready existsinshare. * * @param string $resourceId ResourceID * @param int $resourceType ResourceType * @param string $userId User ID * @return Null|ResourceShareEntity If store in then ReturnshareEntity, OtherwiseReturnNull*/ protected function findExistingShare(string $resourceId, int $resourceType, string $userId = ''): ?ResourceShareEntity { return $this->shareRepository->getShareByResource($userId, $resourceId, $resourceType); } } 