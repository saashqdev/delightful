<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperDelightful\Interfaces\Agent\Facade\Admin; use App\Application\Flow\Service\DelightfulFlowAppService; use App\Domain\Flow\Entity\DelightfulFlowToolSetEntity; use App\Infrastructure\Util\ShadowCode\ShadowCode; use Delightful\ApiResponse\Annotation\ApiResponse; use Delightful\SuperDelightful\Application\Agent\Service\SuperDelightfulAgentAiOptimizeAppService; use Delightful\SuperDelightful\Application\Agent\Service\SuperDelightfulAgentAppService; use Delightful\SuperDelightful\Domain\Agent\Entity\ValueObject\Query\SuperDelightfulAgentQuery; use Delightful\SuperDelightful\Domain\Agent\Entity\ValueObject\SuperDelightfulAgentOptimizationType; use Delightful\SuperDelightful\Interfaces\Agent\Assembler\BuiltinToolAssembler; use Delightful\SuperDelightful\Interfaces\Agent\Assembler\SuperDelightfulAgentAssembler; use Delightful\SuperDelightful\Interfaces\Agent\DTO\BuiltinToolDTO; use Delightful\SuperDelightful\Interfaces\Agent\DTO\SuperDelightfulAgentDTO; use Delightful\SuperDelightful\Interfaces\Agent\FormRequest\SuperDelightfulAgentAiOptimizeFormRequest; use Delightful\SuperDelightful\Interfaces\Agent\FormRequest\SuperDelightfulAgentOrderFormRequest; use Delightful\SuperDelightful\Interfaces\Agent\FormRequest\SuperDelightfulAgentQueryFormRequest; use Delightful\SuperDelightful\Interfaces\Agent\FormRequest\SuperDelightfulAgentSaveFormRequest; use Hyperf\Di\Annotation\Inject; #[ApiResponse(version: 'low_code')] class SuperDelightfulAgentAdminApi extends AbstractSuperDelightfulAdminApi { #[Inject] protected SuperDelightfulAgentAppService $superDelightfulAgentAppService; #[Inject] protected SuperDelightfulAgentAiOptimizeAppService $superDelightfulAgentAiOptimizeAppService; #[Inject] protected DelightfulFlowAppService $magicFlowAppService; public function save(SuperDelightfulAgentSaveFormRequest $request) { $authorization = $this->getAuthorization(); $requestData = $request->validated(); $DTO = new SuperDelightfulAgentDTO($requestData); $promptShadow = $request->input('prompt_shadow'); if ($promptShadow) { $promptShadow = json_decode(ShadowCode::unShadow($promptShadow), true); $DTO->setPrompt($promptShadow); } $DO = SuperDelightfulAgentAssembler::createDO($DTO); $entity = $this->superDelightfulAgentAppService->save($authorization, $DO); $users = $this->superDelightfulAgentAppService->getUsers($entity->getOrganizationCode(), [$entity->getCreator(), $entity->getModifier()]); return SuperDelightfulAgentAssembler::createDTO($entity, $users); } public function queries(SuperDelightfulAgentQueryFormRequest $request) { $authorization = $this->getAuthorization(); $requestData = $request->validated(); $query = new SuperDelightfulAgentQuery($requestData); $page = $this->createPage(); $result = $this->superDelightfulAgentAppService->queries($authorization, $query, $page); return SuperDelightfulAgentAssembler::createCategorizedListDTO( frequent: $result['frequent'], all: $result['all'], total: $result['total'] ); } public function show(string $code) { $authorization = $this->getAuthorization(); $withToolSchema = (bool) $this->request->input('with_tool_schema', false); $entity = $this->superDelightfulAgentAppService->show($authorization, $code, $withToolSchema); $withPromptString = (bool) $this->request->input('with_prompt_string', false); $users = $this->superDelightfulAgentAppService->getUsers($entity->getOrganizationCode(), [$entity->getCreator(), $entity->getModifier()]); return SuperDelightfulAgentAssembler::createDTO($entity, $users, $withPromptString); } public function destroy(string $code) { $authorization = $this->getAuthorization(); $result = $this->superDelightfulAgentAppService->delete($authorization, $code); return ['success' => $result]; } public function enable(string $code) { $authorization = $this->getAuthorization(); $entity = $this->superDelightfulAgentAppService->enable($authorization, $code); $users = $this->superDelightfulAgentAppService->getUsers($entity->getOrganizationCode(), [$entity->getCreator(), $entity->getModifier()]); return SuperDelightfulAgentAssembler::createDTO($entity, $users); } public function disable(string $code) { $authorization = $this->getAuthorization(); $entity = $this->superDelightfulAgentAppService->disable($authorization, $code); $users = $this->superDelightfulAgentAppService->getUsers($entity->getOrganizationCode(), [$entity->getCreator(), $entity->getModifier()]); return SuperDelightfulAgentAssembler::createDTO($entity, $users); } /** * SaveAgentlineColumnSequential.*/ public function saveOrder(SuperDelightfulAgentOrderFormRequest $request) { $authorization = $this->getAuthorization(); $requestData = $request->validated(); $orderConfig = [ 'frequent' => $requestData['frequent'] ?? [], 'all' => $requestData['all'], ]; $this->superDelightfulAgentAppService->saveOrderConfig($authorization, $orderConfig); return ['message' => 'Agent order saved successfully']; } /** * getBuilt-inToollist.*/ public function tools() { return BuiltinToolAssembler::createToolCategoryListDTO(); } /** * AIOptimizeAgent.*/ public function aiOptimize(SuperDelightfulAgentAiOptimizeFormRequest $request) { $authorization = $this->getAuthorization(); $requestData = $request->validated(); // CreateOptimizeTypeEnumInstance (FormRequest ValidateEnsureValidproperty) $optimizationType = SuperDelightfulAgentOptimizationType::fromString($requestData['optimization_type']); // Use SuperDelightfulAgentAssembler Create entity $DTO = new SuperDelightfulAgentDTO($requestData['agent']); $promptShadow = $request->input('agent.prompt_shadow'); if ($promptShadow) { $promptShadow = json_decode(ShadowCode::unShadow($promptShadow), true); $DTO->setPrompt($promptShadow); } $agentEntity = SuperDelightfulAgentAssembler::createDO($DTO); // OnlyinOptimizeContent time onlyQueryToolinformation $availableTools = []; if ($optimizationType === SuperDelightfulAgentOptimizationType::OptimizeContent) { // CurrentuserAvailableToollist $builtinTools = BuiltinToolAssembler::createToolListDTO(); $customToolSets = $this->magicFlowAppService->queryToolSets($authorization, false, false)['list'] ?? []; // MergeBuilt-inToolAndCustomToolFor unifiedformat $availableTools = $this->mergeAvailableTools($builtinTools, $customToolSets); } // callOptimizeService $optimizedEntity = $this->superDelightfulAgentAiOptimizeAppService->optimizeAgent( $authorization, $optimizationType, $agentEntity, $availableTools ); return [ 'optimization_type' => $optimizationType->value, 'agent' => SuperDelightfulAgentAssembler::createDTO($optimizedEntity), ]; } /** * MergeBuilt-inToolAndCustomToolFor unifiedformat. * @param array<BuiltinToolDTO> $builtinTools * @param array<DelightfulFlowToolSetEntity> $customToolSets*/ private function mergeAvailableTools(array $builtinTools, array $customToolSets): array { $tools = []; // Process/HandleBuilt-inTool foreach ($builtinTools as $tool) { $tools[$tool->getCode()] = [ 'code' => $tool->getCode(), 'name' => $tool->getName(), 'description' => $tool->getDescription(), 'required' => $tool->isRequired(), 'type' => 'builtin', ]; } // Process/HandleCustomTool foreach ($customToolSets as $customToolSet) { foreach ($customToolSet->getTools() as $tool) { $tools[$tool['code']] = [ 'code' => $tool['code'], 'name' => $tool['name'], 'description' => $tool['description'], 'required' => false, 'type' => 'custom', ]; } } return $tools; } } 