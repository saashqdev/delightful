<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Interfaces\BeAgent\Facade; use App\Domain\Contact\Entity\ValueObject\DataIsolation; use App\Infrastructure\Util\Context\RequestContext; use BeDelightful\ApiResponse\Annotation\ApiResponse; use BeDelightful\BeDelightful\Application\BeAgent\Service\ProjectMemberAppService; use BeDelightful\BeDelightful\Interfaces\BeAgent\DTO\Request\BatchUpdateMembersRequestDTO; use BeDelightful\BeDelightful\Interfaces\BeAgent\DTO\Request\CreateMembersRequestDTO; use BeDelightful\BeDelightful\Interfaces\BeAgent\DTO\Request\GetCollaborationProjectListRequestDTO; use BeDelightful\BeDelightful\Interfaces\BeAgent\DTO\Request\UpdateProjectMembersRequestDTO; use BeDelightful\BeDelightful\Interfaces\BeAgent\DTO\Request\UpdateProjectPinRequestDTO; use BeDelightful\BeDelightful\Interfaces\BeAgent\DTO\Request\UpdateProjectShortcutRequestDTO; use Hyperf\HttpServer\Contract\RequestInterface; /** * Project Member API. */ #[ApiResponse('low_code')] class ProjectMemberApi extends AbstractApi { public function __construct( protected RequestInterface $request, private readonly ProjectMemberAppService $projectMemberAppService, ) { parent::__construct($request); } /** * getCollaborationProjectlist.*/ public function getCollaborationProjects(RequestContext $requestContext): array { $requestContext->setUserAuthorization($this->getAuthorization()); $requestDTO = GetCollaborationProjectListRequestDTO::fromRequest($this->request); return $this->projectMemberAppService->getCollaborationProjects($requestContext, $requestDTO); } /** * UpdateProjectMember.*/ public function updateMembers(RequestContext $requestContext, int $projectId): array { // Set user authorization and context data $userAuthorization = $this->getAuthorization(); $requestContext->setUserAuthorization($userAuthorization); $requestContext->setUserId($userAuthorization->getId()); $requestContext->setOrganizationCode($userAuthorization->getOrganizationCode()); // 1. Convert toRequestDTOAndAutoValidate (containingroutingParameterproject_id) $requestDTO = UpdateProjectMembersRequestDTO::fromRequest($this->request); $requestDTO->setProjectId((string) $projectId); // 2. delegate give ApplicationLayer processing $this->projectMemberAppService->updateProjectMembers($requestContext, $requestDTO); return []; } /** * getProjectMember.*/ public function getMembers(RequestContext $requestContext, int $projectId): array { // Set user authorization and context data $userAuthorization = $this->getAuthorization(); $requestContext->setUserAuthorization($userAuthorization); $requestContext->setUserId($userAuthorization->getId()); $requestContext->setOrganizationCode($userAuthorization->getOrganizationCode()); // Create and set DataIsolation $dataIsolation = DataIsolation::create( $userAuthorization->getOrganizationCode(), $userAuthorization->getId() ); $requestContext->setDataIsolation($dataIsolation); // delegate give ApplicationLayer processing $responseDTO = $this->projectMemberAppService->getProjectMembers($requestContext, $projectId); // ReturnDTOConvert after Arrayformat return ['members' => $responseDTO->toArray()]; } /** * UpdateProjectPinStatus.*/ public function updateProjectPin(RequestContext $requestContext, string $project_id): array { // Set user authorization and context data $userAuthorization = $this->getAuthorization(); $requestContext->setUserAuthorization($userAuthorization); $requestContext->setUserId($userAuthorization->getId()); $requestContext->setOrganizationCode($userAuthorization->getOrganizationCode()); // 1. Convert toRequestDTOAndAutoValidate $requestDTO = UpdateProjectPinRequestDTO::fromRequest($this->request); // 2. delegate give ApplicationLayer processing $this->projectMemberAppService->updateProjectPin($requestContext, (int) $project_id, $requestDTO); return []; } /** * getCollaborationProjectCreatorlist.*/ public function getCollaborationProjectCreators(RequestContext $requestContext): array { // Set user authorization and context data $userAuthorization = $this->getAuthorization(); $requestContext->setUserAuthorization($userAuthorization); $requestContext->setUserId($userAuthorization->getId()); $requestContext->setOrganizationCode($userAuthorization->getOrganizationCode()); // Create and set DataIsolation $dataIsolation = DataIsolation::create( $userAuthorization->getOrganizationCode(), $userAuthorization->getId() ); $requestContext->setDataIsolation($dataIsolation); // delegate give ApplicationLayer processing $responseDTO = $this->projectMemberAppService->getCollaborationProjectCreators($requestContext); // ReturnDTOConvert after Arrayformat return $responseDTO->toArray(); } /** * Update project shortcut. */ public function updateProjectShortcut(RequestContext $requestContext, string $project_id): array { // Set user authorization and context data $userAuthorization = $this->getAuthorization(); $requestContext->setUserAuthorization($userAuthorization); $requestContext->setUserId($userAuthorization->getId()); $requestContext->setOrganizationCode($userAuthorization->getOrganizationCode()); // 1. Convert toRequestDTOAndAutoValidate $requestDTO = UpdateProjectShortcutRequestDTO::fromRequest($this->request); // 2. delegate give ApplicationLayer processing $this->projectMemberAppService->updateProjectShortcut($requestContext, (int) $project_id, $requestDTO); return []; } /** * addProjectMember (Only supportsOrganizationInternalMember).*/ public function createProjectMembers(RequestContext $requestContext, int $projectId): array { $requestContext->setUserAuthorization($this->getAuthorization()); $requestDTO = CreateMembersRequestDTO::fromRequest($this->request); $memberInfos = $this->projectMemberAppService->createMembers($requestContext, $projectId, $requestDTO); return ['members' => $memberInfos]; } /** * BatchUpdateMemberPermission.*/ public function updateProjectMemberRoles(RequestContext $requestContext, int $projectId): array { $requestContext->setUserAuthorization($this->getAuthorization()); $requestDTO = BatchUpdateMembersRequestDTO::fromRequest($this->request); return $this->projectMemberAppService->updateProjectMemberRoles($requestContext, $projectId, $requestDTO); } /** * BatchDeleteMember.*/ public function deleteProjectMembers(RequestContext $requestContext, int $projectId): array { $requestContext->setUserAuthorization($this->getAuthorization()); $members = (array) $this->request->input('members', []); $this->projectMemberAppService->deleteMembers($requestContext, $projectId, $members); return []; } } 