<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperMagic\Application\SuperAgent\Service; use App\Application\Kernel\AbstractKernelAppService; use App\Domain\Contact\Entity\ValueObject\DataIsolation; use App\Domain\Contact\Service\MagicDepartmentUserDomainService; use App\Domain\Provider\Service\ModelFilter\PackageFilterInterface; use App\Infrastructure\Core\Exception\ExceptionBuilder; use App\Infrastructure\Core\Traits\DataIsolationTrait; use App\Interfaces\Authorization\Web\MagicUserAuthorization; use Delightful\SuperMagic\Domain\SuperAgent\Entity\ProjectEntity; use Delightful\SuperMagic\Domain\SuperAgent\Entity\ValueObject\MemberRole; use Delightful\SuperMagic\Domain\SuperAgent\Service\ProjectDomainService; use Delightful\SuperMagic\Domain\SuperAgent\Service\ProjectMemberDomainService; use Delightful\SuperMagic\ErrorCode\SuperAgentErrorCode; class AbstractAppService extends AbstractKernelAppService { use DataIsolationTrait; /** * getusercanaccessedProjectEntity (defaultGreater than readableRole). * * @return ProjectEntity ProjectEntity*/ public function getAccessibleProject(int $projectId, string $userId, string $organizationCode, MemberRole $requiredRole = MemberRole::VIEWER): ProjectEntity { $projectDomainService = di(ProjectDomainService::class); $packageFilterService = di(PackageFilterInterface::class); $projectEntity = $projectDomainService->getProjectNotUserId($projectId); /*if ($projectEntity->getUserOrganizationCode() !== $organizationCode) { $logger->error('Project access denied', [ 'projectId' => $projectId, 'userId' => $userId, 'organizationCode' => $organizationCode, 'projectUserOrganizationCode' => $projectEntity->getUserOrganizationCode(), ]); ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); }*/ // If is Creator, directlyReturn if ($projectEntity->getUserId() === $userId) { return $projectEntity; } // JudgewhetherEnableShareProject if (! $projectEntity->getIsCollaborationEnabled()) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } // Validateidentity $magicUserAuthorization = new MagicUserAuthorization(); $magicUserAuthorization->setOrganizationCode($organizationCode); $magicUserAuthorization->setId($userId); $this->validateRoleHigherOrEqual($magicUserAuthorization, $projectId, $requiredRole); // JudgewhetherPaid plan if (! $packageFilterService->isPaidSubscription($projectEntity->getUserOrganizationCode())) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } return $projectEntity; } /** * getusercanaccessedProjectEntity (Greater thanEditRole).*/ public function getAccessibleProjectWithEditor(int $projectId, string $userId, string $organizationCode): ProjectEntity { return $this->getAccessibleProject($projectId, $userId, $organizationCode, MemberRole::EDITOR); } /** * getusercanaccessedProjectEntity (Greater thanmanagementRole).*/ public function getAccessibleProjectWithManager(int $projectId, string $userId, string $organizationCode): ProjectEntity { return $this->getAccessibleProject($projectId, $userId, $organizationCode, MemberRole::MANAGE); } /** * Validatemanagement person  or All person Permission.*/ protected function validateManageOrOwnerPermission(MagicUserAuthorization $magicUserAuthorization, int $projectId): void { $projectDomainService = di(ProjectDomainService::class); $projectEntity = $projectDomainService->getProjectNotUserId($projectId); // JudgewhetherEnableShareProject if (! $projectEntity->getIsCollaborationEnabled()) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } $this->validateRoleHigherOrEqual($magicUserAuthorization, $projectId, MemberRole::MANAGE); } /** * ValidatecanEdit person Permission.*/ protected function validateEditorPermission(MagicUserAuthorization $magicUserAuthorization, int $projectId): void { $projectDomainService = di(ProjectDomainService::class); $projectEntity = $projectDomainService->getProjectNotUserId($projectId); // JudgewhetherEnableShareProject if (! $projectEntity->getIsCollaborationEnabled()) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } $this->validateRoleHigherOrEqual($magicUserAuthorization, $projectId, MemberRole::EDITOR); } /** * ValidateReadablePermission.*/ protected function validateViewerPermission(MagicUserAuthorization $magicUserAuthorization, int $projectId): void { $projectDomainService = di(ProjectDomainService::class); $projectEntity = $projectDomainService->getProjectNotUserId($projectId); // JudgewhetherEnableShareProject if (! $projectEntity->getIsCollaborationEnabled()) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } $this->validateRoleHigherOrEqual($magicUserAuthorization, $projectId, MemberRole::VIEWER); } /** * ValidateCurrentuserRolewhetherGreater thanOr equalspecifiedRole.*/ protected function validateRoleHigherOrEqual(MagicUserAuthorization $magicUserAuthorization, int $projectId, MemberRole $requiredRole): void { $projectMemberService = di(ProjectMemberDomainService::class); $magicDepartmentUserDomainService = di(MagicDepartmentUserDomainService::class); $userId = $magicUserAuthorization->getId(); $projectMemberEntity = $projectMemberService->getMemberByProjectAndUser($projectId, $userId); if ($projectMemberEntity && $projectMemberEntity->getRole()->isHigherOrEqualThan($requiredRole)) { return; } $dataIsolation = DataIsolation::create($magicUserAuthorization->getOrganizationCode(), $userId); $departmentIds = $magicDepartmentUserDomainService->getDepartmentIdsByUserId($dataIsolation, $userId, true); $projectMemberEntities = $projectMemberService->getMembersByProjectAndDepartmentIds($projectId, $departmentIds); foreach ($projectMemberEntities as $projectMemberEntity) { if ($projectMemberEntity->getRole()->isHigherOrEqualThan($requiredRole)) { return; } } ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } } 