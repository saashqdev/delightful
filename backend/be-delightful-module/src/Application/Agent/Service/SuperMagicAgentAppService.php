<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperDelightful\Application\Agent\Service; use App\Application\Contact\UserSetting\UserSettingKey; use App\Application\Flow\ExecuteManager\NodeRunner\LLM\ToolsExecutor; use App\Application\Flow\Service\DelightfulFlowExecuteAppService; use App\Domain\Contact\Entity\DelightfulUserSettingEntity; use App\Domain\Contact\Service\DelightfulUserSettingDomainService; use App\Domain\Mode\Entity\ModeEntity; use App\Domain\Mode\Entity\ValueQuery\ModeQuery; use App\Domain\Mode\Service\ModeDomainService; use App\Infrastructure\Core\Exception\ExceptionBuilder; use App\Infrastructure\Core\ValueObject\Page; use App\Interfaces\Flow\DTO\DelightfulFlowApiChatDTO; use DateTime; use Delightful\SuperDelightful\Domain\Agent\Entity\SuperDelightfulAgentEntity; use Delightful\SuperDelightful\Domain\Agent\Entity\ValueObject\Query\SuperDelightfulAgentQuery; use Delightful\SuperDelightful\Domain\Agent\Entity\ValueObject\SuperDelightfulAgentDataIsolation; use Delightful\SuperDelightful\Domain\Agent\Entity\ValueObject\SuperDelightfulAgentType; use Delightful\SuperDelightful\ErrorCode\SuperDelightfulErrorCode; use Hyperf\Di\Annotation\Inject; use Qbhy\HyperfAuth\Authenticatable; class SuperDelightfulAgentAppService extends AbstractSuperDelightfulAppService { #[Inject] protected DelightfulUserSettingDomainService $magicUserSettingDomainService; #[Inject] protected ModeDomainService $modeDomainService; public function show(Authenticatable $authorization, string $code, bool $withToolSchema = false): SuperDelightfulAgentEntity { $dataIsolation = $this->createSuperDelightfulDataIsolation($authorization); $flowDataIsolation = $this->createFlowDataIsolation($authorization); $agent = $this->superDelightfulAgentDomainService->getByCodeWithException($dataIsolation, $code); if ($withToolSchema) { $remoteToolCodes = []; foreach ($agent->getTools() as $tool) { if ($tool->getType()->isRemote()) { $remoteToolCodes[] = $tool->getCode(); } } // getTooldefine $remoteTools = ToolsExecutor::getToolFlows($flowDataIsolation, $remoteToolCodes, true); foreach ($agent->getTools() as $tool) { $remoteTool = $remoteTools[$tool->getCode()] ?? Null; if ($remoteTool) { $tool->setSchema($remoteTool->getInput()->getForm()?->getForm()->toJsonSchema()); } } } return $agent; } /** * @return array{frequent: array<SuperDelightfulAgentEntity>, all: array<SuperDelightfulAgentEntity>, total: int} */ public function queries(Authenticatable $authorization, SuperDelightfulAgentQuery $query, Page $page): array { $dataIsolation = $this->createSuperDelightfulDataIsolation($authorization); // targetbeforeCan onlyQueryself, FullQuery $query->setCreatorId($authorization->getId()); $page->disable(); $query->setSelect(['id', 'code', 'name', 'description', 'icon', 'icon_type']); // Only select necessary fields for list $result = $this->superDelightfulAgentDomainService->queries($dataIsolation, $query, $page); // MergeBuilt-inModel $builtinAgents = $this->getBuiltinAgent($dataIsolation); if (! $page->isEnabled()) { $result['list'] = array_merge($builtinAgents, $result['list']); $result['total'] += count($builtinAgents); } // By/According touserlineColumnconfigurationPairResult enter RowCategory $orderConfig = $this->getOrderConfig($authorization); return $this->categorizeAgents($result['list'], $result['total'], $orderConfig); } public function save(Authenticatable $authorization, SuperDelightfulAgentEntity $entity): SuperDelightfulAgentEntity { $dataIsolation = $this->createSuperDelightfulDataIsolation($authorization); return $this->superDelightfulAgentDomainService->save($dataIsolation, $entity); } public function delete(Authenticatable $authorization, string $code): bool { $dataIsolation = $this->createSuperDelightfulDataIsolation($authorization); return $this->superDelightfulAgentDomainService->delete($dataIsolation, $code); } public function enable(Authenticatable $authorization, string $code): SuperDelightfulAgentEntity { $dataIsolation = $this->createSuperDelightfulDataIsolation($authorization); return $this->superDelightfulAgentDomainService->enable($dataIsolation, $code); } public function disable(Authenticatable $authorization, string $code): SuperDelightfulAgentEntity { $dataIsolation = $this->createSuperDelightfulDataIsolation($authorization); return $this->superDelightfulAgentDomainService->disable($dataIsolation, $code); } /** * SaveAgentlineColumnconfiguration. * @param array{frequent: array<string>, all: array<string>} $orderConfig*/ public function saveOrderConfig(Authenticatable $authorization, array $orderConfig): DelightfulUserSettingEntity { $dataIsolation = $this->createContactDataIsolation($authorization); $entity = new DelightfulUserSettingEntity(); $entity->setKey(UserSettingKey::SuperDelightfulAgentSort->value); $entity->setValue($orderConfig); return $this->magicUserSettingDomainService->save($dataIsolation, $entity); } /** * getAgentlineColumnconfiguration. * @return Null|array{frequent: array<string>, all: array<string>}*/ public function getOrderConfig(Authenticatable $authorization): ?array { $dataIsolation = $this->createContactDataIsolation($authorization); $setting = $this->magicUserSettingDomainService->get($dataIsolation, UserSettingKey::SuperDelightfulAgentSort->value); return $setting?->getValue(); } public function executeTool(Authenticatable $authorization, array $params): array { $toolCode = $params['code'] ?? ''; $arguments = $params['arguments'] ?? []; if (empty($toolCode)) { ExceptionBuilder::throw(SuperDelightfulErrorCode::ValidateFailed, 'common.empty', ['label' => 'code']); } $flowDataIsolation = $this->createFlowDataIsolation($authorization); $toolFlow = ToolsExecutor::getToolFlows($flowDataIsolation, [$toolCode])[0] ?? Null; if (! $toolFlow || ! $toolFlow->isEnabled()) { $label = $toolFlow ? $toolFlow->getName() : $toolCode; ExceptionBuilder::throw(SuperDelightfulErrorCode::ValidateFailed, 'common.disabled', ['label' => $label]); } $apiChatDTO = new DelightfulFlowApiChatDTO(); $apiChatDTO->setParams($arguments); $apiChatDTO->setFlowCode($toolFlow->getCode()); $apiChatDTO->setFlowVersionCode($toolFlow->getVersionCode()); $apiChatDTO->setMessage('super_magic_tool_call'); return di(DelightfulFlowExecuteAppService::class)->apiParamCallByRemoteTool( $flowDataIsolation, $apiChatDTO, 'super_magic_tool_call' ); } /** * ConvertAgentlistAccording touserconfigurationCategoryForfrequentAndall.*/ private function categorizeAgents(array $agents, int $total, ?array $orderConfig): array { // IfNo/Noneuserconfiguration, Usedefaultconfiguration: Built-inAgentbefore6Asfrequent if (empty($orderConfig)) { $orderConfig = $this->getDefaultOrderConfig($agents); } $frequentCodes = $orderConfig['frequent'] ?? []; $allOrder = $orderConfig['all'] ?? []; // Createcode to entityMapping $agentMap = []; foreach ($agents as $agent) { $agentMap[$agent->getCode()] = $agent; } // Buildfrequentlist $frequent = []; foreach ($frequentCodes as $code) { if (isset($agentMap[$code])) { $agentMap[$code]->setCategory('frequent'); $frequent[] = $agentMap[$code]; } } // Buildalllist (Excludefrequent in ) $all = []; $frequentCodesSet = array_flip($frequentCodes); // If have Sortconfiguration,  by configurationSort if (! empty($allOrder)) { foreach ($allOrder as $code) { if (isset($agentMap[$code]) && ! isset($frequentCodesSet[$code])) { $agentMap[$code]->setCategory('all'); $all[] = $agentMap[$code]; } } // add not inSortconfiguration in Agent foreach ($agents as $agent) { $code = $agent->getCode(); if (! in_array($code, $allOrder) && ! isset($frequentCodesSet[$code])) { $agent->setCategory('all'); $all[] = $agent; } } } else { // No/NoneSortconfiguration, directlyFilterfrequent foreach ($agents as $agent) { if (! isset($frequentCodesSet[$agent->getCode()])) { $agent->setCategory('all'); $all[] = $agent; } } } return [ 'frequent' => $frequent, 'all' => $all, 'total' => $total, ]; } /** * getdefaultSortconfiguration: Built-inAgentbefore6 each Asfrequent. * @param array<SuperDelightfulAgentEntity> $agents*/ private function getDefaultOrderConfig(array $agents): array { $builtinCodes = []; $customCodes = []; foreach ($agents as $agent) { if ($agent->getType()->isBuiltIn()) { $builtinCodes[] = $agent->getCode(); } else { $customCodes[] = $agent->getCode(); } } // Built-inAgentbefore6Asfrequent $frequent = array_slice($builtinCodes, 0, 6); // allcontainingAllAgent (Built-in+Custom) $all = array_merge($builtinCodes, $customCodes); return [ 'frequent' => $frequent, 'all' => $all, ]; } /** * @return array<SuperDelightfulAgentEntity> */ private function getBuiltinAgent(SuperDelightfulAgentDataIsolation $superDelightfulAgentDataIsolation): array { $modeDataIsolation = $this->createModeDataIsolation($superDelightfulAgentDataIsolation); $modeDataIsolation->setOnlyOfficialOrganization(true); $query = new ModeQuery(excludeDefault: true, status: true); $modesResult = $this->modeDomainService->getModes($modeDataIsolation, $query, Page::createNoPage()); $list = []; foreach ($modesResult['list'] as $mode) { $list[] = $this->createBuiltinAgentEntityByMode($superDelightfulAgentDataIsolation, $mode); } return $list; } private function createBuiltinAgentEntityByMode(SuperDelightfulAgentDataIsolation $superDelightfulAgentDataIsolation, ModeEntity $modeEntity): SuperDelightfulAgentEntity { $entity = new SuperDelightfulAgentEntity(); // setBasicinformation $entity->setOrganizationCode($superDelightfulAgentDataIsolation->getCurrentOrganizationCode()); $entity->setCode($modeEntity->getIdentifier()); $entity->setName($modeEntity->getName()); $entity->setDescription($modeEntity->getPlaceholder()); $entity->setIcon([ 'url' => $modeEntity->getIconUrl(), 'type' => $modeEntity->getIcon(), 'color' => $modeEntity->getColor(), ]); $entity->setIconType($modeEntity->getIconType()); $entity->setType(SuperDelightfulAgentType::Built_In); $entity->setEnabled(true); $entity->setPrompt([]); $entity->setTools([]); // setSystemCreateinformation $entity->setCreator('system'); $entity->setCreatedAt(new DateTime()); $entity->setModifier('system'); $entity->setUpdatedAt(new DateTime()); return $entity; } } 