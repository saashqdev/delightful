<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Interfaces\Authorization\Web; use App\Domain\Contact\Service\DelightfulAccountDomainService; use App\Domain\Contact\Service\DelightfulUserDomainService; use App\ErrorCode\ChatErrorCode; use App\ErrorCode\UserErrorCode; use App\Infrastructure\Core\Exception\ExceptionBuilder; use App\Interfaces\Authorization\Web\DelightfulUserAuthorization; use Qbhy\HyperfAuth\Authenticatable; class SandboxAuthorization extends DelightfulUserAuthorization { public static function retrieveById($key): ?Authenticatable { $token = $key['token'] ?? ''; $userId = $key['userId'] ?? ''; if (empty($token) || empty($userId)) { ExceptionBuilder::throw(UserErrorCode::USER_NOT_EXIST); } // todo HereWill change to laterDynamic token $sandboxToken = config('super-delightful.sandbox.token', ''); if (empty($sandboxToken) || $sandboxToken !== $token) { ExceptionBuilder::throw(UserErrorCode::TOKEN_NOT_FOUND, 'token error'); } $userDomainService = di(DelightfulUserDomainService::class); $accountDomainService = di(DelightfulAccountDomainService::class); $userEntity = $userDomainService->getUserById($userId); if ($userEntity === Null) { ExceptionBuilder::throw(ChatErrorCode::LOGIN_FAILED); } $delightfulAccountEntity = $accountDomainService->getAccountInfoByDelightfulId($userEntity->getDelightfulId()); if ($delightfulAccountEntity === Null) { ExceptionBuilder::throw(ChatErrorCode::LOGIN_FAILED); } $delightfulUserInfo = new self(); $delightfulUserInfo->setId($userEntity->getUserId()); $delightfulUserInfo->setNickname($userEntity->getNickname()); $delightfulUserInfo->setAvatar($userEntity->getAvatarUrl()); $delightfulUserInfo->setStatus((string) $userEntity->getStatus()->value); $delightfulUserInfo->setOrganizationCode($userEntity->getOrganizationCode()); $delightfulUserInfo->setDelightfulId($userEntity->getDelightfulId()); $delightfulUserInfo->setMobile($delightfulAccountEntity->getPhone()); $delightfulUserInfo->setCountryCode($delightfulAccountEntity->getCountryCode()); $delightfulUserInfo->setRealName($delightfulAccountEntity->getRealName()); $delightfulUserInfo->setUserType($userEntity->getUserType()); return $delightfulUserInfo; } } 