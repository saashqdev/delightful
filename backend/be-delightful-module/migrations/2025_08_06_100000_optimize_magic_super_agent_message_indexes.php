<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ use Hyperf\Database\Migrations\Migration; use Hyperf\Database\Schema\Blueprint; use Hyperf\Database\Schema\Schema; use Hyperf\DbConnection\Db; return new class extends Migration { /** * Run the migrations. */ public function up(): void { Schema::table('delightful_super_agent_message', function (Blueprint $table) { // ============ ScenarioOptimizeindex ============ // Scenario1: topic_id + task_id + seq_id (Descending) // forIn ordercolumnIDDescendingQueryspecifictopicandtask'sMessage // set seq_id asdecreasesequenceindex, Optimize ORDER BY seq_id DESC Query if (! Schema::hasIndex('delightful_super_agent_message', 'idx_topic_task_seq_desc')) { Db::statement('CREATE INDEX idx_topic_task_seq_desc ON delightful_super_agent_message (topic_id, task_id, seq_id DESC)'); } // Scenario2: topic_id + task_id + sender_type + processing_status // forQueryspecifictopicandtaskunderspecifiedSenderTypeandProcess/HandleStatus'sMessage if (! Schema::hasIndex('delightful_super_agent_message', 'idx_topic_task_sender_status')) { $table->index(['topic_id', 'task_id', 'sender_type', 'processing_status'], 'idx_topic_task_sender_status'); } // Scenario3: topic_id + message_id // forinspecifictopicunderFindMessage, althoughmessage_id have Uniqueindex, But addontopic_idcanwithEnhanceQueryEfficiency if (! Schema::hasIndex('delightful_super_agent_message', 'idx_topic_message')) { $table->index(['topic_id', 'message_id'], 'idx_topic_message'); } // Scenario4: processing_status + created_at // for by Process/HandleStatusandCreatewhenintervalQuery, constantforqueuecolumnProcess/HandleandMonitor if (! Schema::hasIndex('delightful_super_agent_message', 'idx_status_created')) { $table->index(['processing_status', 'created_at'], 'idx_status_created'); } // MainQueryindex: topic_id + processing_status + sender_type + seq_id Ascending if (! Schema::hasIndex('delightful_super_agent_message', 'idx_topic_status_sender_seq')) { $table->index(['topic_id', 'processing_status', 'sender_type', 'seq_id'], 'idx_topic_status_sender_seq'); } // ============ Deletespecified'soldindex ============ // CheckAndDeleteDuplicateIDindex (Primary keyAlreadythroughcontaining) if (Schema::hasIndex('delightful_super_agent_message', 'idx_id')) { $table->dropIndex('idx_id'); } // CheckAndDeleteDuplicate'smessage_idindex (Will subsequentlyDeleteUniqueindex) if (Schema::hasIndex('delightful_super_agent_message', 'idx_message_id')) { $table->dropIndex('idx_message_id'); } // CheckAndDeletetask_typeindex if (Schema::hasIndex('delightful_super_agent_message', 'idx_task_type')) { $table->dropIndex('idx_task_type'); } // CheckAndDeletesender_createdindex if (Schema::hasIndex('delightful_super_agent_message', 'idx_sender_created')) { $table->dropIndex('idx_sender_created'); } // CheckAndDeletereceiver_createdindex if (Schema::hasIndex('delightful_super_agent_message', 'idx_receiver_created')) { $table->dropIndex('idx_receiver_created'); } // pleaseConfirmbusiness logicin have OtherMethod ensuremessage_id'sUniqueproperty if (Schema::hasIndex('delightful_super_agent_message', 'delightful_super_agent_message_message_id_unique')) { $table->dropUnique('delightful_super_agent_message_message_id_unique'); } // Reserve: idx_topic_show_deleted (topic_id, show_in_ui, deleted_at) }); } /** * Reverse the migrations. */ public function down(): void { Schema::table('delightful_super_agent_message', function (Blueprint $table) { // DeleteAdd new'sindex }); } }; 