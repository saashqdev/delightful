<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperDelightful\Interfaces\Authorization\Web; use App\Domain\Contact\Service\DelightfulAccountDomainService; use App\Domain\Contact\Service\DelightfulUserDomainService; use App\ErrorCode\ChatErrorCode; use App\ErrorCode\UserErrorCode; use App\Infrastructure\Core\Exception\ExceptionBuilder; use App\Interfaces\Authorization\Web\DelightfulUserAuthorization; use Qbhy\HyperfAuth\Authenticatable; class SandboxAuthorization extends DelightfulUserAuthorization { public static function retrieveById($key): ?Authenticatable { $token = $key['token'] ?? ''; $userId = $key['userId'] ?? ''; if (empty($token) || empty($userId)) { ExceptionBuilder::throw(UserErrorCode::USER_NOT_EXIST); } // todo HereWill change to laterDynamic token $sandboxToken = config('super-magic.sandbox.token', ''); if (empty($sandboxToken) || $sandboxToken !== $token) { ExceptionBuilder::throw(UserErrorCode::TOKEN_NOT_FOUND, 'token error'); } $userDomainService = di(DelightfulUserDomainService::class); $accountDomainService = di(DelightfulAccountDomainService::class); $userEntity = $userDomainService->getUserById($userId); if ($userEntity === Null) { ExceptionBuilder::throw(ChatErrorCode::LOGIN_FAILED); } $magicAccountEntity = $accountDomainService->getAccountInfoByDelightfulId($userEntity->getDelightfulId()); if ($magicAccountEntity === Null) { ExceptionBuilder::throw(ChatErrorCode::LOGIN_FAILED); } $magicUserInfo = new self(); $magicUserInfo->setId($userEntity->getUserId()); $magicUserInfo->setNickname($userEntity->getNickname()); $magicUserInfo->setAvatar($userEntity->getAvatarUrl()); $magicUserInfo->setStatus((string) $userEntity->getStatus()->value); $magicUserInfo->setOrganizationCode($userEntity->getOrganizationCode()); $magicUserInfo->setDelightfulId($userEntity->getDelightfulId()); $magicUserInfo->setMobile($magicAccountEntity->getPhone()); $magicUserInfo->setCountryCode($magicAccountEntity->getCountryCode()); $magicUserInfo->setRealName($magicAccountEntity->getRealName()); $magicUserInfo->setUserType($userEntity->getUserType()); return $magicUserInfo; } } 