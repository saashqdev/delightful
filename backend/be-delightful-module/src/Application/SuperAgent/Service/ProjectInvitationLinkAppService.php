<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperMagic\Application\SuperAgent\Service; use App\Domain\Contact\Service\MagicUserDomainService; use App\Domain\File\Service\FileDomainService; use App\Infrastructure\Core\Exception\ExceptionBuilder; use App\Infrastructure\Util\Context\RequestContext; use Carbon\Carbon; use Delightful\SuperMagic\Domain\Share\Constant\ResourceType; use Delightful\SuperMagic\Domain\Share\Constant\ShareAccessType; use Delightful\SuperMagic\Domain\Share\Entity\ResourceShareEntity; use Delightful\SuperMagic\Domain\Share\Service\ResourceShareDomainService; use Delightful\SuperMagic\Domain\SuperAgent\Entity\ValueObject\MemberRole; use Delightful\SuperMagic\Domain\SuperAgent\Service\ProjectMemberDomainService; use Delightful\SuperMagic\ErrorCode\SuperAgentErrorCode; use Delightful\SuperMagic\Infrastructure\Utils\PasswordCrypt; use Delightful\SuperMagic\Interfaces\SuperAgent\DTO\Response\InvitationDetailResponseDTO; use Delightful\SuperMagic\Interfaces\SuperAgent\DTO\Response\InvitationLinkResponseDTO; use Delightful\SuperMagic\Interfaces\SuperAgent\DTO\Response\JoinProjectResponseDTO; /** * ProjectInvitation linkApplicationService * * ResponsiblecoordinateProjectInvitation linkRelatedbusiness logic*/ class ProjectInvitationLinkAppService extends AbstractAppService { public function __construct( private ResourceShareDomainService $resourceShareDomainService, private ProjectMemberDomainService $projectMemberDomainService, private MagicUserDomainService $magicUserDomainService, private FileDomainService $fileDomainService ) { } /** * getProjectInvitation linkinformation.*/ public function getInvitationLink(RequestContext $requestContext, int $projectId): ?InvitationLinkResponseDTO { $organizationCode = $requestContext->getUserAuthorization()->getOrganizationCode(); $currentUserId = $requestContext->getUserAuthorization()->getId(); // 1. ValidateProjectPermission $this->getAccessibleProjectWithManager($projectId, $currentUserId, $organizationCode); $shareEntity = $this->resourceShareDomainService->getShareByResource( (string) $projectId, ResourceType::ProjectInvitation->value ); if (! $shareEntity) { return Null; } return InvitationLinkResponseDTO::fromEntity($shareEntity, $this->resourceShareDomainService); } /** * Enable/Close invitation link.*/ public function toggleInvitationLink(RequestContext $requestContext, int $projectId, bool $enabled): InvitationLinkResponseDTO { $currentUserId = $requestContext->getUserAuthorization()->getId(); $organizationCode = $requestContext->getUserAuthorization()->getOrganizationCode(); // 1. ValidatewhetherHaveProjectmanagementPermission $project = $this->getAccessibleProjectWithManager($projectId, $currentUserId, $organizationCode); if ($project->getUserId() !== $currentUserId) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED, 'project.invalid_permission_level'); } // 2. FindExistingInviteshare $existingShare = $this->resourceShareDomainService->getShareByResource( (string) $projectId, ResourceType::ProjectInvitation->value ); if ($existingShare) { // UpdateExistingshareEnable/DisableStatus $savedShare = $this->resourceShareDomainService->toggleShareStatus( $existingShare->getId(), $enabled, $currentUserId ); return InvitationLinkResponseDTO::fromEntity($savedShare, $this->resourceShareDomainService); } if (! $enabled) { // IfDoes not existinAnd require close, ThrowAbnormal ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_NOT_FOUND); } // 3. Create new Inviteshare (through ResourceShareDomainService) $shareEntity = $this->resourceShareDomainService->saveShare( (string) $projectId, ResourceType::ProjectInvitation->value, $currentUserId, $organizationCode, [ 'resource_name' => $project->getProjectName(), 'share_type' => ShareAccessType::Internet->value, 'extra' => [ 'default_join_permission' => MemberRole::VIEWER->value, ], ], ); return InvitationLinkResponseDTO::fromEntity($shareEntity, $this->resourceShareDomainService); } /** * ResetInvitation link.*/ public function resetInvitationLink(RequestContext $requestContext, int $projectId): InvitationLinkResponseDTO { $currentUserId = $requestContext->getUserAuthorization()->getId(); $organizationCode = $requestContext->getUserAuthorization()->getOrganizationCode(); // 1. ValidateProjectPermission $this->getAccessibleProjectWithManager($projectId, $currentUserId, $organizationCode); // 2. getExistingInviteshare $shareEntity = $this->resourceShareDomainService->getShareByResource( (string) $projectId, ResourceType::ProjectInvitation->value ); if (! $shareEntity) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_NOT_FOUND); } // 3. SaveUpdate $savedShare = $this->resourceShareDomainService->regenerateShareCodeById($shareEntity->getId()); return InvitationLinkResponseDTO::fromEntity($savedShare, $this->resourceShareDomainService); } /** * setpasswordProtect.*/ public function setPassword(RequestContext $requestContext, int $projectId, bool $enabled): string { $currentUserId = $requestContext->getUserAuthorization()->getId(); $organizationCode = $requestContext->getUserAuthorization()->getOrganizationCode(); // 1. ValidateProjectPermission $this->getAccessibleProjectWithManager($projectId, $currentUserId, $organizationCode); // 2. getExistingInviteshare $shareEntity = $this->resourceShareDomainService->getShareByResource( (string) $projectId, ResourceType::ProjectInvitation->value ); if (! $shareEntity) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_NOT_FOUND); } // 3. setpasswordProtectswitch if ($enabled) { // EnablepasswordProtect $password = $shareEntity->getPassword(); // IfNo/Nonehistorypassword, Generate new password if (empty($password)) { $plainPassword = ResourceShareEntity::generateRandomPassword(); } else { $plainPassword = PasswordCrypt::decrypt($password); } $this->resourceShareDomainService->changePasswordById($shareEntity->getId(), $plainPassword); return $plainPassword; } // ClosepasswordProtect (Reservepassword) $shareEntity->setIsPasswordEnabled(false); $shareEntity->setUpdatedAt(date('Y-m-d H:i:s')); $shareEntity->setUpdatedUid($currentUserId); $this->resourceShareDomainService->saveShareByEntity($shareEntity); return ''; } /** *  re setpassword*/ public function resetPassword(RequestContext $requestContext, int $projectId): string { $currentUserId = $requestContext->getUserAuthorization()->getId(); $organizationCode = $requestContext->getUserAuthorization()->getOrganizationCode(); // 1. ValidateProjectPermission $this->getAccessibleProjectWithManager($projectId, $currentUserId, $organizationCode); // 2. getExistingInviteshare $shareEntity = $this->resourceShareDomainService->getShareByResource( (string) $projectId, ResourceType::ProjectInvitation->value ); if (! $shareEntity) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_NOT_FOUND); } // 3. Generate new password $newPassword = ResourceShareEntity::generateRandomPassword(); $this->resourceShareDomainService->changePasswordById($shareEntity->getId(), $newPassword); return $newPassword; } /** * ModifyInvitation linkpassword*/ public function changePassword(RequestContext $requestContext, int $projectId, string $newPassword): string { $currentUserId = $requestContext->getUserAuthorization()->getId(); $organizationCode = $requestContext->getUserAuthorization()->getOrganizationCode(); // 1. ValidateProjectPermission $this->getAccessibleProjectWithManager($projectId, $currentUserId, $organizationCode); // 2. ValidatepasswordLength (Maximum18bit) if (strlen($newPassword) > 18 || strlen($newPassword) < 3) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_PASSWORD_INCORRECT); } // 3. getInvitation link $shareEntity = $this->resourceShareDomainService->getShareByResource( (string) $projectId, ResourceType::ProjectInvitation->value ); if (! $shareEntity) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_NOT_FOUND); } // 4. UpdatepasswordAndEnablepasswordProtect $this->resourceShareDomainService->changePasswordById($shareEntity->getId(), $newPassword); return $newPassword; } /** * ModifyPermissionGrade.*/ public function updateDefaultJoinPermission(RequestContext $requestContext, int $projectId, string $permission): string { $currentUserId = $requestContext->getUserAuthorization()->getId(); $organizationCode = $requestContext->getUserAuthorization()->getOrganizationCode(); // 1. ValidateProjectPermission $this->getAccessibleProjectWithManager($projectId, $currentUserId, $organizationCode); // 2. getExistingInviteshare $shareEntity = $this->resourceShareDomainService->getShareByResource( (string) $projectId, ResourceType::ProjectInvitation->value ); if (! $shareEntity) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_NOT_FOUND); } // 3. ValidateAndUpdatePermissionGrade MemberRole::validatePermissionLevel($permission); // 4. Update extra  in  default_join_permission $extra = $shareEntity->getExtra() ?? []; $extra['default_join_permission'] = $permission; $shareEntity->setExtra($extra); $shareEntity->setUpdatedAt(date('Y-m-d H:i:s')); $shareEntity->setUpdatedUid($currentUserId); // 5. SaveUpdate $this->resourceShareDomainService->saveShareByEntity($shareEntity); return $permission; } /** * throughTokengetInviteinformation (ExternaluserPreview).*/ public function getInvitationByToken(RequestContext $requestContext, string $token): InvitationDetailResponseDTO { $currentUserId = $requestContext->getUserAuthorization()->getId(); // 1. getshare information $shareEntity = $this->resourceShareDomainService->getShareByCode($token); if (! $shareEntity || ! ResourceType::isProjectInvitation($shareEntity->getResourceType())) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_NOT_FOUND); } // 2. Checkwhether already Enable if (! $shareEntity->getIsEnabled()) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_DISABLED); } // 3. CheckwhetherValid (Expire、Deletewait) if (! $shareEntity->isValid()) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_INVALID); } $resourceId = $shareEntity->getResourceId(); $projectId = (int) $resourceId; // 4. ValidatelinkCreatorwhether have ProjectmanagementPermission, May existinSubsequently willuserfromthisProject up Delete $project = $this->getAccessibleProjectWithManager($projectId, $shareEntity->getCreatedUid(), $shareEntity->getOrganizationCode()); // 5. ExtractCreatorID $creatorId = $project->getUserId(); $isCreator = $creatorId === $currentUserId; // 6. CheckMemberRelationship $hasJoined = $isCreator || $this->projectMemberDomainService->isProjectMemberByUser($projectId, $currentUserId); // 7. getCreatorinformation $creatorEntity = $this->magicUserDomainService->getByUserId($creatorId); $creatorAvatarUrl = $creatorNickName = ''; if ($creatorEntity) { $creatorNickName = $creatorEntity->getNickname(); $creatorAvatarUrl = $this->fileDomainService->getLink('', $creatorEntity->getAvatarUrl()) ?? $creatorEntity->getAvatarUrl(); } // 8. from extra get from default_join_permission $defaultJoinPermission = $shareEntity->getExtraAttribute('default_join_permission', 'viewer'); return InvitationDetailResponseDTO::fromArray([ 'project_id' => $resourceId, 'project_name' => $project->getProjectName(), 'project_description' => $project->getProjectDescription() ?? '', 'organization_code' => $project->getUserOrganizationCode() ?? '', 'creator_id' => $creatorId, 'creator_name' => $creatorNickName, 'creator_avatar' => $creatorAvatarUrl, 'default_join_permission' => $defaultJoinPermission, 'requires_password' => $shareEntity->getIsPasswordEnabled(), 'token' => $shareEntity->getShareCode(), 'has_joined' => $hasJoined, ]); } /** * JoinProject (ExternaluserOperation).*/ public function joinProject(RequestContext $requestContext, string $token, ?string $password = Null): JoinProjectResponseDTO { $currentUserId = $requestContext->getUserAuthorization()->getId(); // 1. Validatesharelink $shareEntity = $this->resourceShareDomainService->getShareByCode($token); if (! $shareEntity || ! ResourceType::isProjectInvitation($shareEntity->getResourceType())) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_NOT_FOUND); } // 2. Checkwhether already Enable if (! $shareEntity->getIsEnabled()) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_DISABLED); } // 3. CheckwhetherValid (Expire、Deletewait) if (! $shareEntity->isValid()) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_INVALID); } // 4. Validatepassword if ($shareEntity->getIsPasswordEnabled()) { // linkEnable ed passwordProtect if (empty($password)) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_PASSWORD_INCORRECT); } if (! $this->resourceShareDomainService->verifyPassword($shareEntity, $password)) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_PASSWORD_INCORRECT); } } // 5. Checkwhether already through is ProjectMember (throughDomainService) $isExistingMember = $this->projectMemberDomainService->isProjectMemberByUser( (int) $shareEntity->getResourceId(), $currentUserId ); if ($isExistingMember) { ExceptionBuilder::throw(SuperAgentErrorCode::INVITATION_LINK_ALREADY_JOINED); } $projectId = (int) $shareEntity->getResourceId(); // 6. ValidatelinkCreatorwhether have ProjectmanagementPermission, May existinSubsequently willuserfromthisProject up Delete $this->getAccessibleProjectWithManager($projectId, $shareEntity->getCreatedUid(), $shareEntity->getOrganizationCode()); // 7. from extra get from default_join_permission, AndConvert toMemberRole $permission = $shareEntity->getExtraAttribute('default_join_permission', MemberRole::VIEWER->value); $memberRole = MemberRole::validatePermissionLevel($permission); // UseDomainServiceaddMember, matchDDDarchitecture $projectMemberEntity = $this->projectMemberDomainService->addMemberByInvitation( $shareEntity->getResourceId(), $currentUserId, $memberRole, $shareEntity->getOrganizationCode(), $shareEntity->getCreatedUid() // Invite user （Invitation linkCreator） ); return JoinProjectResponseDTO::fromArray([ 'project_id' => $shareEntity->getResourceId(), 'user_role' => $memberRole->value, 'join_method' => $projectMemberEntity->getJoinMethod()->value, 'joined_at' => Carbon::now()->toDateTimeString(), ]); } } 