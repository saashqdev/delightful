<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the software license */ namespace Dtyq\SuperMagic\Domain\SuperAgent\Repository\Persistence; use App\Infrastructure\Util\IdGenerator\IdGenerator; use Dtyq\SuperMagic\Domain\SuperAgent\Entity\ProjectMemberEntity; use Dtyq\SuperMagic\Domain\SuperAgent\Entity\ValueObject\MemberRole; use Dtyq\SuperMagic\Domain\SuperAgent\Entity\ValueObject\MemberStatus; use Dtyq\SuperMagic\Domain\SuperAgent\Entity\ValueObject\MemberType; use Dtyq\SuperMagic\Domain\SuperAgent\Repository\Facade\ProjectMemberRepositoryInterface; use Dtyq\SuperMagic\Domain\SuperAgent\Repository\Model\ProjectMemberModel; use Hyperf\DbConnection\Db; /** * ProjectMemberRepositoryImplementation. * * ResponsibleProjectMemberDatapersistence operations*/ class ProjectMemberRepository implements ProjectMemberRepositoryInterface { public function __construct( private readonly ProjectMemberModel $projectMemberModel ) { } /** * Batch insert project members.*/ public function insert(array $projectMemberEntities): void { if (empty($projectMemberEntities)) { return; } $attributes = $this->prepareBatchInsertAttributes($projectMemberEntities); // UseTransactionEnsureDataConsistentproperty Db::transaction(function () use ($attributes) { // BatchInsert, avoidsingle times InsertDataovermultiple $chunks = array_chunk($attributes, 100); foreach ($chunks as $chunk) { $this->projectMemberModel::query()->insert($chunk); } }); } /** * Delete all members by project ID.*/ public function deleteByProjectId(int $projectId, array $roles = []): int { $query = $this->projectMemberModel::query(); if (! empty($roles)) { $query = $query->whereIn('role', $roles); } return $query->where('project_id', $projectId)->delete(); } /** * Batch delete members by ID array.*/ public function deleteByIds(array $ids): int { if (empty($ids)) { return 0; } return $this->projectMemberModel::query() ->whereIn('id', $ids) ->delete(); } /** * Delete specified project and user member relationship.*/ public function deleteByProjectAndUser(int $projectId, string $userId): int { return $this->projectMemberModel::query() ->where('project_id', $projectId) ->where('target_type', 'User') ->where('target_id', $userId) ->delete(); } /** * Delete specified project and target member relationship.*/ public function deleteByProjectAndTarget(int $projectId, string $targetType, string $targetId): int { return $this->projectMemberModel::query() ->where('project_id', $projectId) ->where('target_type', $targetType) ->where('target_id', $targetId) ->delete(); } /** * Check whether project and user member relationship exists.*/ public function existsByProjectAndUser(int $projectId, string $userId): bool { return $this->projectMemberModel::query() ->where('project_id', $projectId) ->where('target_type', MemberType::USER->value) ->where('target_id', $userId) ->exists(); } /** * Check whether project and department list member relationship exists.*/ public function existsByProjectAndDepartments(int $projectId, array $departmentIds): bool { if (empty($departmentIds)) { return false; } return $this->projectMemberModel::query() ->where('project_id', $projectId) ->where('target_type', MemberType::DEPARTMENT->value) ->whereIn('target_id', $departmentIds) ->exists(); } /** * Get all project members by project ID. * * @param int $projectId Project ID * @param array $roles MemberRole * @return ProjectMemberEntity[] Array of project member entities*/ public function findByProjectId(int $projectId, array $roles = []): array { $query = $this->projectMemberModel::query()->where('project_id', $projectId); if (! empty($roles)) { $query->whereIn('role', $roles); } $results = $query->orderBy('id', 'asc')->get()->toArray(); $entities = []; foreach ($results as $row) { $entities[] = ProjectMemberEntity::modelToEntity($row); } return $entities; } /** * Get project ID list and total by user and department (SupportPinSort).*/ public function getProjectIdsByUserAndDepartments( string $userId, array $departmentIds = [], ?string $name = Null, ?string $sortField = Null, string $sortDirection = 'desc', array $creatorUserIds = [], ?string $joinMethod = Null, array $organizationCodes = [] ): array { $query = $this->projectMemberModel::query() ->where(function ($query) use ($userId, $departmentIds) { $query->where(function ($subQuery) use ($userId) { $subQuery->where('target_type', MemberType::USER->value) ->where('target_id', $userId); }); if (! empty($departmentIds)) { $query->orWhere(function ($subQuery) use ($departmentIds) { $subQuery->where('target_type', MemberType::DEPARTMENT->value) ->whereIn('target_id', $departmentIds); }); } }); $query->join('magic_super_agent_project', 'magic_super_agent_project_members.project_id', '=', 'magic_super_agent_project.id') ->leftJoin('magic_super_agent_project_member_settings', function ($join) use ($userId) { $join->on('magic_super_agent_project_member_settings.project_id', '=', 'magic_super_agent_project.id') ->where('magic_super_agent_project_member_settings.user_id', '=', $userId); }) ->where('magic_super_agent_project.user_id', '!=', $userId) ->where('magic_super_agent_project.is_collaboration_enabled', 1) ->whereNull('magic_super_agent_project.deleted_at'); if (! empty($name)) { // If have ProjectNameSearchCondition,  then NeedConnectProjectTable $query->where('magic_super_agent_project.project_name', 'like', '%' . $name . '%'); } if (! empty($creatorUserIds)) { // If have CreatorUser IDSearchCondition $query->whereIn('magic_super_agent_project.user_id', $creatorUserIds); } if (! empty($joinMethod)) { // Join method $query->where('magic_super_agent_project_members.join_method', $joinMethod); } if (! empty($organizationCodes)) { // By/According toOrganization codeFilter $query->whereIn('magic_super_agent_project.user_organization_code', $organizationCodes); } $query->select( 'magic_super_agent_project_members.project_id', 'magic_super_agent_project.updated_at', 'magic_super_agent_project.created_at', 'magic_super_agent_project_member_settings.is_pinned', 'magic_super_agent_project_member_settings.last_active_at', 'magic_super_agent_project_member_settings.is_bind_workspace', 'magic_super_agent_project_member_settings.bind_workspace_id' ) ->distinct() ->orderByRaw('COALESCE(magic_super_agent_project_member_settings.is_pinned, 0) DESC'); // Pin's inbefore // By/According toSort field enter RowSort (default by  updated_at Sort) $effectiveSortField = $sortField ?: 'updated_at'; $effectiveSortDirection = $sortDirection ?: 'desc'; switch ($effectiveSortField) { case 'updated_at': $query->orderBy('magic_super_agent_project.updated_at', $effectiveSortDirection); break; case 'created_at': $query->orderBy('magic_super_agent_project.created_at', $effectiveSortDirection); break; case 'last_active_at': $query->orderBy('magic_super_agent_project_member_settings.last_active_at', $effectiveSortDirection); break; default: $query->orderBy('magic_super_agent_project.updated_at', 'desc'); break; } $results = $query->get()->toArray(); return [ 'total' => count($results), 'list' => $results, ]; } /** * Batch get project member counts. * * @param array $projectIds Project IDArray * @return array [project_id => total_count]*/ public function getProjectMembersCounts(array $projectIds): array { if (empty($projectIds)) { return []; } // Usesingle times QueryOptimizeN+1issue $results = $this->projectMemberModel::query() ->whereIn('project_id', $projectIds) ->whereIn('role', [MemberRole::MANAGE->value, MemberRole::EDITOR->value, MemberRole::VIEWER->value]) ->groupBy('project_id') ->selectRaw('project_id, COUNT(*) as total_count') ->get() ->keyBy('project_id') ->toArray(); // EnsureAllProject IDall have ReturnValue, No/NoneMemberProjectReturn0 $counts = []; foreach ($projectIds as $projectId) { $counts[$projectId] = (int) ($results[$projectId]['total_count'] ?? 0); } return $counts; } /** * Batch get preview of first N members. * * @param array $projectIds Project IDArray * @param int $limit Limit quantity, Default 4 * @return array [project_id => [ProjectMemberEntity[],...]]*/ public function getProjectMembersPreview(array $projectIds, int $limit = 4): array { if (empty($projectIds)) { return []; } // UseEloquentQuery, BatchgetAllRelatedProjectMember $results = $this->projectMemberModel::query() ->whereIn('project_id', $projectIds) ->orderBy('id', 'asc') ->get() ->toArray(); // InitializeResultArray $preview = []; foreach ($projectIds as $projectId) { $preview[$projectId] = []; } //  by ProjectGroupAndLimiteveryProjectMemberQuantity $memberCounts = []; foreach ($results as $member) { $projectId = $member['project_id']; // InitializeCountdevice if (! isset($memberCounts[$projectId])) { $memberCounts[$projectId] = 0; } // If un reach to Limit quantity,  then add to Result in  if ($memberCounts[$projectId] < $limit) { $preview[$projectId][] = ProjectMemberEntity::modelToEntity($member); ++$memberCounts[$projectId]; } } return $preview; } /** * Get project ID list and total created by user with members (SupportPinSort).*/ public function getSharedProjectIdsByUser( string $userId, string $organizationCode, ?string $name = Null, int $page = 1, int $pageSize = 10, ?string $sortField = Null, string $sortDirection = 'desc', array $creatorUserIds = [] ): array { // BuildBaseQuery: FinduserCreateAnd haveMemberProject $query = $this->projectMemberModel::query() ->join('magic_super_agent_project', 'magic_super_agent_project_members.project_id', '=', 'magic_super_agent_project.id') ->leftJoin('magic_super_agent_project_member_settings', function ($join) use ($userId) { $join->on('magic_super_agent_project_member_settings.project_id', '=', 'magic_super_agent_project.id') ->where('magic_super_agent_project_member_settings.user_id', '=', $userId); }) ->whereIn('magic_super_agent_project_members.role', [MemberRole::MANAGE->value, MemberRole::EDITOR->value, MemberRole::VIEWER->value]) ->where('magic_super_agent_project.user_id', '=', $userId) ->where('magic_super_agent_project.user_organization_code', '=', $organizationCode) ->where('magic_super_agent_project.is_collaboration_enabled', 1) ->whereNull('magic_super_agent_project.deleted_at'); // If have ProjectNameSearchCondition if (! empty($name)) { $query->where('magic_super_agent_project.project_name', 'like', '%' . $name . '%'); } // If have CreatorUser IDSearchCondition (PairinsharedType, Generalconstant is CurrentuserCreateProject, HereMain is ForInterfaceConsistentproperty) if (! empty($creatorUserIds)) { $query->whereIn('magic_super_agent_project.user_id', $creatorUserIds); } // getTotal $totalQuery = clone $query; $total = $totalQuery->select('magic_super_agent_project_members.project_id')->distinct()->count(); // PaginationQueryProject ID (containingSort fieldbyCompatibleDISTINCT) $projects = $query->select( 'magic_super_agent_project_members.project_id', 'magic_super_agent_project.updated_at', 'magic_super_agent_project.created_at', 'magic_super_agent_project_member_settings.is_pinned', 'magic_super_agent_project_member_settings.last_active_at', 'magic_super_agent_project_member_settings.is_bind_workspace', 'magic_super_agent_project_member_settings.bind_workspace_id' ) ->distinct() ->orderByRaw('COALESCE(magic_super_agent_project_member_settings.is_pinned, 0) DESC'); // Pin's inbefore // By/According toSort field enter RowSort (default by  updated_at Sort) $effectiveSortField = $sortField ?: 'updated_at'; $effectiveSortDirection = $sortDirection ?: 'desc'; switch ($effectiveSortField) { case 'updated_at': $projects->orderBy('magic_super_agent_project.updated_at', $effectiveSortDirection); break; case 'created_at': $projects->orderBy('magic_super_agent_project.created_at', $effectiveSortDirection); break; case 'last_active_at': $projects->orderBy('magic_super_agent_project_member_settings.last_active_at', $effectiveSortDirection); break; default: $projects->orderBy('magic_super_agent_project.updated_at', 'desc'); break; } $projects = $projects->offset(($page - 1) * $pageSize) ->limit($pageSize) ->get() ->toArray(); return [ 'total' => $total, 'list' => $projects, ]; } /** * Get collaboration project creator user ID list.*/ public function getCollaborationProjectCreatorIds( string $userId, array $departmentIds, string $organizationCode ): array { $query = $this->projectMemberModel::query() ->leftJoin('magic_super_agent_project as projects', 'magic_super_agent_project_members.project_id', '=', 'projects.id') ->where('magic_super_agent_project_members.organization_code', $organizationCode); // BuilduserPermissionQueryCondition - user is ProjectMember or DepartmentMember $query->where(function ($q) use ($userId, $departmentIds) { $q->where(function ($userQuery) use ($userId) { $userQuery->where('magic_super_agent_project_members.target_type', 'User') ->where('magic_super_agent_project_members.target_id', $userId); }); if (! empty($departmentIds)) { $q->orWhere(function ($deptQuery) use ($departmentIds) { $deptQuery->where('magic_super_agent_project_members.target_type', 'Department') ->whereIn('magic_super_agent_project_members.target_id', $departmentIds); }); } }); //  only getStatusNormalProjectMember $query->where('magic_super_agent_project_members.status', '1'); //  by CreatorIDGroupDistinct, getNot repeatCreatorIDlist $creatorIds = $query->select('projects.user_id') ->whereNotNull('projects.user_id') ->groupBy('projects.user_id') ->pluck('projects.user_id') ->toArray(); return array_filter($creatorIds); // FilterEmptyValue } /** * Get user participated project list (Supports collaboration project filtering and workspace binding filtering).*/ public function getParticipatedProjects( string $userId, ?int $workspaceId, bool $showCollaboration = true, ?string $projectName = Null, int $page = 1, int $pageSize = 10, string $sortField = 'last_active_at', string $sortDirection = 'desc', ?array $organizationCodes = Null ): array { // BuildBaseQuery $query = $this->projectMemberModel::query() ->from('magic_super_agent_project_members as pm') ->join('magic_super_agent_project as p', 'pm.project_id', '=', 'p.id') ->leftJoin('magic_super_agent_project_member_settings as pms', function ($join) use ($userId) { $join->on('p.id', '=', 'pms.project_id') ->where('pms.user_id', '=', $userId); }) ->where('pm.target_type', MemberType::USER->value) ->where('pm.target_id', $userId) ->where('pm.status', 1) ->where('p.project_status', 1) //  only QueryactivateStatus's Project ->whereNull('p.deleted_at'); // WorkspaceLimit (Optional) if ($workspaceId !== Null) { $query->where(function ($subQuery) use ($workspaceId, $userId) { $subQuery // Situation1: userselfCreateProject, inspecifiedWorkspace ->where(function ($q) use ($workspaceId, $userId) { $q->where('p.user_id', $userId) ->where('p.workspace_id', $workspaceId); }) // Situation2: CollaborationProject, userBind to specifiedWorkspace ->orWhere(function ($q) use ($workspaceId, $userId) { $q->where('p.user_id', '!=', $userId) ->where('pms.is_bind_workspace', 1) ->where('pms.bind_workspace_id', $workspaceId); }); }); } // Project name fuzzy search if (! empty($projectName)) { $query->where('p.project_name', 'like', '%' . $projectName . '%'); } // OrganizationFilter if (! empty($organizationCodes)) { $query->whereIn('p.user_organization_code', $organizationCodes); } // CollaborationProjectFilterLogic if (! $showCollaboration) { // showCollaboration = 0  time ,  only displayed already setShortcutProject $query->where('pms.is_bind_workspace', 1); // Ifspecified ed Workspace, Then furtherLimitForBindTo thisWorkspaceProject if ($workspaceId !== Null) { $query->where('pms.bind_workspace_id', $workspaceId); } } // showCollaboration = 1  time , displayedAllParticipateProject (defaultSituation) // getTotal $totalQuery = clone $query; $total = $totalQuery->select('p.id')->distinct()->count(); // BuildQueryfield $query->select([ 'p.id', 'p.workspace_id', 'p.project_name', 'p.project_description', 'p.work_dir', 'p.current_topic_id', 'p.current_topic_status', 'p.project_status', 'p.project_mode', 'p.user_id', 'p.user_organization_code as organization_code', 'p.is_collaboration_enabled', 'p.default_join_permission', 'p.created_at', 'p.updated_at', 'pm.role as user_role', Db::raw('COALESCE(pms.is_pinned, 0) as is_pinned'), Db::raw('COALESCE(pms.is_bind_workspace, 0) as is_bind_workspace'), Db::raw('COALESCE(pms.bind_workspace_id, 0) as bind_workspace_id'), Db::raw('COALESCE(pms.last_active_at, p.created_at) as last_active_at'), 'pms.pinned_at', Db::raw('CASE WHEN p.user_id != ? THEN 1 ELSE 0 END as is_collaborator'), ]) ->addBinding($userId, 'select'); // Distinct $query->distinct(); // SortLogic: PinPriority, PinProject by PinTimeSort,  most  after  by ActiveTimeSort $query->orderByRaw('COALESCE(pms.is_pinned, 0) DESC'); // 1. Pin's inbefore $query->orderByRaw('pms.pinned_at DESC'); // 2. PinProject by PinTimeSort（ most  after Pin's inbefore） $query->orderByRaw('COALESCE(pms.last_active_at, p.created_at) DESC'); // 3.  by ActiveTimeSort // Pagination $offset = ($page - 1) * $pageSize; $projects = $query->offset($offset) ->limit($pageSize) ->get() ->toArray(); return [ 'total' => $total, 'list' => $projects, ]; } /** * By/According toProject IDAndUser IDgetProjectMemberinformation.*/ public function getMemberByProjectAndUser(int $projectId, string $userId): ?ProjectMemberEntity { $memberData = $this->projectMemberModel::query() ->where('project_id', $projectId) ->where('target_type', MemberType::USER->value) ->where('target_id', $userId) ->first(); if (! $memberData) { return Null; } return $this->toEntity($memberData->toArray()); } /** * By/According toProject IDAndArray of member IDsgetMemberlist.*/ public function getMembersByIds(int $projectId, array $memberIds): array { if (empty($memberIds)) { return []; } $membersData = $this->projectMemberModel::query() ->where('project_id', $projectId) ->whereIn('target_id', $memberIds) ->get(); $entities = []; foreach ($membersData as $memberData) { $entities[] = $this->toEntity($memberData->toArray()); } return $entities; } /** * By/According toProject IDAndArray of department IDsgetProjectMemberlist.*/ public function getMembersByProjectAndDepartmentIds(int $projectId, array $departmentIds): array { if (empty($departmentIds)) { return []; } $membersData = $this->projectMemberModel::query() ->where('project_id', $projectId) ->where('target_type', 'Department') ->whereIn('target_id', $departmentIds) ->get(); $entities = []; foreach ($membersData as $memberData) { $entities[] = $this->toEntity($memberData->toArray()); } return $entities; } /** * BatchUpdateMemberPermission ( new format: target_type + target_id).*/ public function batchUpdateRole(int $projectId, array $roleUpdates): int { if (empty($roleUpdates)) { return 0; } $now = date('Y-m-d H:i:s'); $updatedCount = 0; foreach ($roleUpdates as $update) { $targetType = $update['target_type']; $targetId = $update['target_id']; $role = $update['role']; $result = $this->projectMemberModel::query() ->where('project_id', $projectId) ->where('target_type', $targetType) ->where('target_id', $targetId) ->update([ 'role' => $role, 'updated_at' => $now, ]); $updatedCount += $result; } return $updatedCount; } /** * BatchDeleteMember (hardDelete).*/ public function deleteMembersByIds(int $projectId, array $memberIds): int { if (empty($memberIds)) { return 0; } // UsehardDelete, BecauseTableNo/Nonedeleted_atfield return $this->projectMemberModel::query() ->where('project_id', $projectId) ->whereIn('target_id', $memberIds) ->delete(); } /** * throughCollaboratorTarget IDgetProjectIdslist (ExcludeOWNERRole).*/ public function getProjectIdsByCollaboratorTargets(array $targetIds, array $roles): array { if (empty($targetIds)) { return []; } return $this->projectMemberModel::query() ->whereIn('target_id', $targetIds) ->whereIn('role', $roles) ->where('status', MemberStatus::ACTIVE->value) ->distinct() ->pluck('project_id') ->toArray(); } /** * BatchgetuserinProject in MemberRecord.*/ public function getProjectMembersByTargetIds(array $projectIds, array $targetIds): array { if (empty($projectIds) || empty($targetIds)) { return []; } $results = $this->projectMemberModel::query() ->whereIn('project_id', $projectIds) ->whereIn('target_id', $targetIds) ->where('status', MemberStatus::ACTIVE->value) ->get() ->toArray(); $entities = []; foreach ($results as $row) { $entities[] = ProjectMemberEntity::modelToEntity($row); } return $entities; } /** * PrepareBatchInsertProperty/AttributeArray.*/ private function prepareBatchInsertAttributes(array $projectMemberEntities): array { $attributes = []; foreach ($projectMemberEntities as $entity) { $memberAttrs = $this->entityToModelAttributes($entity); if ($entity->getId() === 0) { $snowId = IdGenerator::getSnowId(); $memberAttrs['id'] = $snowId; $entity->setId($snowId); } $attributes[] = $memberAttrs; } return $attributes; } /** * EntityConvert toModelProperty/Attribute.*/ private function entityToModelAttributes(ProjectMemberEntity $entity): array { $now = date('Y-m-d H:i:s'); return [ 'id' => $entity->getId(), 'project_id' => $entity->getProjectId(), 'target_type' => $entity->getTargetType()->value, 'target_id' => $entity->getTargetId(), 'role' => $entity->getRole()->value, 'organization_code' => $entity->getOrganizationCode(), 'status' => $entity->getStatus()->value, 'invited_by' => $entity->getInvitedBy(), 'join_method' => $entity->getJoinMethod()->value, 'created_at' => $now, 'updated_at' => $now, ]; } /** * ConvertDataArrayConvert toProjectMemberEntity.*/ private function toEntity(array $data): ProjectMemberEntity { // Process/Handletarget_typefieldTypeConvert $targetType = $data['target_type'] ?? MemberType::USER->value; if (is_string($targetType)) { $targetType = MemberType::from($targetType); } // Process/HandlerolefieldTypeConvert $role = $data['role'] ?? MemberRole::EDITOR->value; if (is_string($role)) { $role = MemberRole::from($role); } // Process/HandlestatusfieldTypeConvert $status = $data['status'] ?? MemberStatus::ACTIVE->value; if (is_int($status)) { $status = MemberStatus::from($status); } return new ProjectMemberEntity([ 'id' => $data['id'] ?? 0, 'project_id' => $data['project_id'] ?? 0, 'target_type' => $targetType, 'target_id' => $data['target_id'] ?? '', 'role' => $role, 'organization_code' => $data['organization_code'] ?? '', 'status' => $status, 'invited_by' => $data['invited_by'] ?? '', 'created_at' => $data['created_at'] ?? Null, 'updated_at' => $data['updated_at'] ?? Null, 'deleted_at' => $data['deleted_at'] ?? Null, ]); } } 