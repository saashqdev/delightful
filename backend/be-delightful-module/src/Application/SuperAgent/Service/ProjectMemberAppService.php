<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Application\SuperAgent\Service; use App\Domain\Contact\Entity\DelightfulDepartmentEntity; use App\Domain\Contact\Entity\ValueObject\DataIsolation; use App\Domain\Contact\Entity\ValueObject\DepartmentOption; use App\Domain\Contact\Service\DelightfulDepartmentDomainService; use App\Domain\Contact\Service\DelightfulDepartmentUserDomainService; use App\Domain\Contact\Service\DelightfulUserDomainService; use App\Domain\Provider\Service\ModelFilter\PackageFilterInterface; use App\Infrastructure\Core\Exception\ExceptionBuilder; use App\Infrastructure\Util\Context\RequestContext; use Delightful\BeDelightful\Domain\SuperAgent\Entity\ProjectMemberEntity; use Delightful\BeDelightful\Domain\SuperAgent\Entity\ValueObject\MemberRole; use Delightful\BeDelightful\Domain\SuperAgent\Entity\ValueObject\MemberStatus; use Delightful\BeDelightful\Domain\SuperAgent\Entity\ValueObject\MemberType; use Delightful\BeDelightful\Domain\SuperAgent\Event\ProjectMembersUpdatedEvent; use Delightful\BeDelightful\Domain\SuperAgent\Event\ProjectShortcutCancelledEvent; use Delightful\BeDelightful\Domain\SuperAgent\Event\ProjectShortcutSetEvent; use Delightful\BeDelightful\Domain\SuperAgent\Service\ProjectDomainService; use Delightful\BeDelightful\Domain\SuperAgent\Service\ProjectMemberDomainService; use Delightful\BeDelightful\Domain\SuperAgent\Service\WorkspaceDomainService; use Delightful\BeDelightful\ErrorCode\SuperAgentErrorCode; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Request\BatchUpdateMembersRequestDTO; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Request\CreateMembersRequestDTO; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Request\GetCollaborationProjectListRequestDTO; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Request\GetParticipatedProjectsRequestDTO; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Request\UpdateProjectMembersRequestDTO; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Request\UpdateProjectPinRequestDTO; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Request\UpdateProjectShortcutRequestDTO; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Response\CollaborationCreatorListResponseDTO; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Response\CollaborationProjectListResponseDTO; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Response\CollaboratorMemberDTO; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Response\CreatorInfoDTO; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Response\ParticipatedProjectListResponseDTO; use Delightful\BeDelightful\Interfaces\SuperAgent\DTO\Response\ProjectMembersResponseDTO; use Psr\EventDispatcher\EventDispatcherInterface; use Psr\Log\LoggerInterface; /** * ProjectMemberApplicationService * * ResponsibleorchestrationProjectMemberRelatedBusinessProcess,  not containingSpecificbusiness logic*/ class ProjectMemberAppService extends AbstractAppService { public function __construct( private readonly LoggerInterface $logger, private readonly ProjectDomainService $projectDomainService, private readonly ProjectMemberDomainService $projectMemberDomainService, private readonly DelightfulDepartmentDomainService $departmentDomainService, private readonly DelightfulDepartmentUserDomainService $departmentUserDomainService, private readonly DelightfulUserDomainService $delightfulUserDomainService, private readonly WorkspaceDomainService $workspaceDomainService, private readonly EventDispatcherInterface $eventDispatcher, private readonly PackageFilterInterface $packageFilterService, ) { } /** * UpdateProjectMember. * * @param RequestContext $requestContext request context * @param UpdateProjectMembersRequestDTO $requestDTO RequestDTO*/ public function updateProjectMembers( RequestContext $requestContext, UpdateProjectMembersRequestDTO $requestDTO ): void { $userAuthorization = $requestContext->getUserAuthorization(); $currentUserId = $userAuthorization->getId(); $organizationCode = $userAuthorization->getOrganizationCode(); // 1. DTOConvert toEntity $projectId = (int) $requestDTO->getProjectId(); $memberEntities = []; foreach ($requestDTO->getMembers() as $memberData) { $entity = new ProjectMemberEntity(); $entity->setTargetTypeFromString($memberData['target_type']); $entity->setTargetId($memberData['target_id']); $entity->setOrganizationCode($organizationCode); $entity->setInvitedBy($currentUserId); $entity->setRole(MemberRole::MANAGE); $memberEntities[] = $entity; } // 2. ValidateAndgetcanaccessedProject $projectEntity = $this->getAccessibleProjectWithManager($projectId, $currentUserId, $organizationCode); // 3. delegate give DomainLayer processingbusiness logic $this->projectMemberDomainService->updateProjectMembers( $requestContext->getOrganizationCode(), $projectId, $memberEntities ); // 4. PublishProjectMember already UpdateEvent $projectMembersUpdatedEvent = new ProjectMembersUpdatedEvent($projectEntity, $memberEntities, $userAuthorization); $this->eventDispatcher->dispatch($projectMembersUpdatedEvent); // 5. RecordSuccessLog $this->logger->info('Project members updated successfully', [ 'project_id' => $projectId, 'operator_id' => $requestContext->getUserId(), 'member_count' => count($memberEntities), 'timestamp' => time(), ]); } /** * getProjectMemberlist.*/ public function getProjectMembers(RequestContext $requestContext, int $projectId): ProjectMembersResponseDTO { $userAuthorization = $requestContext->getUserAuthorization(); $currentUserId = $userAuthorization->getId(); $organizationCode = $userAuthorization->getOrganizationCode(); // 1. Validatewhethermanagement person  or All person Permission $this->getAccessibleProjectWithManager($projectId, $currentUserId, $organizationCode); // 2. getProjectMemberlist $memberEntities = $this->projectMemberDomainService->getProjectMembers($projectId, MemberRole::getAllRoleValues()); if (empty($memberEntities)) { return ProjectMembersResponseDTO::fromEmpty(); } // 3. GroupgetuserAndDepartmentID $userIds = $departmentIds = $targetMapEntities = []; foreach ($memberEntities as $entity) { if ($entity->getTargetType()->isUser()) { $userIds[] = $entity->getTargetId(); } elseif ($entity->getTargetType()->isDepartment()) { $departmentIds[] = $entity->getTargetId(); } $targetMapEntities[$entity->getTargetId()] = $entity; } // 4. CreateDataIsolationObject $dataIsolation = $requestContext->getDataIsolation(); // getuserBelong toDepartment $departmentUsers = $this->departmentUserDomainService->getDepartmentUsersByUserIdsInDelightful($userIds); $userIdMapDepartmentIds = []; foreach ($departmentUsers as $departmentUser) { if (! $departmentUser->isTopLevel()) { $userIdMapDepartmentIds[$departmentUser->getUserId()] = $departmentUser->getDepartmentId(); } } $allDepartmentIds = array_merge($departmentIds, array_values($userIdMapDepartmentIds)); // getDepartmentDetails $depIdMapDepartmentsInfos = $this->departmentDomainService->getDepartmentFullPathByIds($dataIsolation, $allDepartmentIds); // 5. getuserdetailedinformation $users = []; if (! empty($userIds)) { $userEntities = $this->delightfulUserDomainService->getUserByIdsWithoutOrganization($userIds); $this->updateUserAvatarUrl($dataIsolation, $userEntities); foreach ($userEntities as $userEntity) { $pathNodes = []; if (isset($userIdMapDepartmentIds[$userEntity->getUserId()])) { foreach ($depIdMapDepartmentsInfos[$userIdMapDepartmentIds[$userEntity->getUserId()]] ?? [] as $departmentInfo) { $pathNodes[] = $this->assemblePathNodeByDepartmentInfo($departmentInfo); } } $users[] = [ 'id' => (string) $userEntity->getId(), 'user_id' => $userEntity->getUserId(), 'name' => $userEntity->getNickname(), 'i18n_name' => $userEntity->getI18nName() ?? '', 'organization_code' => $userEntity->getOrganizationCode(), 'avatar_url' => $userEntity->getAvatarUrl() ?? '', 'type' => 'User', 'path_nodes' => $pathNodes, 'role' => $targetMapEntities[$userEntity->getUserId()]->getRole()->value, 'join_method' => $targetMapEntities[$userEntity->getUserId()]->getJoinMethod()->value, ]; } } // 6. getDepartmentdetailedinformation $departments = []; if (! empty($departmentIds)) { $departmentEntities = $this->departmentDomainService->getDepartmentByIds($dataIsolation, $departmentIds); foreach ($departmentEntities as $departmentEntity) { $pathNodes = []; foreach ($depIdMapDepartmentsInfos[$departmentEntity->getDepartmentId()] ?? [] as $departmentInfo) { $pathNodes[] = $this->assemblePathNodeByDepartmentInfo($departmentInfo); } $departments[] = [ 'id' => (string) $departmentEntity->getId(), 'department_id' => $departmentEntity->getDepartmentId(), 'name' => $departmentEntity->getName(), 'i18n_name' => $departmentEntity->getI18nName() ?? '', 'organization_code' => $requestContext->getOrganizationCode(), 'avatar_url' => '', 'type' => 'Department', 'path_nodes' => $pathNodes, 'role' => $targetMapEntities[$departmentEntity->getDepartmentId()]->getRole()->value, 'join_method' => $targetMapEntities[$departmentEntity->getDepartmentId()]->getJoinMethod()->value, ]; } } // 7. UseResponseDTOReturnResult return ProjectMembersResponseDTO::fromMemberData($users, $departments); } /** * getCollaborationProjectlist * By/According totypeParametergetDifferentTypeCollaborationProject: * - received: Othersshare give  we CollaborationProject * - shared:  we share give OthersCollaborationProject.*/ public function getCollaborationProjects(RequestContext $requestContext, GetCollaborationProjectListRequestDTO $requestDTO): array { $userAuthorization = $requestContext->getUserAuthorization(); $dataIsolation = $this->createDataIsolation($userAuthorization); $userId = $dataIsolation->getCurrentUserId(); $currentOrganizationCode = $dataIsolation->getCurrentOrganizationCode(); $type = $requestDTO->getType() ?: 'received'; // 1. getuserCollaborationProjectIn paidOrganization code (NonPaid plan not SupportProjectCollaboration) $collaborationPaidOrganizationCodes = $this->getUserCollaborationPaidOrganizationCodes($requestContext); // 2. ConvertCurrentOrganization codealsoJoinlist (For filtering) $paidOrganizationCodes = array_unique(array_merge($collaborationPaidOrganizationCodes, [$currentOrganizationCode])); // 3. By/According toTypegetProject IDlist $collaborationProjects = match ($type) { 'shared' => $this->getSharedProjectIds($userId, $currentOrganizationCode, $requestDTO), default => $this->getReceivedProjectIds($userId, $dataIsolation, $requestDTO, $paidOrganizationCodes), }; $projectIds = array_column($collaborationProjects['list'], 'project_id'); $totalCount = $collaborationProjects['total'] ?? 0; if (empty($projectIds)) { return CollaborationProjectListResponseDTO::fromProjectData([], [], [], [], [], $totalCount)->toArray(); } $result = $this->projectDomainService->getProjectsByConditions( ['project_ids' => $projectIds], $requestDTO->getPage(), $requestDTO->getPageSize() ); return $this->buildCollaborationProjectResponse($dataIsolation, $result['list'], $collaborationProjects['list'], $totalCount); } /** * UpdateProjectPinStatus. * * @param RequestContext $requestContext request context * @param int $projectId Project ID * @param UpdateProjectPinRequestDTO $requestDTO RequestDTO*/ public function updateProjectPin( RequestContext $requestContext, int $projectId, UpdateProjectPinRequestDTO $requestDTO ): void { $userAuthorization = $requestContext->getUserAuthorization(); // 1. ValidateAndgetcanaccessedProject $this->getAccessibleProject($projectId, $userAuthorization->getId(), $userAuthorization->getOrganizationCode()); // 2. delegate give DomainLayer processingbusiness logic $this->projectMemberDomainService->updateProjectPinStatus( $userAuthorization->getId(), $projectId, $userAuthorization->getOrganizationCode(), $requestDTO->isPinOperation() ); } /** * Update project shortcut. */ public function updateProjectShortcut( RequestContext $requestContext, int $projectId, UpdateProjectShortcutRequestDTO $requestDTO ): void { $userAuthorization = $requestContext->getUserAuthorization(); // 1. ValidateAndgetcanaccessedProject $projectEntity = $this->getAccessibleProject($projectId, $userAuthorization->getId(), $userAuthorization->getOrganizationCode()); if ($projectEntity->getUserId() === $userAuthorization->getId()) { ExceptionBuilder::throw(SuperAgentErrorCode::CANNOT_SET_SHORTCUT_FOR_OWN_PROJECT); } // 2. By/According toParameterDecidesetstill is CancelShortcut if ($requestDTO->getIsBindWorkspace() === 1) { $workspaceEntity = $this->workspaceDomainService->getWorkspaceDetail((int) $requestDTO->getWorkspaceId()); if (! $workspaceEntity || $workspaceEntity->getUserId() !== $userAuthorization->getId()) { ExceptionBuilder::throw(SuperAgentErrorCode::WORKSPACE_NOT_FOUND); } // setShortcut // 3. delegate give DomainLayer processingsetShortcut $this->projectMemberDomainService->setProjectShortcut( $userAuthorization->getId(), $projectId, (int) $requestDTO->getWorkspaceId(), $userAuthorization->getOrganizationCode() ); // 4. PublishProjectShortcutsetEvent $projectShortcutSetEvent = new ProjectShortcutSetEvent($projectEntity, (int) $requestDTO->getWorkspaceId(), $userAuthorization); $this->eventDispatcher->dispatch($projectShortcutSetEvent); } else { // CancelShortcut // 3. delegate give DomainLayer processingCancelShortcut $this->projectMemberDomainService->cancelProjectShortcut( $userAuthorization->getId(), $projectId ); // 4. PublishProjectShortcutCancelEvent $projectShortcutCancelledEvent = new ProjectShortcutCancelledEvent($projectEntity, $userAuthorization); $this->eventDispatcher->dispatch($projectShortcutCancelledEvent); } } /** * getCollaborationProjectCreatorlist.*/ public function getCollaborationProjectCreators(RequestContext $requestContext): CollaborationCreatorListResponseDTO { $userAuthorization = $requestContext->getUserAuthorization(); $dataIsolation = $requestContext->getDataIsolation(); // 1. getuserplaceinDepartmentIDlist $departmentIds = $this->departmentUserDomainService->getDepartmentIdsByUserId($dataIsolation, $userAuthorization->getId(), true); // 2. Get collaboration project creator user ID list $creatorUserIds = $this->projectMemberDomainService->getCollaborationProjectCreatorIds( $userAuthorization->getId(), $departmentIds, $userAuthorization->getOrganizationCode() ); $creatorUserIds = array_filter($creatorUserIds, function ($creatorUserId) use ($dataIsolation) { return ((string) $creatorUserId) !== $dataIsolation->getCurrentUserId(); }); if (empty($creatorUserIds)) { return CollaborationCreatorListResponseDTO::fromEmpty(); } // 3. BatchgetCreatoruserdetailedinformation $userEntities = $this->delightfulUserDomainService->getUserByIdsWithoutOrganization($creatorUserIds); // 4. UpdateAvatarURL $this->updateUserAvatarUrl($dataIsolation, $userEntities); // 5. CreateResponseDTOAndReturn return CollaborationCreatorListResponseDTO::fromUserEntities($userEntities); } /** * Get user participated project list (containingCollaborationProject). * * @param RequestContext $requestContext request context * @param GetParticipatedProjectsRequestDTO $requestDTO RequestDTO*/ public function getParticipatedProjects( RequestContext $requestContext, GetParticipatedProjectsRequestDTO $requestDTO ): array { $userAuthorization = $requestContext->getUserAuthorization(); $dataIsolation = $this->createDataIsolation($userAuthorization); // 1. getuserCollaborationProjectIn paidOrganization code (NonPaid plan not SupportProjectCollaboration) $collaborationPaidOrganizationCodes = $this->getUserCollaborationPaidOrganizationCodes($requestContext); // 2. ConvertCurrentOrganization codealsoJoinlist (For filtering) $paidOrganizationCodes = array_unique(array_merge($collaborationPaidOrganizationCodes, [$userAuthorization->getOrganizationCode()])); // 1. Get user participated project list $result = $this->projectMemberDomainService->getParticipatedProjectsWithCollaboration( $dataIsolation->getCurrentUserId(), $requestDTO->getWorkspaceId(), $requestDTO->getShowCollaboration(), $requestDTO->getProjectName(), $requestDTO->getPage(), $requestDTO->getPageSize(), $paidOrganizationCodes ); // 2. ExtractWorkspace IDAndgetName $workspaceIds = array_unique(array_map(fn ($project) => $project['workspace_id'], $result['list'] ?? [])); $workspaceNameMap = $this->workspaceDomainService->getWorkspaceNamesBatch($workspaceIds); // Add newmethod, By/According to$projectIds, Judgewhether store inData, If store in then Return store inprojectIds $projectIds = []; foreach ($result['list'] as $projectData) { $projectIds[] = $projectData['id']; } $projectMemberCounts = $this->projectMemberDomainService->getProjectMembersCounts($projectIds); $projectIdsWithMember = array_keys(array_filter($projectMemberCounts, fn ($count) => $count > 0)); // 3. UseunifiedResponseDTOProcess/HandleMethod $listResponseDTO = ParticipatedProjectListResponseDTO::fromResult($result, $workspaceNameMap, $projectIdsWithMember); return $listResponseDTO->toArray(); } /** * addProjectMember (Only supportsOrganizationInternalMember).*/ public function createMembers(RequestContext $requestContext, int $projectId, CreateMembersRequestDTO $requestDTO): array { $userAuthorization = $requestContext->getUserAuthorization(); $currentUserId = $userAuthorization->getId(); $organizationCode = $userAuthorization->getOrganizationCode(); // 1. getProjectAndValidateuserwhetherForProjectmanagement person  or All person  $project = $this->getAccessibleProjectWithManager($projectId, $currentUserId, $organizationCode); // 2. CheckProjectCollaborationwhetherEnable if (! $project->getIsCollaborationEnabled()) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED, 'project.collaboration_disabled'); } // 3. ExtractRequestData $members = $requestDTO->getMembers(); // 4. BuildMemberEntitylist $memberEntities = []; // 4.1 BatchValidateTargetuser/DepartmentinCurrentOrganizationinner $this->validateTargetsInOrganization($members, $organizationCode); foreach ($members as $memberData) { $memberEntity = new ProjectMemberEntity(); $memberEntity->setProjectId($projectId); $memberEntity->setTargetType(MemberType::from($memberData['target_type'])); $memberEntity->setTargetId($memberData['target_id']); $memberEntity->setRole(MemberRole::validatePermissionLevel($memberData['role'])); $memberEntity->setOrganizationCode($organizationCode); $memberEntity->setInvitedBy($currentUserId); $memberEntity->setStatus(MemberStatus::ACTIVE); $memberEntities[] = $memberEntity; } // 5. addMember $this->projectMemberDomainService->addInternalMembers($memberEntities, $organizationCode); // 6. getCompleteMemberinformation (ReuseExistinggetMemberlistLogic) $addedMemberIds = array_map(fn ($entity) => $entity->getTargetId(), $memberEntities); return $this->projectMemberDomainService->getMembersByIds($projectId, $addedMemberIds); } /** * BatchUpdateMemberPermission.*/ public function updateProjectMemberRoles(RequestContext $requestContext, int $projectId, BatchUpdateMembersRequestDTO $requestDTO): array { $userAuthorization = $requestContext->getUserAuthorization(); $currentUserId = $userAuthorization->getId(); $organizationCode = $userAuthorization->getOrganizationCode(); // 1. ValidatePermission $project = $this->getAccessibleProjectWithManager($projectId, $currentUserId, $organizationCode); // 2. ExtractRequestData $members = $requestDTO->getMembers(); // 3. ValidateBatchOperation - Extracttarget_idAndValidate $targetIds = array_column($members, 'target_id'); // CheckwhethertryModifyProjectCreatorPermission (IfCreator is Member) if (in_array($project->getCreatedUid(), $targetIds, true)) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED, 'project.cannot_modify_creator_permission'); } // 4. ValidateTargetuser/DepartmentinCurrentOrganizationinner $organizationCode = $requestContext->getUserAuthorization()->getOrganizationCode(); $this->validateTargetsInOrganization($members, $organizationCode); // 5. ConvertDataformatprovideDomainServiceUse $permissionUpdates = []; foreach ($members as $member) { $permissionUpdates[] = [ 'target_type' => $member['target_type'], 'target_id' => $member['target_id'], 'role' => $member['role'], ]; } // 6. ExecuteBatchPermissionUpdate $this->projectMemberDomainService->batchUpdateRole($projectId, $permissionUpdates); return []; } /** * BatchDeleteMember.*/ public function deleteMembers(RequestContext $requestContext, int $projectId, array $members): void { $userAuthorization = $requestContext->getUserAuthorization(); $currentUserId = $userAuthorization->getId(); $organizationCode = $userAuthorization->getOrganizationCode(); // getProject $project = $this->projectDomainService->getProjectNotUserId($projectId); $targetIds = array_column($members, 'target_id'); // CheckwhetherDeleteself if (in_array($currentUserId, $targetIds)) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } // CannotwhetherDeleteCreator if (in_array($project->getUserId(), $targetIds)) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } // 1. ValidatePermission $this->getAccessibleProjectWithManager($projectId, $currentUserId, $organizationCode); // 2. ExecuteBatchDelete $this->projectMemberDomainService->deleteMembersByIds($projectId, $targetIds); } /** * getuserCollaborationProjectIn paidOrganization code. * * @param RequestContext $requestContext request context * @return array Paid planOrganization codeArray*/ public function getUserCollaborationPaidOrganizationCodes(RequestContext $requestContext): array { $userAuthorization = $requestContext->getUserAuthorization(); $userId = $userAuthorization->getId(); $dataIsolation = $this->createDataIsolation($userAuthorization); // 1. getuserBelong toDepartmentIDlist (containingParentDepartment) $departmentIds = $this->departmentUserDomainService->getDepartmentIdsByUserId($dataIsolation, $userId, true); // 2. MergeUser IDAndDepartmentIDAsCollaboratorTarget ID $targetIds = array_merge([$userId], $departmentIds); // 3. throughCollaboratorTarget IDgetAllParticipateCollaborationProjectOrganization code (ExcludeOWNERRole) $projectIds = $this->projectMemberDomainService->getProjectIdsByCollaboratorTargets($targetIds); $organizationCodes = $this->projectDomainService->getOrganizationCodesByProjectIds($projectIds); if (empty($organizationCodes)) { return []; } // 4. throughPackageFilterInterfaceFilterOut of paid planOrganization code return $this->packageFilterService->filterPaidOrganizations($organizationCodes); } /** * getOthersshare give  we Project IDlist. * * @param string $userId User ID * @param DataIsolation $dataIsolation DataIsolationObject * @param GetCollaborationProjectListRequestDTO $requestDTO RequestDTO * @param array $organizationCodes Organization code list (For filtering)*/ private function getReceivedProjectIds(string $userId, DataIsolation $dataIsolation, GetCollaborationProjectListRequestDTO $requestDTO, array $organizationCodes = []): array { // getuserplaceinAllDepartment (containingParentDepartment) $departmentIds = $this->departmentUserDomainService->getDepartmentIdsByUserId( $dataIsolation, $userId, true // containingParentDepartment ); // getCollaborationProject IDlistandTotal ( by Organization codeFilter) return $this->projectMemberDomainService->getProjectIdsByUserAndDepartmentsWithTotal( $userId, $departmentIds, $requestDTO->getName(), $requestDTO->getSortField(), $requestDTO->getSortDirection(), $requestDTO->getCreatorUserIds(), $requestDTO->getJoinMethod(), $organizationCodes ); } /** * get we share give OthersProject IDlist.*/ private function getSharedProjectIds(string $userId, string $organizationCode, GetCollaborationProjectListRequestDTO $requestDTO): array { // directlycallOptimize after Repositorymethod, inData database layer face thenCompletePaginationAndFilter return $this->projectMemberDomainService->getSharedProjectIdsByUserWithTotal( $userId, $organizationCode, $requestDTO->getName(), $requestDTO->getPage(), $requestDTO->getPageSize(), $requestDTO->getSortField(), $requestDTO->getSortDirection(), $requestDTO->getCreatorUserIds() ); } /** * BuildCollaborationProjectResponseData.*/ private function buildCollaborationProjectResponse(DataIsolation $dataIsolation, array $projects, array $collaborationProjects, int $totalCount): array { $userId = $dataIsolation->getCurrentUserId(); // 1. getCreatorinformation $creatorUserIds = array_unique(array_map(fn ($project) => $project->getUserId(), $projects)); $creatorInfoMap = []; if (! empty($creatorUserIds)) { $creatorUsers = $this->delightfulUserDomainService->getUserByIdsWithoutOrganization($creatorUserIds); foreach ($creatorUsers as $user) { $creatorInfoMap[$user->getUserId()] = CreatorInfoDTO::fromUserEntity($user); } } // 2. RespectivelygetCollaboratorinformation (SplitInterface) $projectIdsFromResult = array_map(fn ($project) => $project->getId(), $projects); // 2.1 getuserin this  some ProjectHighest inPermissionRole $departmentIds = $this->departmentUserDomainService->getDepartmentIdsByUserId($dataIsolation, $userId, true); $targetIds = array_merge([$userId], $departmentIds); $userRolesMap = $this->projectMemberDomainService->getUserHighestRolesInProjects($projectIdsFromResult, $targetIds); // 2.1 getProjectMemberTotal $memberCounts = $this->projectMemberDomainService->getProjectMembersCounts($projectIdsFromResult); // 2.2 getProjectbefore4MemberPreview $membersPreview = $this->projectMemberDomainService->getProjectMembersPreview($projectIdsFromResult, 4); $collaboratorsInfoMap = []; foreach ($projectIdsFromResult as $projectId) { $memberInfo = $membersPreview[$projectId] ?? []; $memberCount = $memberCounts[$projectId] ?? 0; // SeparateuserAndDepartment $userIds = []; $departmentIds = []; foreach ($memberInfo as $member) { if ($member->getTargetType()->isUser()) { $userIds[] = $member->getTargetId(); } elseif ($member->getTargetType()->isDepartment()) { $departmentIds[] = $member->getTargetId(); } } // getuserAndDepartmentinformation $userEntities = ! empty($userIds) ? $this->delightfulUserDomainService->getUserByIdsWithoutOrganization($userIds) : []; $departmentEntities = ! empty($departmentIds) ? $this->departmentDomainService->getDepartmentByIds($dataIsolation, $departmentIds) : []; // directlyCreateCollaboratorMemberDTOArray $members = []; $this->updateUserAvatarUrl($dataIsolation, $userEntities); foreach ($userEntities as $userEntity) { $members[] = CollaboratorMemberDTO::fromUserEntity($userEntity); } foreach ($departmentEntities as $departmentEntity) { $members[] = CollaboratorMemberDTO::fromDepartmentEntity($departmentEntity); } $collaboratorsInfoMap[$projectId] = [ 'members' => $members, 'member_count' => $memberCount, ]; } // 3. ExtractWorkspace IDAndgetName $workspaceIds = array_unique(array_map(fn ($project) => $project->getWorkspaceId(), $projects)); $workspaceNameMap = $this->workspaceDomainService->getWorkspaceNamesBatch($workspaceIds); // 4. CreateCollaborationProjectlistResponseDTO (containinguserRole) $collaborationListResponseDTO = CollaborationProjectListResponseDTO::fromProjectData( $projects, $collaborationProjects, $creatorInfoMap, $collaboratorsInfoMap, $workspaceNameMap, $totalCount, $userRolesMap ); return $collaborationListResponseDTO->toArray(); } private function updateUserAvatarUrl(DataIsolation $dataIsolation, array $userEntities): void { $urlMapRealUrl = $this->getUserAvatarUrls($dataIsolation, $userEntities); foreach ($userEntities as $userEntity) { $userEntity->setAvatarUrl($urlMapRealUrl[$userEntity->getAvatarUrl()] ?? ''); } } private function getUserAvatarUrls(DataIsolation $dataIsolation, array $userEntities): array { $avatarUrlMapRealUrl = []; $urlPaths = []; foreach ($userEntities as $userEntity) { if (str_starts_with($userEntity->getAvatarUrl(), 'http')) { $avatarUrlMapRealUrl[$userEntity->getAvatarUrl()] = $userEntity->getAvatarUrl(); } else { $urlPaths[] = $userEntity->getAvatarUrl(); } } $urlPaths = $this->getIcons($dataIsolation->getCurrentOrganizationCode(), $urlPaths); foreach ($urlPaths as $path => $urlPath) { $avatarUrlMapRealUrl[$path] = $urlPath->getUrl(); } return array_merge($urlPaths, $avatarUrlMapRealUrl); } private function assemblePathNodeByDepartmentInfo(DelightfulDepartmentEntity $departmentInfo): array { return [ // DepartmentName 'department_name' => $departmentInfo->getName(), // Departmentid 'department_id' => $departmentInfo->getDepartmentId(), 'parent_department_id' => $departmentInfo->getParentDepartmentId(), // DepartmentPath 'path' => $departmentInfo->getPath(), // Visibility 'visible' => ! ($departmentInfo->getOption() === DepartmentOption::Hidden), 'option' => $departmentInfo->getOption(), ]; } /** * BatchValidateTargetuser/DepartmentinCurrentOrganizationinner.*/ private function validateTargetsInOrganization(array $members, string $organizationCode): void { // GroupreceiveSetUser IDAndDepartmentID $userIds = []; $departmentIds = []; foreach ($members as $member) { if (MemberType::fromString($member['target_type'])->isUser()) { $userIds[] = $member['target_id']; } elseif (MemberType::fromString($member['target_type'])->isDepartment()) { $departmentIds[] = $member['target_id']; } else { ExceptionBuilder::throw(SuperAgentErrorCode::INVALID_MEMBER_TYPE); } } // BatchValidateuser if (! empty($userIds)) { $validUsers = $this->delightfulUserDomainService->getUserByIdsWithoutOrganization($userIds); $validUserIds = array_map(fn ($user) => $user->getUserId(), $validUsers); $invalidUserIds = array_diff($userIds, $validUserIds); if (! empty($invalidUserIds)) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED, 'project.member_not_found'); } } // BatchValidateDepartment if (! empty($departmentIds)) { $dataIsolation = DataIsolation::create($organizationCode, ''); $validDepartments = $this->departmentDomainService->getDepartmentByIds($dataIsolation, $departmentIds); $validDepartmentIds = array_map(fn ($dept) => $dept->getDepartmentId(), $validDepartments); $invalidDepartmentIds = array_diff($departmentIds, $validDepartmentIds); if (! empty($invalidDepartmentIds)) { ExceptionBuilder::throw(SuperAgentErrorCode::DEPARTMENT_NOT_FOUND, 'project.department_not_found'); } } } } 