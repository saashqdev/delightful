<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperMagic\Interfaces\Share\Facade; use App\Infrastructure\Core\Exception\BusinessException; use App\Infrastructure\Util\Context\RequestContext; use Dtyq\ApiResponse\Annotation\ApiResponse; use Dtyq\SuperMagic\Application\Share\Service\ResourceShareAppService; use Dtyq\SuperMagic\Interfaces\Share\DTO\Request\CreateShareRequestDTO; use Dtyq\SuperMagic\Interfaces\Share\DTO\Request\GetShareDetailDTO; use Dtyq\SuperMagic\Interfaces\Share\DTO\Request\ResourceListRequestDTO; use Exception; use Hyperf\HttpServer\Contract\RequestInterface; use Qbhy\HyperfAuth\AuthManager; #[ApiResponse('low_code')] class ShareApi extends AbstractApi { public function __construct( protected RequestInterface $request, protected ResourceShareAppService $shareAppService, ) { } /** * Create resource share. * * @param RequestContext $requestContext request context * @return array share information * @throws BusinessException throws exception if parameters are invalid or operation fails * @throws Exception */ public function createShare(RequestContext $requestContext): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); $userAuthorization = $requestContext->getUserAuthorization(); $dto = CreateShareRequestDTO::fromRequest($this->request); $data = $this->shareAppService->createShare($userAuthorization, $dto); return $data->toArray(); } /** * Cancel resource share. * * @param RequestContext $requestContext request context * @param string $id share ID * @return array cancellation result * @throws BusinessException throws exception if parameters are invalid or operation fails * @throws Exception */ public function cancelShareByResourceId(RequestContext $requestContext, string $id): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); $userAuthorization = $requestContext->getUserAuthorization(); $this->shareAppService->cancelShareByResourceId($userAuthorization, $id); return [ 'id' => $id, ]; } public function checkShare(RequestContext $requestContext, string $shareCode): array { // trygetuserinformation, but may be accessed, so it will be Null try { $requestContext->setUserAuthorization(di(AuthManager::class)->guard(name: 'web')->user()); $userAuthorization = $requestContext->getUserAuthorization(); } catch (Exception $exception) { $userAuthorization = Null; } return $this->shareAppService->checkShare($userAuthorization, $shareCode); } public function getShareDetail(RequestContext $requestContext, string $shareCode): array { // trygetuserinformation, but may be accessed, so it will be Null try { $requestContext->setUserAuthorization(di(AuthManager::class)->guard(name: 'web')->user()); $userAuthorization = $requestContext->getUserAuthorization(); } catch (Exception $exception) { $userAuthorization = Null; } $dto = GetShareDetailDTO::fromRequest($this->request); return $this->shareAppService->getShareDetail($userAuthorization, $shareCode, $dto); } public function getShareList(RequestContext $requestContext): array { $requestContext->setUserAuthorization($this->getAuthorization()); $userAuthorization = $requestContext->getUserAuthorization(); $dto = ResourceListRequestDTO::fromRequest($this->request); return $this->shareAppService->getShareList($userAuthorization, $dto); } /** * through sharecodegetshare information. * * @param RequestContext $requestContext request context * @param string $shareCode sharecode * @return array share information * @throws BusinessException throws exception if parameters are invalid or operation fails * @throws Exception*/ public function getShareByCode(RequestContext $requestContext, string $shareCode): array { // trygetuserinformation, but may be accessed, so it will be Null $requestContext->setUserAuthorization($this->getAuthorization()); $userAuthorization = $requestContext->getUserAuthorization(); // directly call method containing plaintext password - in /code/{shareCode} routing in Use $dto = $this->shareAppService->getShareWithPasswordByCode($userAuthorization, $shareCode); return $dto->toArray(); } } 