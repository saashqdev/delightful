<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Interfaces\Agent\Facade\Admin; use App\Application\Flow\Service\DelightfulFlowAppService; use App\Domain\Flow\Entity\DelightfulFlowToolSetEntity; use App\Infrastructure\Util\ShadowCode\ShadowCode; use Delightful\ApiResponse\Annotation\ApiResponse; use Delightful\BeDelightful\Application\Agent\Service\BeDelightfulAgentAiOptimizeAppService; use Delightful\BeDelightful\Application\Agent\Service\BeDelightfulAgentAppService; use Delightful\BeDelightful\Domain\Agent\Entity\ValueObject\Query\BeDelightfulAgentQuery; use Delightful\BeDelightful\Domain\Agent\Entity\ValueObject\BeDelightfulAgentOptimizationType; use Delightful\BeDelightful\Interfaces\Agent\Assembler\BuiltinToolAssembler; use Delightful\BeDelightful\Interfaces\Agent\Assembler\BeDelightfulAgentAssembler; use Delightful\BeDelightful\Interfaces\Agent\DTO\BuiltinToolDTO; use Delightful\BeDelightful\Interfaces\Agent\DTO\BeDelightfulAgentDTO; use Delightful\BeDelightful\Interfaces\Agent\FormRequest\BeDelightfulAgentAiOptimizeFormRequest; use Delightful\BeDelightful\Interfaces\Agent\FormRequest\BeDelightfulAgentOrderFormRequest; use Delightful\BeDelightful\Interfaces\Agent\FormRequest\BeDelightfulAgentQueryFormRequest; use Delightful\BeDelightful\Interfaces\Agent\FormRequest\BeDelightfulAgentSaveFormRequest; use Hyperf\Di\Annotation\Inject; #[ApiResponse(version: 'low_code')] class BeDelightfulAgentAdminApi extends AbstractBeDelightfulAdminApi { #[Inject] protected BeDelightfulAgentAppService $superDelightfulAgentAppService; #[Inject] protected BeDelightfulAgentAiOptimizeAppService $superDelightfulAgentAiOptimizeAppService; #[Inject] protected DelightfulFlowAppService $magicFlowAppService; public function save(BeDelightfulAgentSaveFormRequest $request) { $authorization = $this->getAuthorization(); $requestData = $request->validated(); $DTO = new BeDelightfulAgentDTO($requestData); $promptShadow = $request->input('prompt_shadow'); if ($promptShadow) { $promptShadow = json_decode(ShadowCode::unShadow($promptShadow), true); $DTO->setPrompt($promptShadow); } $DO = BeDelightfulAgentAssembler::createDO($DTO); $entity = $this->superDelightfulAgentAppService->save($authorization, $DO); $users = $this->superDelightfulAgentAppService->getUsers($entity->getOrganizationCode(), [$entity->getCreator(), $entity->getModifier()]); return BeDelightfulAgentAssembler::createDTO($entity, $users); } public function queries(BeDelightfulAgentQueryFormRequest $request) { $authorization = $this->getAuthorization(); $requestData = $request->validated(); $query = new BeDelightfulAgentQuery($requestData); $page = $this->createPage(); $result = $this->superDelightfulAgentAppService->queries($authorization, $query, $page); return BeDelightfulAgentAssembler::createCategorizedListDTO( frequent: $result['frequent'], all: $result['all'], total: $result['total'] ); } public function show(string $code) { $authorization = $this->getAuthorization(); $withToolSchema = (bool) $this->request->input('with_tool_schema', false); $entity = $this->superDelightfulAgentAppService->show($authorization, $code, $withToolSchema); $withPromptString = (bool) $this->request->input('with_prompt_string', false); $users = $this->superDelightfulAgentAppService->getUsers($entity->getOrganizationCode(), [$entity->getCreator(), $entity->getModifier()]); return BeDelightfulAgentAssembler::createDTO($entity, $users, $withPromptString); } public function destroy(string $code) { $authorization = $this->getAuthorization(); $result = $this->superDelightfulAgentAppService->delete($authorization, $code); return ['success' => $result]; } public function enable(string $code) { $authorization = $this->getAuthorization(); $entity = $this->superDelightfulAgentAppService->enable($authorization, $code); $users = $this->superDelightfulAgentAppService->getUsers($entity->getOrganizationCode(), [$entity->getCreator(), $entity->getModifier()]); return BeDelightfulAgentAssembler::createDTO($entity, $users); } public function disable(string $code) { $authorization = $this->getAuthorization(); $entity = $this->superDelightfulAgentAppService->disable($authorization, $code); $users = $this->superDelightfulAgentAppService->getUsers($entity->getOrganizationCode(), [$entity->getCreator(), $entity->getModifier()]); return BeDelightfulAgentAssembler::createDTO($entity, $users); } /** * SaveAgentlineColumnSequential.*/ public function saveOrder(BeDelightfulAgentOrderFormRequest $request) { $authorization = $this->getAuthorization(); $requestData = $request->validated(); $orderConfig = [ 'frequent' => $requestData['frequent'] ?? [], 'all' => $requestData['all'], ]; $this->superDelightfulAgentAppService->saveOrderConfig($authorization, $orderConfig); return ['message' => 'Agent order saved successfully']; } /** * getBuilt-inToollist.*/ public function tools() { return BuiltinToolAssembler::createToolCategoryListDTO(); } /** * AIOptimizeAgent.*/ public function aiOptimize(BeDelightfulAgentAiOptimizeFormRequest $request) { $authorization = $this->getAuthorization(); $requestData = $request->validated(); // CreateOptimizeTypeEnumInstance (FormRequest ValidateEnsureValidproperty) $optimizationType = BeDelightfulAgentOptimizationType::fromString($requestData['optimization_type']); // Use BeDelightfulAgentAssembler Create entity $DTO = new BeDelightfulAgentDTO($requestData['agent']); $promptShadow = $request->input('agent.prompt_shadow'); if ($promptShadow) { $promptShadow = json_decode(ShadowCode::unShadow($promptShadow), true); $DTO->setPrompt($promptShadow); } $agentEntity = BeDelightfulAgentAssembler::createDO($DTO); // OnlyinOptimizeContent time onlyQueryToolinformation $availableTools = []; if ($optimizationType === BeDelightfulAgentOptimizationType::OptimizeContent) { // CurrentuserAvailableToollist $builtinTools = BuiltinToolAssembler::createToolListDTO(); $customToolSets = $this->magicFlowAppService->queryToolSets($authorization, false, false)['list'] ?? []; // MergeBuilt-inToolAndCustomToolFor unifiedformat $availableTools = $this->mergeAvailableTools($builtinTools, $customToolSets); } // callOptimizeService $optimizedEntity = $this->superDelightfulAgentAiOptimizeAppService->optimizeAgent( $authorization, $optimizationType, $agentEntity, $availableTools ); return [ 'optimization_type' => $optimizationType->value, 'agent' => BeDelightfulAgentAssembler::createDTO($optimizedEntity), ]; } /** * MergeBuilt-inToolAndCustomToolFor unifiedformat. * @param array<BuiltinToolDTO> $builtinTools * @param array<DelightfulFlowToolSetEntity> $customToolSets*/ private function mergeAvailableTools(array $builtinTools, array $customToolSets): array { $tools = []; // Process/HandleBuilt-inTool foreach ($builtinTools as $tool) { $tools[$tool->getCode()] = [ 'code' => $tool->getCode(), 'name' => $tool->getName(), 'description' => $tool->getDescription(), 'required' => $tool->isRequired(), 'type' => 'builtin', ]; } // Process/HandleCustomTool foreach ($customToolSets as $customToolSet) { foreach ($customToolSet->getTools() as $tool) { $tools[$tool['code']] = [ 'code' => $tool['code'], 'name' => $tool['name'], 'description' => $tool['description'], 'required' => false, 'type' => 'custom', ]; } } return $tools; } } 