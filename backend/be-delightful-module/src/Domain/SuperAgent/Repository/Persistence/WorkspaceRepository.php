<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Domain\SuperAgent\Repository\Persistence; use App\Infrastructure\Core\AbstractRepository; use Delightful\BeDelightful\Domain\SuperAgent\Entity\WorkspaceEntity; use Delightful\BeDelightful\Domain\SuperAgent\Repository\Facade\WorkspaceRepositoryInterface; use Delightful\BeDelightful\Domain\SuperAgent\Repository\Model\WorkspaceModel; use Hyperf\DbConnection\Db; class WorkspaceRepository extends AbstractRepository implements WorkspaceRepositoryInterface { public function __construct(protected WorkspaceModel $model) { } /** * getuserWorkspacelist.*/ public function getUserWorkspaces(string $userId, int $page, int $pageSize): array { $models = $this->model::query() ->where('user_id', $userId) ->orderBy('updated_at', 'desc') ->offset(($page - 1) * $pageSize) ->limit($pageSize) ->get(); $entities = []; foreach ($models as $model) { $entities[] = $this->modelToEntity($model); } return $entities; } /** * CreateWorkspace.*/ public function createWorkspace(WorkspaceEntity $workspaceEntity): WorkspaceEntity { $model = new $this->model(); $model->fill($workspaceEntity->toArray()); $model->save(); $workspaceEntity->setId($model->id); return $workspaceEntity; } /** * UpdateWorkspace.*/ public function updateWorkspace(WorkspaceEntity $workspaceEntity): bool { $model = $this->model::query()->find($workspaceEntity->getId()); if (! $model) { return false; } return $model->update($workspaceEntity->toArray()); } /** * getWorkspaceDetails.*/ public function getWorkspaceById(int $workspaceId): ?WorkspaceEntity { $model = $this->model::query()->where('id', $workspaceId)->whereNull('deleted_at')->first(); return $this->modelToEntity($model); } /** * By/According toIDFindWorkspace.*/ public function findById(int $workspaceId): ?WorkspaceEntity { return $this->getWorkspaceById($workspaceId); } /** * throughSessionIDgetWorkspace.*/ public function getWorkspaceByConversationId(string $conversationId): ?WorkspaceEntity { $model = $this->model::query()->where('conversation_id', $conversationId)->whereNull('deleted_at')->first(); return $this->modelToEntity($model); } /** * UpdateWorkspaceArchiveStatus.*/ public function updateWorkspaceArchivedStatus(int $workspaceId, int $isArchived): bool { return $this->model::query() ->where('id', $workspaceId) ->update(['is_archived' => $isArchived]) > 0; } /** * DeleteWorkspace.*/ public function deleteWorkspace(int $workspaceId): bool { return $this->model::query()->where('id', $workspaceId)->delete() > 0; } /** * DeleteWorkspaceassociatedTopic.*/ public function deleteTopicsByWorkspaceId(int $workspaceId): bool { // attention: HereNeedBy/According toActualSituationImplementation, compare like throughExternalServiceOrOtherRepositoryDeleteTopic // byinWe/UsNo/Noneview to TopicTablestructure, HereonlyAsshowexample return Db::table('delightful_chat_topics') ->where('workspace_id', $workspaceId) ->delete() > 0; } /** * UpdateWorkspaceCurrentTopic.*/ public function updateWorkspaceCurrentTopic(int $workspaceId, string $topicId): bool { return $this->model::query() ->where('id', $workspaceId) ->update(['current_topic_id' => $topicId]) > 0; } /** * UpdateWorkspaceStatus.*/ public function updateWorkspaceStatus(int $workspaceId, int $status): bool { return $this->model::query() ->where('id', $workspaceId) ->update(['status' => $status]) > 0; } /** * By/According toConditiongetWorkspacelist * SupportPaginationAndSort. * * @param array $conditions QueryCondition * @param int $page Page number * @param int $pageSize Per pageQuantity * @param string $orderBy Sort field * @param string $orderDirection Sort direction * @return array [total, list] TotalAndWorkspacelist*/ public function getWorkspacesByConditions( array $conditions = [], int $page = 1, int $pageSize = 10, string $orderBy = 'id', string $orderDirection = 'asc' ): array { $query = $this->model::query(); // defaultFilter already DeleteData $query->whereNull('deleted_at'); // ApplicationQueryCondition foreach ($conditions as $field => $value) { // defaultwaitinQuery $query->where($field, $value); } // getTotal $total = $query->count(); // SortAndPagination $list = $query->orderBy($orderBy, $orderDirection) ->offset(($page - 1) * $pageSize) ->limit($pageSize) ->get(); // Convert toEntityObject $entities = []; foreach ($list as $model) { $entities[] = $this->modelToEntity($model); } return [ 'total' => $total, 'list' => $entities, ]; } /** * SaveWorkspace (Create orUpdate). * * @param WorkspaceEntity $workspaceEntity WorkspaceEntity * @return WorkspaceEntity Save after WorkspaceEntity*/ public function save(WorkspaceEntity $workspaceEntity): WorkspaceEntity { if ($workspaceEntity->getId()) { // UpdateAlready existsinWorkspace $model = $this->model::query()->find($workspaceEntity->getId()); if ($model) { $model->update($workspaceEntity->toArray()); } } else { // Create new Workspace $model = new $this->model(); $model->fill($workspaceEntity->toArray()); $model->save(); $workspaceEntity->setId($model->id); } return $workspaceEntity; } /** * getAllWorkspaceUniqueOrganization codelist. * * @return array UniqueOrganization codelist*/ public function getUniqueOrganizationCodes(): array { return $this->model::query() ->whereNull('deleted_at') ->distinct() ->pluck('user_organization_code') ->filter(function ($code) { return ! empty($code); }) ->toArray(); } /** * BatchgetWorkspaceNameMapping. * * @param array $workspaceIds Workspace IDArray * @return array ['workspace_id' => 'workspace_name'] KeyValuePair*/ public function getWorkspaceNamesBatch(array $workspaceIds): array { if (empty($workspaceIds)) { return []; } $results = $this->model::query() ->whereIn('id', $workspaceIds) ->whereNull('deleted_at') ->select(['id', 'name']) ->get(); $workspaceNames = []; foreach ($results as $result) { $workspaceNames[(string) $result->id] = $result->name; } return $workspaceNames; } /** * ConvertModelObjectConvert toEntityObject * * @param Null|WorkspaceModel $model ModelObject * @return Null|WorkspaceEntity EntityObject*/ protected function modelToEntity($model): ?WorkspaceEntity { if (! $model) { return Null; } $entity = new WorkspaceEntity(); $entity->setId((int) $model->id); $entity->setUserId((string) $model->user_id); $entity->setUserOrganizationCode((string) $model->user_organization_code); $entity->setChatConversationId((string) $model->chat_conversation_id); $entity->setName((string) $model->name); $entity->setIsArchived((int) $model->is_archived); $entity->setCreatedUid((string) $model->created_uid); $entity->setUpdatedUid((string) $model->updated_uid); $entity->setCreatedAt($model->created_at ? (string) $model->created_at : Null); $entity->setUpdatedAt($model->updated_at ? (string) $model->updated_at : Null); $entity->setDeletedAt($model->deleted_at ? (string) $model->deleted_at : Null); $entity->setCurrentTopicId($model->current_topic_id ? (int) $model->current_topic_id : Null); $entity->setStatus((int) $model->status); return $entity; } } 