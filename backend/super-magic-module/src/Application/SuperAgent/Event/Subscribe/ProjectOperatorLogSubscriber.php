<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperMagic\Application\SuperAgent\Event\Subscribe; use Delightful\AsyncEvent\Kernel\Annotation\AsyncListener; use Delightful\SuperMagic\Domain\SuperAgent\Constants\OperationAction; use Delightful\SuperMagic\Domain\SuperAgent\Constants\ResourceType; use Delightful\SuperMagic\Domain\SuperAgent\Entity\ProjectOperationLogEntity; use Delightful\SuperMagic\Domain\SuperAgent\Event\DirectoryDeletedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\FileBatchMoveEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\FileContentSavedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\FileDeletedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\FileMovedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\FileRenamedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\FileReplacedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\FilesBatchDeletedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\FileUploadedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\ProjectCreatedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\ProjectDeletedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\ProjectMembersUpdatedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\ProjectShortcutCancelledEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\ProjectShortcutSetEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\ProjectUpdatedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\TopicCreatedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\TopicDeletedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\TopicRenamedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Event\TopicUpdatedEvent; use Delightful\SuperMagic\Domain\SuperAgent\Service\ProjectDomainService; use Delightful\SuperMagic\Domain\SuperAgent\Service\ProjectMemberDomainService; use Delightful\SuperMagic\Domain\SuperAgent\Service\ProjectOperationLogDomainService; use Delightful\SuperMagic\Infrastructure\Utils\IpUtil; use Hyperf\Event\Annotation\Listener; use Hyperf\Event\Contract\ListenerInterface; use Hyperf\HttpServer\Contract\RequestInterface; use Hyperf\Logger\LoggerFactory; use Psr\Log\LoggerInterface; use Throwable; /** * ProjectauditLogEventListendevice.*/ #[AsyncListener] #[Listener] class ProjectOperatorLogSubscriber implements ListenerInterface { private LoggerInterface $logger; public function __construct( private readonly ProjectOperationLogDomainService $projectOperationLogDomainService, private readonly ProjectMemberDomainService $projectMemberDomainService, private readonly ProjectDomainService $projectDomainService, private readonly RequestInterface $request, LoggerFactory $loggerFactory ) { $this->logger = $loggerFactory->get(static::class); } /** * ListenEventlist.*/ public function listen(): array { return [ // ProjectOperationEvent ProjectCreatedEvent::class, ProjectUpdatedEvent::class, ProjectDeletedEvent::class, // TopicOperationEvent TopicCreatedEvent::class, TopicUpdatedEvent::class, TopicDeletedEvent::class, TopicRenamedEvent::class, // FileOperationEvent FileUploadedEvent::class, FileDeletedEvent::class, FileRenamedEvent::class, FileMovedEvent::class, FileContentSavedEvent::class, FileReplacedEvent::class, DirectoryDeletedEvent::class, FileBatchMoveEvent::class, FilesBatchDeletedEvent::class, // ProjectMemberOperationEvent ProjectMembersUpdatedEvent::class, // ProjectShortcutOperationEvent ProjectShortcutSetEvent::class, ProjectShortcutCancelledEvent::class, ]; } /** * Process/HandleEvent.*/ public function process(object $event): void { // Debug: RecordReceivedEvent $this->logger->info('ProjectOperatorLogSubscriber received event', [ 'event_class' => get_class($event), ]); // Use defer DelayProcess/Handle, avoidblockMain businessProcess try { $ip = IpUtil::getClientIpAddress($this->request); $operationLogEntity = $this->convertEventToEntity($event, $ip); if ($operationLogEntity !== Null) { $this->projectOperationLogDomainService->saveOperationLog($operationLogEntity); $this->logger->info('ProjectOperationLogAlreadySave', [ 'event_class' => get_class($event), 'project_id' => $operationLogEntity->getProjectId(), 'action' => $operationLogEntity->getOperationAction(), ]); } // UpdateProjectMemberActiveTime $this->updateUserLastActiveTime($event); } catch (Throwable $e) { $this->logger->error('SaveProjectOperationLogFailed', [ 'event_class' => get_class($event), 'error' => $e->getMessage(), 'trace' => $e->getTraceAsString(), ]); } } private function updateUserLastActiveTime(object $event): void { $projectId = Null; $userId = Null; $organizationCode = Null; // UpdateProjectMemberActiveTime switch (true) { case $event instanceof ProjectUpdatedEvent: $projectId = $event->getProjectEntity()->getId(); $userId = $event->getUserAuthorization()->getId(); $organizationCode = $event->getUserAuthorization()->getOrganizationCode(); break; case $event instanceof FileUploadedEvent: $projectId = $event->getFileEntity()->getProjectId(); $userId = $event->getUserId(); $organizationCode = $event->getOrganizationCode(); break; case $event instanceof FileDeletedEvent: $projectId = $event->getFileEntity()->getProjectId(); $userId = $event->getUserId(); $organizationCode = $event->getOrganizationCode(); break; case $event instanceof FileRenamedEvent: $projectId = $event->getFileEntity()->getProjectId(); $userId = $event->getUserAuthorization()->getId(); $organizationCode = $event->getUserAuthorization()->getOrganizationCode(); break; case $event instanceof FileMovedEvent: $projectId = $event->getFileEntity()->getProjectId(); $userId = $event->getUserAuthorization()->getId(); $organizationCode = $event->getUserAuthorization()->getOrganizationCode(); break; case $event instanceof FileContentSavedEvent: $projectId = $event->getFileEntity()->getProjectId(); $userId = $event->getUserId(); $organizationCode = $event->getOrganizationCode(); break; case $event instanceof FileReplacedEvent: $projectId = $event->getFileEntity()->getProjectId(); $userId = $event->getUserAuthorization()->getId(); $organizationCode = $event->getUserAuthorization()->getOrganizationCode(); break; case $event instanceof DirectoryDeletedEvent: $projectId = $event->getDirectoryEntity()->getProjectId(); $userId = $event->getUserAuthorization()->getId(); $organizationCode = $event->getUserAuthorization()->getOrganizationCode(); break; case $event instanceof FileBatchMoveEvent: $projectId = $event->getProjectId(); $userId = $event->getUserId(); $organizationCode = $event->getOrganizationCode(); break; case $event instanceof FilesBatchDeletedEvent: $projectId = $event->getProjectId(); $userId = $event->getUserAuthorization()->getId(); $organizationCode = $event->getUserAuthorization()->getOrganizationCode(); break; case $event instanceof ProjectMembersUpdatedEvent: $projectId = $event->getProjectEntity()->getId(); $userId = $event->getUserAuthorization()->getId(); $organizationCode = $event->getUserAuthorization()->getOrganizationCode(); break; case $event instanceof ProjectShortcutSetEvent: $projectId = $event->getProjectEntity()->getId(); $userId = $event->getUserAuthorization()->getId(); $organizationCode = $event->getUserAuthorization()->getOrganizationCode(); break; case $event instanceof ProjectShortcutCancelledEvent: $projectId = $event->getProjectEntity()->getId(); $userId = $event->getUserAuthorization()->getId(); $organizationCode = $event->getUserAuthorization()->getOrganizationCode(); break; } if ($projectId !== Null) { $this->projectMemberDomainService->updateUserLastActiveTime($userId, $projectId, $organizationCode); $this->projectDomainService->updateUpdatedAtToNow($projectId); } } /** * ConvertEventConvert toOperationLogEntity.*/ private function convertEventToEntity(object $event, string $ip): ?ProjectOperationLogEntity { $entity = new ProjectOperationLogEntity(); switch (true) { case $event instanceof ProjectCreatedEvent: $project = $event->getProjectEntity(); // getuserauthorizationinformation $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($project->getId()); $entity->setOperationAction(OperationAction::CREATE_PROJECT); $entity->setResourceType(ResourceType::PROJECT); $entity->setResourceId((string) $project->getId()); $entity->setOperationDetails([ 'project_name' => $project->getProjectName(), 'project_description' => $project->getProjectDescription(), 'project_mode' => $project->getProjectMode(), ]); break; case $event instanceof ProjectUpdatedEvent: $project = $event->getProjectEntity(); // getuserauthorizationinformation $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($project->getId()); $entity->setOperationAction(OperationAction::UPDATE_PROJECT); $entity->setResourceType(ResourceType::PROJECT); $entity->setResourceId((string) $project->getId()); $entity->setOperationDetails([ 'project_name' => $project->getProjectName(), 'project_description' => $project->getProjectDescription(), ]); break; case $event instanceof ProjectDeletedEvent: $project = $event->getProjectEntity(); // getuserauthorizationinformation $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($project->getId()); $entity->setOperationAction(OperationAction::DELETE_PROJECT); $entity->setResourceType(ResourceType::PROJECT); $entity->setResourceId((string) $project->getId()); break; case $event instanceof TopicCreatedEvent: $topic = $event->getTopicEntity(); // getuserauthorizationinformation $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($topic->getProjectId()); $entity->setOperationAction(OperationAction::CREATE_TOPIC); $entity->setResourceType(ResourceType::TOPIC); $entity->setResourceId((string) $topic->getId()); $entity->setOperationDetails([ 'topic_name' => $topic->getTopicName(), ]); break; case $event instanceof TopicUpdatedEvent: $topic = $event->getTopicEntity(); // getuserauthorizationinformation $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($topic->getProjectId()); $entity->setOperationAction(OperationAction::UPDATE_TOPIC); $entity->setResourceType(ResourceType::TOPIC); $entity->setResourceId((string) $topic->getId()); $entity->setOperationDetails([ 'topic_name' => $topic->getTopicName(), ]); break; case $event instanceof TopicDeletedEvent: $topic = $event->getTopicEntity(); // getuserauthorizationinformation $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($topic->getProjectId()); $entity->setOperationAction(OperationAction::DELETE_TOPIC); $entity->setResourceType(ResourceType::TOPIC); $entity->setResourceId((string) $topic->getId()); break; case $event instanceof TopicRenamedEvent: $topic = $event->getTopicEntity(); // getuserauthorizationinformation $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($topic->getProjectId()); $entity->setOperationAction(OperationAction::RENAME_TOPIC); $entity->setResourceType(ResourceType::TOPIC); $entity->setResourceId((string) $topic->getId()); $entity->setOperationDetails([ 'topic_name' => $topic->getTopicName(), ]); break; case $event instanceof FileUploadedEvent: $file = $event->getFileEntity(); // getuserauthorizationinformation $entity->setUserId($event->getUserId()); $entity->setOrganizationCode($event->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($file->getProjectId()); $entity->setOperationAction(OperationAction::UPLOAD_FILE); $entity->setResourceType(ResourceType::FILE); $entity->setResourceId((string) $file->getFileId()); $entity->setOperationDetails([ 'file_name' => $file->getFileName(), 'parent_id' => $file->getParentId(), 'is_directory' => $file->getIsDirectory(), ]); break; case $event instanceof FileDeletedEvent: $file = $event->getFileEntity(); // getuserauthorizationinformation $entity->setUserId($event->getUserId()); $entity->setOrganizationCode($event->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($file->getProjectId()); $entity->setOperationAction(OperationAction::DELETE_FILE); $entity->setResourceType(ResourceType::FILE); $entity->setResourceId((string) $file->getFileId()); break; case $event instanceof FileRenamedEvent: $file = $event->getFileEntity(); // getuserauthorizationinformation $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($file->getProjectId()); $entity->setOperationAction(OperationAction::RENAME_FILE); $entity->setResourceType(ResourceType::FILE); $entity->setResourceId((string) $file->getFileId()); $entity->setOperationDetails([ 'file_name' => $file->getFileName(), 'parent_id' => $file->getParentId(), 'is_directory' => $file->getIsDirectory(), ]); break; case $event instanceof FileMovedEvent: $file = $event->getFileEntity(); // getuserauthorizationinformation $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($file->getProjectId()); $entity->setOperationAction(OperationAction::MOVE_FILE); $entity->setResourceType(ResourceType::FILE); $entity->setResourceId((string) $file->getFileId()); $entity->setOperationDetails([ 'file_name' => $file->getFileName(), 'parent_id' => $file->getParentId(), 'is_directory' => $file->getIsDirectory(), ]); break; case $event instanceof FileContentSavedEvent: $file = $event->getFileEntity(); // getuserauthorizationinformation $entity->setUserId($event->getUserId()); $entity->setOrganizationCode($event->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($file->getProjectId()); $entity->setOperationAction(OperationAction::SAVE_FILE_CONTENT); $entity->setResourceType(ResourceType::FILE); $entity->setResourceId((string) $file->getFileId()); $entity->setOperationDetails([]); break; case $event instanceof FileReplacedEvent: $file = $event->getFileEntity(); $versionEntity = $event->getVersionEntity(); // getuserauthorizationinformation $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($file->getProjectId()); $entity->setOperationAction(OperationAction::REPLACE_FILE); $entity->setResourceType(ResourceType::FILE); $entity->setResourceId((string) $file->getFileId()); // detailedOperationinformation $operationDetails = [ 'file_name' => $file->getFileName(), 'file_extension' => $file->getFileExtension(), 'file_size' => $file->getFileSize(), 'is_cross_type_replace' => $event->isCrossTypeReplace(), ]; // IfCreate ed Versionsnapshot, RecordVersionID if ($versionEntity !== Null) { $operationDetails['version_id'] = $versionEntity->getId(); } $entity->setOperationDetails($operationDetails); break; case $event instanceof DirectoryDeletedEvent: $directory = $event->getDirectoryEntity(); // getuserauthorizationinformation $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($directory->getProjectId()); $entity->setOperationAction(OperationAction::DELETE_DIRECTORY); $entity->setResourceType(ResourceType::DIRECTORY); $entity->setResourceId((string) $directory->getFileId()); break; case $event instanceof FileBatchMoveEvent: $entity->setUserId($event->getUserId()); $entity->setOrganizationCode($event->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($event->getProjectId()); $entity->setOperationAction(OperationAction::BATCH_MOVE_FILE); $entity->setResourceType(ResourceType::FILE); $entity->setResourceId('batch'); $entity->setOperationDetails([ 'parent_id' => $event->getTargetParentId(), 'file_ids' => $event->getFileIds(), ]); break; case $event instanceof FilesBatchDeletedEvent: // getuserauthorizationinformation $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($event->getProjectId()); $entity->setOperationAction(OperationAction::BATCH_DELETE_FILE); $entity->setResourceType(ResourceType::FILE); $entity->setResourceId('batch'); $entity->setOperationDetails([ 'file_ids' => $event->getFileIds(), ]); break; case $event instanceof ProjectMembersUpdatedEvent: $project = $event->getProjectEntity(); $members = $event->getCurrentMembers(); $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($project->getId()); $entity->setOperationAction(OperationAction::UPDATE_PROJECT_MEMBERS); $entity->setResourceType(ResourceType::PROJECT); $entity->setResourceId((string) $project->getId()); $entity->setOperationDetails(['members' => $members]); break; case $event instanceof ProjectShortcutSetEvent: $project = $event->getProjectEntity(); $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($project->getId()); $entity->setOperationAction(OperationAction::SET_PROJECT_SHORTCUT); $entity->setResourceType(ResourceType::PROJECT); $entity->setResourceId((string) $project->getId()); $entity->setOperationDetails([ 'workspace_id' => $event->getWorkspaceId(), 'project_name' => $project->getProjectName(), ]); break; case $event instanceof ProjectShortcutCancelledEvent: $project = $event->getProjectEntity(); $userAuthorization = $event->getUserAuthorization(); $entity->setUserId($userAuthorization->getId()); $entity->setOrganizationCode($userAuthorization->getOrganizationCode()); $entity->setOperationStatus('success'); $entity->setIpAddress($ip); $entity->setProjectId($project->getId()); $entity->setOperationAction(OperationAction::CANCEL_PROJECT_SHORTCUT); $entity->setResourceType(ResourceType::PROJECT); $entity->setResourceId((string) $project->getId()); $entity->setOperationDetails([ 'project_name' => $project->getProjectName(), ]); break; default: $this->logger->warning(' un Process/HandleEventType', ['event_class' => get_class($event)]); return Null; } return $entity; } } 