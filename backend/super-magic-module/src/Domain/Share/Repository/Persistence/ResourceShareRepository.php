<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperMagic\Domain\Share\Repository\Persistence; use App\Infrastructure\Core\AbstractRepository; use App\Infrastructure\Util\IdGenerator\IdGenerator; use Dtyq\SuperMagic\Domain\Share\Constant\ResourceType; use Dtyq\SuperMagic\Domain\Share\Entity\ResourceShareEntity; use Dtyq\SuperMagic\Domain\Share\Repository\Facade\ResourceShareRepositoryInterface; use Dtyq\SuperMagic\Domain\Share\Repository\Model\ResourceShareModel; use Exception; use Hyperf\Codec\Json; /** * ResourceshareRepositoryImplementation.*/ class ResourceShareRepository extends AbstractRepository implements ResourceShareRepositoryInterface { /** * ConstructFunction.*/ public function __construct(protected ResourceShareModel $model) { } /** * throughIDgetshare. * * @param int $shareId share ID * @return Null|ResourceShareEntity ResourceshareEntity*/ public function getShareById(int $shareId): ?ResourceShareEntity { $model = $this->model->newQuery()->where('id', $shareId)->whereNull('deleted_at')->first(); return $model ? $this->modelToEntity($model) : Null; } /** * through sharecodegetshare. * * @param string $shareCode sharecode * @return Null|ResourceShareEntity ResourceshareEntity*/ public function getShareByCode(string $shareCode): ?ResourceShareEntity { $model = $this->model->newQuery()->where('share_code', $shareCode)->orderBy('id', 'desc')->first(); return $model ? $this->modelToEntity($model) : Null; } public function getShareByResourceId(string $resourceId): ?ResourceShareEntity { $model = $this->model->newQuery()->where('resource_id', $resourceId)->first(); return $model ? $this->modelToEntity($model) : Null; } /** * FindResourcePair should share. * * @param string $resourceId ResourceID * @param ResourceType $resourceType ResourceType * @param string $userId User ID * @return Null|ResourceShareEntity ResourceshareEntity*/ public function findByResource(string $resourceId, ResourceType $resourceType, string $userId): ?ResourceShareEntity { $model = $this->model->newQuery() ->where('resource_id', $resourceId) ->where('resource_type', $resourceType->value) ->where('creator', $userId) ->first(); return $model ? $this->modelToEntity($model) : Null; } /** * CreateshareRecord. * * @param array $data shareData * @return string share ID*/ public function create(array $data): string { $model = new $this->model(); $model->fill($data); $model->save(); return (string) $model->id; } /** * SaveshareEntity. * * @param ResourceShareEntity $shareEntity ResourceshareEntity * @return ResourceShareEntity Save after ResourceshareEntity * @throws Exception*/ public function save(ResourceShareEntity $shareEntity): ResourceShareEntity { $data = $this->entityToArray($shareEntity); try { if ($shareEntity->getId() === 0) { // Create new Record $data['id'] = IdGenerator::getSnowId(); $model = $this->model::query()->create($data); $shareEntity->setId((int) $model->id); } else { // UpdateExistingRecord $this->model->query()->withTrashed()->where('id', $shareEntity->getId())->update($data); } return $shareEntity; } catch (Exception $e) { throw new Exception('SaveshareFailedï¼š' . $e->getMessage()); } } /** * Deleteshare. * * @param int $shareId share ID * @param bool $forceDelete whetherForceDelete (PhysicalDelete), defaultfalseFor softDelete * @return bool whetherSuccess*/ public function delete(int $shareId, bool $forceDelete = false): bool { if ($forceDelete) { // PhysicalDelete: directlyfromData database Delete $model = $this->model->newQuery()->withTrashed()->find($shareId); if ($model) { return $model->forceDelete(); } } else { // softDelete: Use SoftDeletes trait $model = $this->model->newQuery()->find($shareId); if ($model) { return $model->delete(); } } return false; } /** * Addshareview count. * * @param string $shareCode sharecode * @return bool whetherSuccess*/ public function incrementViewCount(string $shareCode): bool { $result = $this->model->newQuery() ->where('share_code', $shareCode) ->increment('view_count'); return $result > 0; } /** * ChecksharecodewhetherAlready existsin. * * @param string $shareCode sharecode * @return bool whetherAlready existsin*/ public function isShareCodeExists(string $shareCode): bool { return $this->model->newQuery()->where('share_code', $shareCode)->exists(); } /** * getshareRecordlist. * * @param array $conditions Condition * @param int $page Page number * @param int $pageSize Per pageQuantity * @return array PaginationData [total, list]*/ public function paginate(array $conditions, int $page = 1, int $pageSize = 20): array { $query = $this->model->newQuery(); // addQueryCondition foreach ($conditions as $field => $value) { if ($field == 'keyword') { $query->where($field, 'LIKE', '%' . $value . '%'); } else { if ($value !== Null) { $query->where($field, $value); } } } //  by Created atDescendingSort $query->orderBy('id', 'desc'); $query->whereNull('deleted_at'); // calculateTotal $total = $query->count(); // getPaginationData $models = $query->offset(($page - 1) * $pageSize) ->limit($pageSize) ->get(); // ConvertModelConvert toEntity $items = []; foreach ($models as $model) { $items[] = $this->modelToEntity($model); } return [ 'total' => $total, 'list' => $items, ]; } public function getShareByResource(string $userId, string $resourceId, int $resourceType, bool $withTrashed = true): ?ResourceShareEntity { if ($withTrashed) { $query = ResourceShareModel::query()->withTrashed(); } else { $query = ResourceShareModel::query(); } if (! empty($userId)) { $query = $query->where('created_uid', $userId); } $model = $query->where('resource_id', $resourceId)->where('resource_type', $resourceType)->first(); if (! $model) { return Null; } return $this->modelToEntity($model); } /** * ConvertPOModelConvert toEntity. * * @param ResourceShareModel $model Model * @return ResourceShareEntity Entity*/ protected function modelToEntity(ResourceShareModel $model): ?ResourceShareEntity { $entity = new ResourceShareEntity(); $entity->setId((int) $model->id); $entity->setResourceId((string) $model->resource_id); $entity->setResourceType((int) $model->resource_type); $entity->setResourceName((string) $model->resource_name); $entity->setShareCode(htmlspecialchars($model->share_code, ENT_QUOTES, 'UTF-8')); $entity->setShareType((int) $model->share_type); $entity->setPassword($model->password); // safeProcess/HandleDate - Ensureformatcorrect if ($model->expire_at) { $entity->setExpireAt($model->expire_at); } $entity->setViewCount($model->view_count); $entity->setCreatedUid($model->created_uid); $entity->setOrganizationCode(htmlspecialchars($model->organization_code, ENT_QUOTES, 'UTF-8')); // Process/HandleTarget ID, IfEntityHave this infield /* @phpstan-ignore-next-line */ if (property_exists($model, 'target_ids') && method_exists($entity, 'setTargetIds')) { $entity->setTargetIds($model->target_ids ?? '[]'); } $extra = $model->extra ?? []; $extra = is_array($extra) ? $extra : Json::decode($extra); $entity->setExtra($extra); // Process/HandlewhetherEnablefield (Invitation linkDedicated) $entity->setIsEnabled($model->is_enabled ?? true); // Process/HandlepasswordProtectwhetherEnablefield $entity->setIsPasswordEnabled($model->is_password_enabled ?? false); if ($model->created_at) { $entity->setCreatedAt($model->created_at); } if ($model->updated_at) { $entity->setUpdatedAt($model->updated_at); } if ($model->deleted_at) { $entity->setDeletedAt($model->deleted_at); } return $entity; } /** * ConvertEntityConvert toArray. * * @param ResourceShareEntity $entity Entity * @return array Array*/ protected function entityToArray(ResourceShareEntity $entity): array { return [ 'id' => $entity->getId(), 'resource_id' => $entity->getResourceId(), 'resource_type' => $entity->getResourceType(), 'resource_name' => $entity->getResourceName(), 'share_code' => $entity->getShareCode(), 'share_type' => $entity->getShareType(), 'password' => $entity->getPassword(), 'is_password_enabled' => $entity->getIsPasswordEnabled() ? 1 : 0, 'expire_at' => $entity->getExpireAt(), 'view_count' => $entity->getViewCount(), 'created_uid' => $entity->getCreatedUid(), 'organization_code' => $entity->getOrganizationCode(), 'extra' => Json::encode($entity->getExtra() ?? []), 'is_enabled' => $entity->getIsEnabled() ? 1 : 0, 'updated_at' => $entity->getUpdatedAt(), 'deleted_at' => $entity->getDeletedAt(), 'updated_uid' => $entity->getUpdatedUid(), ]; } } 