<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Dtyq\SuperMagic\Domain\SuperAgent\Repository\Persistence; use Dtyq\SuperMagic\Domain\SuperAgent\Entity\TaskFileVersionEntity; use Dtyq\SuperMagic\Domain\SuperAgent\Repository\Facade\TaskFileVersionRepositoryInterface; use Dtyq\SuperMagic\Domain\SuperAgent\Repository\Model\TaskFileVersionModel; class TaskFileVersionRepository implements TaskFileVersionRepositoryInterface { public function __construct(protected TaskFileVersionModel $model) { } public function getById(int $id): ?TaskFileVersionEntity { $model = $this->model::query()->where('id', $id)->first(); if (! $model) { return Null; } return new TaskFileVersionEntity($model->toArray()); } public function getByFileId(int $fileId): array { $models = $this->model::query() ->where('file_id', $fileId) ->orderBy('version', 'desc') ->get(); $entities = []; foreach ($models as $model) { $entities[] = new TaskFileVersionEntity($model->toArray()); } return $entities; } public function countByFileId(int $fileId): int { return $this->model::query() ->where('file_id', $fileId) ->count(); } public function getLatestVersionNumber(int $fileId): int { $latestVersion = $this->model::query() ->where('file_id', $fileId) ->max('version'); return $latestVersion ?? 0; } public function insert(TaskFileVersionEntity $entity): TaskFileVersionEntity { $date = date('Y-m-d H:i:s'); $entity->setCreatedAt($date); $entity->setUpdatedAt($date); $entityArray = $entity->toArray(); $model = $this->model::query()->create($entityArray); if (! empty($model->id)) { $entity->setId($model->id); } return $entity; } public function deleteOldVersionsByFileId(int $fileId, int $keepCount): int { // getNeedCleanVersionEntitylist $versionsToDelete = $this->getVersionsToCleanup($fileId, $keepCount); if (empty($versionsToDelete)) { return 0; } // ExtractVersionIDUsed forBatchDelete $idsToDelete = array_map(fn ($version) => $version->getId(), $versionsToDelete); // BatchDeleteoldVersion return $this->model::query() ->whereIn('id', $idsToDelete) ->delete(); } public function deleteAllVersionsByFileId(int $fileId): int { return $this->model::query() ->where('file_id', $fileId) ->delete(); } /** * getNeedCleanVersionEntitylist.*/ public function getVersionsToCleanup(int $fileId, int $keepCount): array { // thonestep: getNeedReserveVersionID ( most  new keepCountVersion) $idsToKeep = $this->model::query() ->where('file_id', $fileId) ->orderBy('version', 'desc') ->limit($keepCount) ->pluck('id') ->toArray(); if (empty($idsToKeep)) { // IfNo/NonewantReserveVersion, ReturnAllVersionUsed forClean $models = $this->model::query() ->where('file_id', $fileId) ->get(); } else { // thtwostep: getNeedDeleteVersionRecord $models = $this->model::query() ->where('file_id', $fileId) ->whereNotIn('id', $idsToKeep) ->get(); } $entities = []; foreach ($models as $model) { $entities[] = new TaskFileVersionEntity($model->toArray()); } return $entities; } /** * PaginationgetspecifiedFileVersionlist,  by Version number Descending.*/ public function getByFileIdWithPage(int $fileId, int $page, int $pageSize): array { $query = $this->model::query()->where('file_id', $fileId); // getTotal $total = $query->count(); // PaginationQuery $models = $query->orderBy('version', 'desc') ->skip(($page - 1) * $pageSize) ->take($pageSize) ->get(); // Convert toEntity $entities = []; foreach ($models as $model) { $entities[] = new TaskFileVersionEntity($model->toArray()); } return [ 'list' => $entities, 'total' => $total, ]; } /** * By/According toFileIDAndVersion number getspecificVersion.*/ public function getByFileIdAndVersion(int $fileId, int $version): ?TaskFileVersionEntity { $model = $this->model::query() ->where('file_id', $fileId) ->where('version', $version) ->first(); if (! $model) { return Null; } return new TaskFileVersionEntity($model->toArray()); } } 