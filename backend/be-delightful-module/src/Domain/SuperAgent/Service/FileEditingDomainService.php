<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperDelightful\Domain\SuperAgent\Service; use Hyperf\Redis\Redis; use Psr\Container\ContainerInterface; /** * FileEditStatusDomainService*/ class FileEditingDomainService { private const REDIS_KEY_PREFIX = 'file_editing_status'; private const TTL_SECONDS = 120; // 2Minute private Redis $redis; public function __construct(ContainerInterface $container) { $this->redis = $container->get(Redis::class); } /** * JoinEdit.*/ public function joinEditing(int $fileId, string $userId, string $organizationCode): void { $key = $this->buildRedisKey($fileId, $organizationCode); // adduser to Editlist $this->redis->sadd($key, $userId); $this->redis->expire($key, self::TTL_SECONDS); } /** * leaveEdit.*/ public function leaveEditing(int $fileId, string $userId, string $organizationCode): void { $key = $this->buildRedisKey($fileId, $organizationCode); // fromEditlist in removeuser $this->redis->srem($key, $userId); // IfNo/NoneuserinEdit, Deletewholekey if ($this->redis->scard($key) === 0) { $this->redis->del($key); } } /** * getEdituserQuantity.*/ public function getEditingUsersCount(int $fileId, string $organizationCode): int { $key = $this->buildRedisKey($fileId, $organizationCode); // ReturnEdituserQuantity return $this->redis->scard($key); } /** * BuildRedisKeyname.*/ public function buildRedisKey(int $fileId, string $organizationCode): string { return sprintf('%s:%s:%d', self::REDIS_KEY_PREFIX, $organizationCode, $fileId); } } 