<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperDelightful\Interfaces\SuperAgent\Facade; use App\Domain\Contact\Entity\ValueObject\DataIsolation; use App\Domain\Contact\Entity\ValueObject\UserType; use App\ErrorCode\AgentErrorCode; use App\ErrorCode\GenericErrorCode; use App\Infrastructure\Core\Exception\BusinessException; use App\Infrastructure\Core\Exception\ExceptionBuilder; use App\Infrastructure\Util\Context\CoContext; use App\Infrastructure\Util\Context\RequestContext; use Delightful\ApiResponse\Annotation\ApiResponse; use Delightful\SuperDelightful\Application\SuperAgent\Service\AgentAppService; use Delightful\SuperDelightful\Application\SuperAgent\Service\TopicAppService; use Delightful\SuperDelightful\Application\SuperAgent\Service\WorkspaceAppService; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Request\CheckpointRollbackCheckRequestDTO; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Request\CheckpointRollbackRequestDTO; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Request\CheckpointRollbackStartRequestDTO; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Request\DeleteTopicRequestDTO; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Request\DuplicateTopicCheckRequestDTO; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Request\DuplicateTopicRequestDTO; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Request\GetTopicAttachmentsRequestDTO; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Request\GetTopicMessagesByTopicIdRequestDTO; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Request\SaveTopicRequestDTO; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Response\CheckpointRollbackCheckResponseDTO; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Response\CheckpointRollbackResponseDTO; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Response\DuplicateTopicStatusResponseDTO; use Delightful\SuperDelightful\Interfaces\SuperAgent\DTO\Response\TopicMessagesResponseDTO; use Exception; use Hyperf\Contract\TranslatorInterface; use Hyperf\HttpServer\Contract\RequestInterface; use Qbhy\HyperfAuth\AuthManager; use Throwable; #[ApiResponse('low_code')] class TopicApi extends AbstractApi { public function __construct( protected RequestInterface $request, protected WorkspaceAppService $workspaceAppService, protected TopicAppService $topicAppService, protected TranslatorInterface $translator, protected AgentAppService $agentAppService, ) { parent::__construct($request); } /** * getTopicinformation. * @param mixed $id*/ public function getTopic(RequestContext $requestContext, $id): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); return $this->topicAppService->getTopic($requestContext, (int) $id)->toArray(); } /** * SaveTopic (Create orUpdate) * InterfaceLayer responsibleProcess/HandleHTTPRequestAndResponse,  not containingbusiness logic. * * @param RequestContext $requestContext request context * @return array OperationResult, containingTopicID * @throws BusinessException throws exception if parameters are invalid or operation fails * @throws Throwable*/ public function createTopic(RequestContext $requestContext): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); // fromRequestCreateDTO $requestDTO = SaveTopicRequestDTO::fromRequest($this->request); // callApplicationServiceLayer processingbusiness logic return $this->topicAppService->createTopic($requestContext, $requestDTO)->toArray(); } /** * SaveTopic (Create orUpdate) * InterfaceLayer responsibleProcess/HandleHTTPRequestAndResponse,  not containingbusiness logic. * * @param RequestContext $requestContext request context * @return array OperationResult, containingTopicID * @throws BusinessException throws exception if parameters are invalid or operation fails * @throws Throwable*/ public function updateTopic(RequestContext $requestContext, string $id): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); // fromRequestCreateDTO $requestDTO = SaveTopicRequestDTO::fromRequest($this->request); $requestDTO->id = $id; // callApplicationServiceLayer processingbusiness logic return $this->topicAppService->updateTopic($requestContext, $requestDTO)->toArray(); } /** * DeleteTopic (LogicDelete) * InterfaceLayer responsibleProcess/HandleHTTPRequestAndResponse,  not containingbusiness logic. * * @param RequestContext $requestContext request context * @return array OperationResult, containing be DeleteTopicID * @throws BusinessException throws exception if parameters are invalid or operation fails * @throws Exception*/ public function deleteTopic(RequestContext $requestContext): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); // fromRequestCreateDTO $requestDTO = DeleteTopicRequestDTO::fromRequest($this->request); // callApplicationServiceLayer processingbusiness logic return $this->topicAppService->deleteTopic($requestContext, $requestDTO)->toArray(); } /** * RenameTopic.*/ public function renameTopic(RequestContext $requestContext): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); // Topic id $authorization = $requestContext->getUserAuthorization(); $topicId = $this->request->input('id', 0); $userQuestion = $this->request->input('user_question', ''); $language = $this->translator->getLocale(); return $this->topicAppService->renameTopic($authorization, (int) $topicId, $userQuestion, $language); } /** * getTopicAttachmentlist.*/ public function getTopicAttachments(RequestContext $requestContext): array { // Use fromRequest methodfromRequestCreate in DTO,  this  kind CanfromroutingParameterget from topic_id $dto = GetTopicAttachmentsRequestDTO::fromRequest($this->request); if (! empty($dto->getToken())) { // gotokenChecksumLogic return $this->topicAppService->getTopicAttachmentsByAccessToken($dto); } // LoginuserUsage scenario $requestContext->setUserAuthorization(di(AuthManager::class)->guard(name: 'web')->user()); $userAuthorization = $requestContext->getUserAuthorization(); return $this->topicAppService->getTopicAttachments($userAuthorization, $dto); } /** * throughTopicIDgetMessagelist.x. * * @param RequestContext $requestContext request context * @return array MessagelistandPaginationinformation*/ public function getMessagesByTopicId(RequestContext $requestContext): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); // fromRequestCreateDTO $dto = GetTopicMessagesByTopicIdRequestDTO::fromRequest($this->request); // ChecksumTopicMessagewhether is self $topicItemDTO = $this->topicAppService->getTopic($requestContext, $dto->getTopicId()); if ($topicItemDTO->getUserId() !== $requestContext->getUserAuthorization()->getId()) { return ['list' => [], 'total' => 0]; } // callApplicationService $result = $this->workspaceAppService->getMessagesByTopicId( $dto->getTopicId(), $dto->getPage(), $dto->getPageSize(), $dto->getSortDirection() ); // BuildResponse $response = new TopicMessagesResponseDTO($result['list'], $result['total']); return $response->toArray(); } /** * RollbackSandbox to specifiedcheckpoint. * * @param RequestContext $requestContext request context * @param string $id TopicID * @return array RollbackResult*/ #[ApiResponse('low_code')] public function rollbackCheckpoint(RequestContext $requestContext, string $id): array { $requestContext->setUserAuthorization($this->getAuthorization()); $requestDTO = CheckpointRollbackRequestDTO::fromRequest($this->request); $topicId = $id; $targetMessageId = $requestDTO->getTargetMessageId(); if (empty($topicId)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'topic_id is required'); } if (empty($targetMessageId)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'target_message_id is required'); } $authorization = $this->getAuthorization(); $dataIsolation = new DataIsolation(); $dataIsolation->setCurrentUserId((string) $authorization->getId()); $dataIsolation->setThirdPartyOrganizationCode($authorization->getOrganizationCode()); $dataIsolation->setCurrentOrganizationCode($authorization->getOrganizationCode()); $dataIsolation->setUserType(UserType::Human); $dataIsolation->setLanguage(CoContext::getLanguage()); $sandboxId = $this->agentAppService->ensureSandboxInitialized($dataIsolation, (int) $topicId); $result = $this->agentAppService->rollbackCheckpoint($sandboxId, $targetMessageId); if (! $result->isSuccess()) { ExceptionBuilder::throw(AgentErrorCode::SANDBOX_NOT_FOUND, $result->getMessage()); } $responseDTO = new CheckpointRollbackResponseDTO(); $responseDTO->setTargetMessageId($targetMessageId); $responseDTO->setMessage($result->getMessage()); return $responseDTO->toArray(); } /** * StartRollbackSandbox to specifiedcheckpoint (MarkStatusandNonDelete). * * @param RequestContext $requestContext request context * @param string $id TopicID * @return array RollbackResult*/ #[ApiResponse('low_code')] public function rollbackCheckpointStart(RequestContext $requestContext, string $id): array { $requestContext->setUserAuthorization($this->getAuthorization()); $requestDTO = CheckpointRollbackStartRequestDTO::fromRequest($this->request); $topicId = $id; $targetMessageId = $requestDTO->getTargetMessageId(); if (empty($topicId)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'topic_id is required'); } if (empty($targetMessageId)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'target_message_id is required'); } $authorization = $this->getAuthorization(); $dataIsolation = new DataIsolation(); $dataIsolation->setCurrentUserId((string) $authorization->getId()); $dataIsolation->setThirdPartyOrganizationCode($authorization->getOrganizationCode()); $dataIsolation->setCurrentOrganizationCode($authorization->getOrganizationCode()); $dataIsolation->setUserType(UserType::Human); $dataIsolation->setLanguage(CoContext::getLanguage()); // callApplicationServicelayerrollbackCheckpointStartmethod $this->agentAppService->rollbackCheckpointStart($dataIsolation, (int) $topicId, $targetMessageId); return []; } /** * SubmitRollbackSandbox to specifiedcheckpoint (PhysicalDeleteWithdrawStatusMessage). * * @param RequestContext $requestContext request context * @param string $id TopicID * @return array SubmitResult*/ #[ApiResponse('low_code')] public function rollbackCheckpointCommit(RequestContext $requestContext, string $id): array { $requestContext->setUserAuthorization($this->getAuthorization()); $topicId = $id; if (empty($topicId)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'topic_id is required'); } $authorization = $this->getAuthorization(); // CreateDataIsolationObject $dataIsolation = new DataIsolation(); $dataIsolation->setCurrentUserId((string) $authorization->getId()); $dataIsolation->setThirdPartyOrganizationCode($authorization->getOrganizationCode()); $dataIsolation->setCurrentOrganizationCode($authorization->getOrganizationCode()); $dataIsolation->setUserType(UserType::Human); $dataIsolation->setLanguage(CoContext::getLanguage()); // callApplicationServicelayerrollbackCheckpointCommitmethod $this->agentAppService->rollbackCheckpointCommit($dataIsolation, (int) $topicId); return []; } /** * RevokeRollbackSandboxcheckpoint (ConvertWithdrawStatusMessageRestore toNormalStatus). * * @param RequestContext $requestContext request context * @param string $id TopicID * @return array RevokeResult*/ #[ApiResponse('low_code')] public function rollbackCheckpointUndo(RequestContext $requestContext, string $id): array { $requestContext->setUserAuthorization($this->getAuthorization()); $topicId = $id; if (empty($topicId)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'topic_id is required'); } $authorization = $this->getAuthorization(); // CreateDataIsolationObject $dataIsolation = new DataIsolation(); $dataIsolation->setCurrentUserId((string) $authorization->getId()); $dataIsolation->setThirdPartyOrganizationCode($authorization->getOrganizationCode()); $dataIsolation->setCurrentOrganizationCode($authorization->getOrganizationCode()); $dataIsolation->setUserType(UserType::Human); $dataIsolation->setLanguage(CoContext::getLanguage()); // callApplicationServicelayerrollbackCheckpointUndomethod $this->agentAppService->rollbackCheckpointUndo($dataIsolation, (int) $topicId); return []; } /** * CheckRollbackSandbox to specifiedcheckpointcanRowproperty. * * @param RequestContext $requestContext request context * @param string $id TopicID * @return array CheckResult*/ #[ApiResponse('low_code')] public function rollbackCheckpointCheck(RequestContext $requestContext, string $id): array { $requestContext->setUserAuthorization($this->getAuthorization()); $requestDTO = CheckpointRollbackCheckRequestDTO::fromRequest($this->request); $topicId = $id; $targetMessageId = $requestDTO->getTargetMessageId(); if (empty($topicId)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'topic_id is required'); } if (empty($targetMessageId)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'target_message_id is required'); } $authorization = $this->getAuthorization(); $dataIsolation = new DataIsolation(); $dataIsolation->setCurrentUserId((string) $authorization->getId()); $dataIsolation->setThirdPartyOrganizationCode($authorization->getOrganizationCode()); $dataIsolation->setCurrentOrganizationCode($authorization->getOrganizationCode()); $dataIsolation->setUserType(UserType::Human); $dataIsolation->setLanguage(CoContext::getLanguage()); $result = $this->agentAppService->rollbackCheckpointCheck($dataIsolation, (int) $topicId, $targetMessageId); if (! $result->isSuccess()) { ExceptionBuilder::throw(AgentErrorCode::SANDBOX_NOT_FOUND, $result->getMessage()); } $responseDTO = new CheckpointRollbackCheckResponseDTO(); $responseDTO->setCanRollback((bool) $result->getDataValue('can_rollback', false)); return $responseDTO->toArray(); } /** * Duplicate topic (synchronous) - blocks until completion. * * @param RequestContext $requestContext Request context * @param string $id Source topic ID * @return array Complete result with topic info * @throws BusinessException If validation fails or operation fails */ #[ApiResponse('low_code')] public function duplicateChat(RequestContext $requestContext, string $id): array { // Set user authorization $requestContext->setUserAuthorization($this->getAuthorization()); // Get request DTO $dto = DuplicateTopicRequestDTO::fromRequest($this->request); // Call synchronous method return $this->topicAppService->duplicateTopic($requestContext, $id, $dto); } /** * Duplicate topic (asynchronous) - returns immediately with task_id. * * @param RequestContext $requestContext Request context * @param string $id Source topic ID * @return array Task info with task_id * @throws BusinessException If validation fails or operation fails */ #[ApiResponse('low_code')] public function duplicateChatAsync(RequestContext $requestContext, string $id): array { // Set user authorization $requestContext->setUserAuthorization($this->getAuthorization()); // Get request DTO $dto = DuplicateTopicRequestDTO::fromRequest($this->request); // Call asynchronous method return $this->topicAppService->duplicateChatAsync($requestContext, $id, $dto); } /** * Check topic duplication status. * * @param RequestContext $requestContext Request context * @param string $id Source topic ID * @return array Duplication status info * @throws BusinessException If validation fails or operation fails */ #[ApiResponse('low_code')] public function duplicateChatCheck(RequestContext $requestContext, string $id): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); $userAuthorization = $requestContext->getUserAuthorization(); // getRequestDTO $dto = DuplicateTopicCheckRequestDTO::fromRequest($this->request); try { // callApplicationService $result = $this->topicAppService->checkDuplicateChatStatus($requestContext, $dto->getTaskKey()); $responseDTO = DuplicateTopicStatusResponseDTO::fromArray($result); return $responseDTO->toArray(); } catch (Throwable $e) { // TODO: addErrorLogRecord throw $e; } } } 