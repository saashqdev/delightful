<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Domain\BeAgent\Repository\Facade; use Delightful\BeDelightful\Domain\BeAgent\Entity\MessageQueueEntity; use Delightful\BeDelightful\Domain\BeAgent\Entity\ValueObject\MessageQueueStatus; interface MessageQueueRepositoryInterface { /** * Create message queue. */ public function create(MessageQueueEntity $messageQueue): MessageQueueEntity; /** * Update message queue. */ public function update(MessageQueueEntity $messageQueue): bool; /** * Delete message queue (soft delete). */ public function delete(int $id, string $userId): bool; /** * Get pending messages by topic ID. * * @param int $topicId Topic ID * @param string $userId User ID * @return MessageQueueEntity[] */ public function getPendingMessagesByTopic(int $topicId, string $userId): array; /** * Get message queue by ID. */ public function getById(int $id): ?MessageQueueEntity; /** * Get message queue by ID for specific user. */ public function getByIdForUser(int $id, string $userId): ?MessageQueueEntity; /** * Update message status. */ public function updateStatus(int $id, MessageQueueStatus $status, ?string $errorMessage = Null): bool; /** * Get messages with status filter. * * @param array $conditions Query conditions * @param MessageQueueStatus[] $statuses Status array to filter * @param bool $needPagination Whether to use pagination * @param int $pageSize Page size * @param int $page Page number * @return array{list: MessageQueueEntity[], total: int} */ public function getMessagesByStatuses( array $conditions = [], array $statuses = [], bool $needPagination = true, int $pageSize = 10, int $page = 1, string $orderBy = 'id', string $order = 'asc' ): array; /** * Get next pending message for consumption. */ public function getNextPendingMessage(string $userId, ?int $topicId = Null): ?MessageQueueEntity; /** * Update message with conditions (for status changes with concurrency control). */ public function updateWithConditions(int $id, array $data, array $conditions = []): bool; /** * Get topic IDs that have pending messages for compensation. * get have pendingProcess/HandleMessageTopicIDlist, Used forCompensationProcess/Handle. * * @param int $limit Maximum number of topics to return * @param array $organizationCodes Organization codes filter (empty array means all organizations) * @return array Array of topic IDs*/ public function getCompensationTopics(int $limit, array $organizationCodes = []): array; /** * Get earliest pending message for specific topic. * getspecifiedTopic most earlypendingProcess/HandleMessage. * * @param int $topicId Topic ID * @param Null|string $maxExecuteTime Max execute time filter (optional, if Null then no time filter applied) * @return Null|MessageQueueEntity Earliest pending message or Null if none found*/ public function getEarliestMessageByTopic(int $topicId, ?string $maxExecuteTime = Null): ?MessageQueueEntity; /** * Delay execution time for all pending messages in a topic. * DelayTopic next AllpendingProcess/HandleMessageExecuteTime. * * @param int $topicId Topic ID * @param int $delayMinutes Delay time in minutes * @return bool True if any messages were updated, false otherwise*/ public function delayTopicMessages(int $topicId, int $delayMinutes): bool; } 