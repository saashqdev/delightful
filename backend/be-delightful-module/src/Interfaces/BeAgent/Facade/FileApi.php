<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Interfaces\BeAgent\Facade; use App\ErrorCode\GenericErrorCode; use App\Infrastructure\Core\Exception\BusinessException; use App\Infrastructure\Core\Exception\ExceptionBuilder; use App\Infrastructure\Util\Context\RequestContext; use Delightful\ApiResponse\Annotation\ApiResponse; use Delightful\BeDelightful\Application\BeAgent\Service\AgentFileAppService; use Delightful\BeDelightful\Application\BeAgent\Service\FileBatchAppService; use Delightful\BeDelightful\Application\BeAgent\Service\FileManagementAppService; use Delightful\BeDelightful\Application\BeAgent\Service\FileProcessAppService; use Delightful\BeDelightful\Application\BeAgent\Service\FileVersionAppService; use Delightful\BeDelightful\Application\BeAgent\Service\SandboxFileNotificationAppService; use Delightful\BeDelightful\Application\BeAgent\Service\WorkspaceAppService; use Delightful\BeDelightful\ErrorCode\BeAgentErrorCode; use Delightful\BeDelightful\Infrastructure\Utils\WorkFileUtil; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\BatchCopyFileRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\BatchDeleteFilesRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\BatchMoveFileRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\BatchSaveFileContentRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\BatchSaveProjectFilesRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\CheckBatchOperationStatusRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\CopyFileRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\CreateBatchDownloadRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\CreateFileRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\DeleteDirectoryRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\GetFileUrlsRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\GetFileVersionsRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\MoveFileRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\ProjectUploadTokenRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\RefreshStsTokenRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\ReplaceFileRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\RollbackFileToVersionRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\SandboxFileNotificationRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\SaveProjectFileRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\TopicUploadTokenRequestDTO; use Delightful\BeDelightful\Interfaces\BeAgent\DTO\Request\WorkspaceAttachmentsRequestDTO; use Hyperf\HttpServer\Contract\RequestInterface; use Hyperf\RateLimit\Annotation\RateLimit; use Qbhy\HyperfAuth\AuthManager; #[ApiResponse('low_code')] class FileApi extends AbstractApi { public function __construct( private readonly FileProcessAppService $fileProcessAppService, private readonly FileBatchAppService $fileBatchAppService, private readonly FileManagementAppService $fileManagementAppService, private readonly FileVersionAppService $fileVersionAppService, protected WorkspaceAppService $workspaceAppService, protected RequestInterface $request, protected AgentFileAppService $agentFileAppService, private readonly SandboxFileNotificationAppService $sandboxFileNotificationAppService, ) { parent::__construct($request); } /** * BatchProcess/HandleAttachment, By/According tofileKeyCheckwhether store in,  store inThen skip, Does not existin then Save. * Only need to providetask_idAndattachmentsParameter,OtherParameterConvertfromTaskAutomatically inget. * * @param RequestContext $requestContext request context * @return array Process/HandleResult*/ public function processAttachments(RequestContext $requestContext): array { // getRequestParameter $attachments = $this->request->input('attachments', []); $sandboxId = (string) $this->request->input('sandbox_id', ''); $organizationCode = $this->request->input('organization_code', ''); // ParameterValidate if (empty($attachments)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'file.attachments_required'); } if (empty($sandboxId)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'file.sandbox_id_required'); } if (empty($organizationCode)) { // IfNo/NoneProvideOrganization code,Then usedefaultValue $organizationCode = 'default'; } // callApplicationServiceProcess/HandleAttachment,Passed inNull let ServicelayerAutogettopic_id return $this->fileProcessAppService->processAttachmentsArray( $attachments, $sandboxId, $organizationCode, Null // Not passed intopic_id, let ServicelayerBy/According totaskIdAutoGet ); } /** * Refresh STS Token. * * @param RequestContext $requestContext request context * @return array RefreshResult*/ public function refreshStsToken(RequestContext $requestContext): array { $token = $this->request->header('token', ''); if (empty($token)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'token_required'); } if ($token !== config('be-delightful.sandbox.token', '')) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'token_invalid'); } // CreateDTOAndfromRequestParse inData $requestData = $this->request->all(); $refreshStsTokenDTO = RefreshStsTokenRequestDTO::fromRequest($requestData); return $this->fileProcessAppService->refreshStsToken($refreshStsTokenDTO); } /** * Refresh STS Token. * * @param RequestContext $requestContext request context * @return array RefreshResult*/ public function refreshTmpStsToken(RequestContext $requestContext): array { $token = $this->request->header('token', ''); if (empty($token)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'token_required'); } if ($token !== config('be-delightful.sandbox.token', '')) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'token_invalid'); } // CreateDTOAndfromRequestParse inData $requestData = $this->request->all(); $refreshStsTokenDTO = RefreshStsTokenRequestDTO::fromRequest($requestData); return $this->fileProcessAppService->refreshStsToken($refreshStsTokenDTO); } public function workspaceAttachments(RequestContext $requestContext): array { // $topicId = $this->request->input('topic_id', ''); // $commitHash = $this->request->input('commit_hash', ''); // $sandboxId = $this->request->input('sandbox_id', ''); // $folder = $this->request->input('folder', ''); // $dir = $this->request->input('dir', ''); $requestDTO = new WorkspaceAttachmentsRequestDTO(); $requestDTO = $requestDTO->fromRequest($this->request); if (empty($requestDTO->getTopicId())) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'topic_id_required'); } if (empty($requestDTO->getCommitHash())) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'commit_hash_required'); } if (empty($requestDTO->getSandboxId())) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'sandbox_id_required'); } if (empty($requestDTO->getDir())) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'dir_required'); } if (empty($requestDTO->getFolder())) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'folder_required'); } return $this->fileProcessAppService->workspaceAttachments($requestDTO); } /** * BatchSaveFileContent. * ConcurrentExecuteSandboxFileEditAndOSSSave. * * @param RequestContext $requestContext request context * @return array BatchSaveResult*/ public function saveFileContent(RequestContext $requestContext): array { $requestData = $this->request->all(); if (empty($requestData)) { ExceptionBuilder::throw(GenericErrorCode::ParameterValidationFailed, 'files_array_required'); } $requestContext->setUserAuthorization($this->getAuthorization()); $userAuthorization = $requestContext->getUserAuthorization(); $batchSaveDTO = BatchSaveFileContentRequestDTO::fromRequest($requestData); return $this->fileProcessAppService->batchSaveFileContent($batchSaveDTO, $userAuthorization); } public function deleteFile(RequestContext $requestContext, string $id): array { $requestContext->setUserAuthorization($this->getAuthorization()); return $this->fileManagementAppService->deleteFile($requestContext, (int) $id); } public function deleteDirectory(RequestContext $requestContext): array { $requestContext->setUserAuthorization($this->getAuthorization()); // getRequestDataAndCreateDTO $requestDTO = DeleteDirectoryRequestDTO::fromRequest($this->request); // callApplicationService return $this->fileManagementAppService->deleteDirectory($requestContext, $requestDTO); } public function batchDeleteFiles(RequestContext $requestContext): array { $requestContext->setUserAuthorization($this->getAuthorization()); // getRequestDataAndCreateDTO $requestDTO = BatchDeleteFilesRequestDTO::fromRequest($this->request); // callApplicationService return $this->fileManagementAppService->batchDeleteFiles($requestContext, $requestDTO); } public function renameFile(RequestContext $requestContext, string $id): array { $requestContext->setUserAuthorization($this->getAuthorization()); $targetName = $this->request->input('target_name', ''); // Validate target_name parameter using WorkFileUtil if (! WorkFileUtil::isValidFileName($targetName)) { ExceptionBuilder::throw(BeAgentErrorCode::FILE_ILLEGAL_NAME, 'file.illegal_file_name'); } return $this->fileManagementAppService->renameFile($requestContext, (int) $id, $targetName); } public function moveFile(RequestContext $requestContext, string $id): array { $requestContext->setUserAuthorization($this->getAuthorization()); // Get request data and create DTO $requestDTO = MoveFileRequestDTO::fromRequest($this->request); return $this->fileManagementAppService->moveFile( $requestContext, (int) $id, (int) $requestDTO->getTargetParentId(), (int) $requestDTO->getPreFileId(), ! empty($requestDTO->getTargetProjectId()) ? (int) $requestDTO->getTargetProjectId() : Null, $requestDTO->getKeepBothFileIds() ); } public function batchMoveFile(RequestContext $requestContext): array { $requestContext->setUserAuthorization($this->getAuthorization()); // Get request data and create DTO $requestDTO = BatchMoveFileRequestDTO::fromRequest($this->request); // Call application service return $this->fileManagementAppService->batchMoveFile($requestContext, $requestDTO); } public function batchCopyFile(RequestContext $requestContext): array { $requestContext->setUserAuthorization($this->getAuthorization()); // Get request data and create DTO $requestDTO = BatchCopyFileRequestDTO::fromRequest($this->request); // Call application service return $this->fileManagementAppService->batchCopyFile($requestContext, $requestDTO); } public function copyFile(RequestContext $requestContext, string $id): array { $requestContext->setUserAuthorization($this->getAuthorization()); // Get request data and create DTO $requestDTO = CopyFileRequestDTO::fromRequest($this->request); return $this->fileManagementAppService->copyFile( $requestContext, (int) $id, (int) $requestDTO->getTargetParentId(), (int) $requestDTO->getPreFileId(), ! empty($requestDTO->getTargetProjectId()) ? (int) $requestDTO->getTargetProjectId() : Null, $requestDTO->getKeepBothFileIds() ); } /** * Create batch download task. * * @param RequestContext $requestContext Request context * @return array Create result */ #[RateLimit(create: 3, capacity: 3, key: 'batch_download_create')] public function createBatchDownload(RequestContext $requestContext): array { // Set user authorization info $requestContext->setUserAuthorization($this->getAuthorization()); // Get request data and create DTO $requestData = $this->request->all(); $requestDTO = CreateBatchDownloadRequestDTO::fromRequest($requestData); // Call application service $responseDTO = $this->fileBatchAppService->createBatchDownload($requestContext, $requestDTO); return $responseDTO->toArray(); } /** * Check batch download status. * * @param RequestContext $requestContext Request context * @return array Query result */ #[RateLimit(create: 30, capacity: 30, key: 'batch_download_check')] public function checkBatchDownload(RequestContext $requestContext): array { // Set user authorization info $requestContext->setUserAuthorization($this->getAuthorization()); // Get batch key from request $batchKey = (string) $this->request->input('batch_key', ''); if (empty($batchKey)) { ExceptionBuilder::throw(GenericErrorCode::ParameterMissing, 'batch_key_required'); } // Call application service $responseDTO = $this->fileBatchAppService->checkBatchDownload($requestContext, $batchKey); return $responseDTO->toArray(); } /** * Check batch operation status. * * @param RequestContext $requestContext Request context * @return array Query result */ #[RateLimit(create: 30, capacity: 30, key: 'batch_operation_check')] public function checkBatchOperationStatus(RequestContext $requestContext): array { // Set user authorization info $requestContext->setUserAuthorization($this->getAuthorization()); // Get request data and create DTO $requestDTO = CheckBatchOperationStatusRequestDTO::fromRequest($this->request); // Call application service $responseDTO = $this->fileManagementAppService->checkBatchOperationStatus($requestContext, $requestDTO); return $responseDTO->toArray(); } /** * getProjectFileUploadSTS Token. * * @param RequestContext $requestContext request context * @return array getResult*/ public function getProjectUploadToken(RequestContext $requestContext): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); // getRequestDataAndCreateDTO $requestData = $this->request->all(); $requestDTO = ProjectUploadTokenRequestDTO::fromRequest($requestData); // callApplicationService return $this->fileManagementAppService->getProjectUploadToken($requestContext, $requestDTO); } /** * getTopicFileUploadSTS Token. * * @param RequestContext $requestContext request context * @return array getResult*/ public function getTopicUploadToken(RequestContext $requestContext): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); // getRequestDataAndCreateDTO $requestData = $this->request->all(); $requestDTO = TopicUploadTokenRequestDTO::fromRequest($requestData); // callApplicationService return $this->fileManagementAppService->getTopicUploadToken($requestContext, $requestDTO); } /** * CreateFile or Folder. * * @param RequestContext $requestContext request context * @return array CreateResult*/ public function createFile(RequestContext $requestContext): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); // getRequestDataAndCreateDTO $requestDTO = CreateFileRequestDTO::fromRequest($this->request); // callApplicationService return $this->fileManagementAppService->createFile($requestContext, $requestDTO); } /** * SaveProjectFile. * * @param RequestContext $requestContext request context * @return array SaveResult*/ public function saveProjectFile(RequestContext $requestContext): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); // getRequestDataAndCreateDTO $requestData = $this->request->all(); $requestDTO = SaveProjectFileRequestDTO::fromRequest($requestData); // callApplicationService return $this->fileManagementAppService->saveFile($requestContext, $requestDTO); } /** * BatchSaveProjectFile. * * @param RequestContext $requestContext request context * @return array BatchSaveResult, ReturnFileIDArray*/ public function batchSaveProjectFiles(RequestContext $requestContext): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); // getRequestDataAndCreateDTO $requestDTO = BatchSaveProjectFilesRequestDTO::fromRequest($this->request); // callApplicationService return $this->fileManagementAppService->batchSaveFiles($requestContext, $requestDTO); } /** * Handle sandbox file notification. * This endpoint doesn't require user authentication, uses token-based auth instead. * * @param RequestContext $requestContext Request context * @return array Response data */ public function handleSandboxNotification(RequestContext $requestContext): array { // Create DTO from request $requestDTO = SandboxFileNotificationRequestDTO::fromRequest($this->request); // Call application service without user context return $this->sandboxFileNotificationAppService->handleNotificationWithoutAuth($requestDTO); } /** * Get file name by file ID. * * @param int $id File ID * @return array File name response */ public function getFileByName(int $id): array { // Call app service to get file name return $this->fileProcessAppService->getFileNameById($id); } /** * Get file basic information by file ID. * * @param int $id File ID * @return array File basic information response (file name, current version, Organization code) */ public function getFileInfo(int $id): array { // Call app service to get file basic information return $this->fileProcessAppService->getFileInfoById($id); } /** * getFileVersionlist. * * @param RequestContext $requestContext request context * @param string $id FileID * @return array FileVersionlist*/ public function getFileVersions(RequestContext $requestContext, string $id): array { // set user authorization information $requestContext->setUserAuthorization($this->getAuthorization()); // getPleaserequireDataAndCreateDTO $requestDTO = GetFileVersionsRequestDTO::fromRequest($this->request); $requestDTO->setFileId((int) $id); // From routeParameterSettingsFileID // callApplicationService $responseDTO = $this->fileVersionAppService->getFileVersions($requestContext, $requestDTO); return $responseDTO->toArray(); } /** * FileRollback tospecifiedVersion. * * @param RequestContext $requestContext request context * @param string $id FileID * @return array RollbackResult*/ public function rollbackFileToVersion(RequestContext $requestContext, string $id): array { $requestContext->setUserAuthorization($this->getAuthorization()); $requestDTO = RollbackFileToVersionRequestDTO::fromRequest($this->request); $requestDTO->setFileId((int) $id); $responseDTO = $this->fileVersionAppService->rollbackFileToVersion($requestContext, $requestDTO); return $responseDTO->toArray(); } /** * getFileURLlist. * * @param RequestContext $requestContext request context * @return array FileURLlist * @throws BusinessException IfParameterInvalidThen throwAbnormal*/ public function getFileUrls(RequestContext $requestContext): array { // getPleaserequireDTO $dto = GetFileUrlsRequestDTO::fromRequest($this->request); if (! empty($dto->getToken())) { // gotokenChecksumLogic return $this->fileManagementAppService->getFileUrlsByAccessToken( $dto->getFileIds(), $dto->getToken(), $dto->getDownloadMode(), $dto->getFileVersions() ); } // set user authorization information $requestContext->setUserAuthorization(di(AuthManager::class)->guard(name: 'web')->user()); // BuildoptionsParameter $options = []; $options['cache'] = false; // callApplicationService return $this->fileManagementAppService->getFileUrls( $requestContext, $dto->getProjectId(), $dto->getFileIds(), $dto->getDownloadMode(), $options, $dto->getFileVersions() // Add newï¼šdirectlyAsmethodParameterPass ); } /** * Replace file with new file. * * @param RequestContext $requestContext Request context * @return array Replaced file information */ public function replaceFile(RequestContext $requestContext): array { $requestContext->setUserAuthorization($this->getAuthorization()); $fileId = (int) $this->request->route('id'); $requestDTO = ReplaceFileRequestDTO::fromRequest($this->request); return $this->fileManagementAppService->replaceFile($requestContext, $fileId, $requestDTO); } } 
