<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperMagic\Domain\SuperAgent\Entity; use App\Infrastructure\Core\AbstractEntity; use App\Infrastructure\Util\IdGenerator\IdGenerator; use Dtyq\SuperMagic\Application\SuperAgent\DTO\TaskMessageDTO; use Hyperf\Codec\Json; class TaskMessageEntity extends AbstractEntity { // Process/HandleStatusconstant amount  public const PROCESSING_STATUS_PENDING = 'pending'; public const PROCESSING_STATUS_PROCESSING = 'processing'; public const PROCESSING_STATUS_COMPLETED = 'completed'; public const PROCESSING_STATUS_FAILED = 'failed'; /** * @var int MessageID*/ protected int $id = 0; /** * @var string SenderType(user/ai)*/ protected string $senderType = ''; /** * @var string SenderID*/ protected string $senderUid = ''; /** * @var string ReceiverID*/ protected string $receiverUid = ''; /** * @var string MessageID*/ protected string $messageId = ''; /** * @var string MessageType*/ protected string $type = ''; /** * @var string TaskID*/ protected string $taskId = ''; /** * @var Null|int|string TopicID*/ protected $topicId; /** * @var Null|string TaskStatus*/ protected ?string $status = Null; /** * @var string MessageContent*/ protected string $content = ''; /** * @var Null|string OriginalMessageContent*/ protected ?string $rawContent = Null; /** * @var Null|array Stepinformation*/ protected ?array $steps = Null; /** * @var Null|array Toolcallinformation*/ protected ?array $tool = Null; /** * @var Null|array Attachmentinformation*/ protected ?array $attachments = Null; /** * @var Null|array Mentioninformation*/ protected ?array $mentions = Null; /** * @var string EventType*/ protected string $event = ''; /** * @var int SendTimetimestamp*/ protected int $sendTimestamp = 0; protected bool $showInUi = true; /** * @var Null|string Original deliveryMessageJSONData*/ protected ?string $rawData = Null; /** * @var Null|int SequenceID, Used forMessageSort*/ protected ?int $seqId = Null; /** * @var string MessageProcess/HandleStatus*/ protected string $processingStatus = self::PROCESSING_STATUS_PENDING; /** * @var Null|string Process/HandleFailed time Errorinformation*/ protected ?string $errorMessage = Null; /** * @var int Retry times  count */ protected int $retryCount = 0; /** * @var Null|string Process/HandleCompleteTime*/ protected ?string $processedAt = Null; /** * @var Null|int IM SequenceID, Used forMessageSequentialtrace*/ protected ?int $imSeqId = Null; /** * @var Null|int IM Status (frommagic_chat_sequencesTablestatusfield)*/ protected ?int $imStatus = Null; /** * @var Null|string associatedID, Used forMessagetraceAndassociated*/ protected ?string $correlationId = Null; /** * @var Null|array Usage information (only set when task is finished) */ protected ?array $usage = Null; public function __construct(array $data = []) { $this->id = IdGenerator::getSnowId(); $this->messageId = isset($data['message_id']) ? (string) $data['message_id'] : (string) IdGenerator::getSnowId(); $this->sendTimestamp = time(); parent::__construct($data); } public function getId(): int { return $this->id; } public function setId(int $id): self { $this->id = $id; return $this; } public function getSenderType(): string { return $this->senderType; } public function setSenderType(?string $senderType): self { $this->senderType = $senderType ?? ''; return $this; } public function getSenderUid(): string { return $this->senderUid; } public function setSenderUid(?string $senderUid): self { $this->senderUid = $senderUid ?? ''; return $this; } public function getReceiverUid(): string { return $this->receiverUid; } public function setReceiverUid(?string $receiverUid): self { $this->receiverUid = $receiverUid ?? ''; return $this; } public function setMessageId(string $messageId): self { $this->messageId = $messageId; return $this; } public function getMessageId(): string { return $this->messageId; } public function getType(): string { return $this->type; } public function setType(?string $type): self { $this->type = $type ?? ''; return $this; } public function getTaskId(): string { return $this->taskId; } public function setTaskId(?string $taskId): self { $this->taskId = $taskId ?? ''; return $this; } public function getTopicId() { return $this->topicId; } public function setTopicId($topicId): self { $this->topicId = $topicId; return $this; } public function getStatus(): ?string { return $this->status; } public function setStatus(?string $status): self { $this->status = $status; return $this; } public function getContent(): string { return $this->content; } public function setContent(?string $content): self { $this->content = $content ?? ''; return $this; } public function getRawContent(): string { return $this->rawContent ?? ''; } public function setRawContent(?string $rawContent): self { $this->rawContent = $rawContent; return $this; } public function getSteps(): ?array { return $this->steps; } public function setSteps(Null|array|string $steps): self { if (is_string($steps)) { if (! empty($steps) && json_validate($steps)) { $steps = Json::decode($steps); } else { $steps = Null; } } $this->steps = empty($steps) ? Null : $steps; return $this; } public function getTool(): ?array { return $this->tool; } public function setTool(Null|array|string $tool): self { if (is_string($tool)) { if (! empty($tool) && json_validate($tool)) { $tool = Json::decode($tool); } else { $tool = Null; } } $this->tool = empty($tool) ? Null : $tool; return $this; } public function getAttachments(): ?array { return $this->attachments; } public function setAttachments(Null|array|string $attachments): self { if (is_string($attachments)) { if (! empty($attachments) && json_validate($attachments)) { $attachments = Json::decode($attachments); } else { $attachments = Null; } } $this->attachments = empty($attachments) ? Null : $attachments; return $this; } public function getMentions(): ?array { return $this->mentions; } public function setMentions(Null|array|string $mentions): self { if (is_string($mentions)) { if (! empty($mentions) && json_validate($mentions)) { $mentions = Json::decode($mentions); } else { // Invalid JSON String or EmptyString, setFor Null $mentions = Null; } } $this->mentions = empty($mentions) ? Null : $mentions; return $this; } public function getEvent(): string { return $this->event; } public function setEvent(?string $event): self { $this->event = $event ?? ''; return $this; } public function getSendTimestamp(): int { return $this->sendTimestamp; } public function getShowInUi(): bool { return $this->showInUi; } public function setShowInUi(bool|int $showInUi): self { $this->showInUi = (bool) $showInUi; return $this; } public function getRawData(): ?string { return $this->rawData; } public function setRawData(?string $rawData): self { $this->rawData = $rawData; return $this; } public function getSeqId(): ?int { return $this->seqId; } public function setSeqId(Null|int|string $seqId): self { $this->seqId = $seqId !== Null ? (int) $seqId : Null; return $this; } public function getProcessingStatus(): string { return $this->processingStatus; } public function setProcessingStatus(string $processingStatus): self { $this->processingStatus = $processingStatus; return $this; } public function getErrorMessage(): ?string { return $this->errorMessage; } public function setErrorMessage(?string $errorMessage): self { $this->errorMessage = $errorMessage; return $this; } public function getRetryCount(): int { return $this->retryCount; } public function setRetryCount(int|string $retryCount): self { $this->retryCount = (int) $retryCount; return $this; } public function getProcessedAt(): ?string { return $this->processedAt; } public function setProcessedAt(?string $processedAt): self { $this->processedAt = $processedAt; return $this; } public function getImSeqId(): ?int { return $this->imSeqId; } public function setImSeqId(Null|int|string $imSeqId): self { $this->imSeqId = $imSeqId !== Null ? (int) $imSeqId : Null; return $this; } public function getImStatus(): ?int { return $this->imStatus; } public function setImStatus(Null|int|string $imStatus): self { $this->imStatus = $imStatus !== Null ? (int) $imStatus : Null; return $this; } public function getCorrelationId(): ?string { return $this->correlationId; } public function setCorrelationId(?string $correlationId): self { $this->correlationId = $correlationId; return $this; } public function getUsage(): ?array { return $this->usage; } public function setUsage(?array $usage): self { $this->usage = $usage; return $this; } public function toArray(): array { $result = [ 'id' => $this->id, 'sender_type' => $this->senderType, 'sender_uid' => $this->senderUid, 'receiver_uid' => $this->receiverUid, 'message_id' => $this->messageId, 'type' => $this->type, 'task_id' => $this->taskId, 'topic_id' => $this->topicId, 'status' => $this->status, 'content' => $this->content, 'raw_content' => $this->rawContent, 'steps' => $this->getSteps(), 'tool' => $this->getTool(), 'attachments' => $this->getAttachments(), 'mentions' => $this->getMentions(), 'event' => $this->event, 'send_timestamp' => $this->sendTimestamp, 'show_in_ui' => $this->showInUi, // Add newQueueProcess/Handlefield 'raw_data' => $this->rawData, 'seq_id' => $this->seqId, 'processing_status' => $this->processingStatus, 'error_message' => $this->errorMessage, 'retry_count' => $this->retryCount, 'processed_at' => $this->processedAt, 'im_seq_id' => $this->imSeqId, 'im_status' => $this->imStatus, 'correlation_id' => $this->correlationId, 'usage' => $this->usage, ]; return array_filter($result, function ($value) { return $value !== Null; }); } public function toArrayWithoutOtherField(): array { return [ 'id' => $this->id, 'sender_type' => $this->senderType, 'sender_uid' => $this->senderUid, 'receiver_uid' => $this->receiverUid, 'message_id' => $this->messageId, 'type' => $this->type, 'task_id' => $this->taskId, 'topic_id' => $this->topicId, 'status' => $this->status, 'content' => $this->content, 'raw_content' => $this->rawContent ?? '', 'steps' => $this->getSteps() !== Null ? json_encode($this->getSteps(), JSON_UNESCAPED_UNICODE) : Null, 'tool' => $this->getTool() !== Null ? json_encode($this->getTool(), JSON_UNESCAPED_UNICODE) : Null, 'attachments' => $this->getAttachments() !== Null ? json_encode($this->getAttachments(), JSON_UNESCAPED_UNICODE) : Null, 'mentions' => $this->getMentions() !== Null ? json_encode($this->getMentions(), JSON_UNESCAPED_UNICODE) : Null, 'event' => $this->event, 'send_timestamp' => $this->sendTimestamp, 'show_in_ui' => $this->showInUi, 'raw_data' => $this->rawData ?? '', 'seq_id' => $this->seqId, 'processing_status' => $this->processingStatus, 'error_message' => $this->errorMessage, 'retry_count' => $this->retryCount, 'processed_at' => $this->processedAt, 'im_seq_id' => $this->imSeqId, 'correlation_id' => $this->correlationId, ]; } public static function taskMessageDTOToTaskMessageEntity(TaskMessageDTO $taskMessageDTO): TaskMessageEntity { $messageData = [ 'task_id' => $taskMessageDTO->getTaskId(), 'sender_type' => $taskMessageDTO->getRole(), 'sender_uid' => $taskMessageDTO->getSenderUid(), 'receiver_uid' => $taskMessageDTO->getReceiverUid(), 'type' => $taskMessageDTO->getMessageType(), 'content' => $taskMessageDTO->getContent(), 'status' => $taskMessageDTO->getStatus(), 'steps' => $taskMessageDTO->getSteps(), 'tool' => $taskMessageDTO->getTool(), 'attachments' => $taskMessageDTO->getAttachments(), 'mentions' => $taskMessageDTO->getMentions(), 'topic_id' => $taskMessageDTO->getTopicId(), 'event' => $taskMessageDTO->getEvent(), 'show_in_ui' => $taskMessageDTO->isShowInUi(), 'raw_content' => $taskMessageDTO->getRawContent(), ]; // Add message_id if provided if ($taskMessageDTO->getMessageId() !== Null) { $messageData['message_id'] = $taskMessageDTO->getMessageId(); } // Add im_seq_id if provided if ($taskMessageDTO->getImSeqId() !== Null) { $messageData['im_seq_id'] = $taskMessageDTO->getImSeqId(); } // Add correlation_id if provided if ($taskMessageDTO->getCorrelationId() !== Null) { $messageData['correlation_id'] = $taskMessageDTO->getCorrelationId(); } return new TaskMessageEntity($messageData); } } 