<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the software license */ namespace Dtyq\SuperMagic\Application\SuperAgent\Command; use Dtyq\SuperMagic\Application\SuperAgent\Crontab\MessageCompensationCrontab; use Hyperf\Command\Annotation\Command; use Hyperf\Command\Command as HyperfCommand; use Psr\Container\ContainerInterface; use Symfony\Component\Console\Input\InputOption; use Throwable; /** * Run Message Compensation Command * ManualRunMessageCompensationTaskCommand.*/ #[Command] class RunMessageCompensationCommand extends HyperfCommand { public function __construct(protected ContainerInterface $container) { parent::__construct('superagent:compensation'); } public function configure(): void { parent::configure(); $this->setDescription('Run message compensation task manually'); $this->addOption('loop', 'l', InputOption::VALUE_NONE, 'Run in loop mode (every 5 seconds)'); $this->addOption('times', 't', InputOption::VALUE_OPTIONAL, 'Number of times to run (only in loop mode)', 10); } public function handle(): void { $messageCompensationCrontab = $this->container->get(MessageCompensationCrontab::class); $isLoop = $this->input->getOption('loop'); $times = (int) $this->input->getOption('times'); if ($isLoop) { $this->info('StartloopRunMessageCompensationTask...'); $this->info("ConvertRun {$times}  times ，every times Interval 5  seconds "); for ($i = 1; $i <= $times; ++$i) { $this->info("--- th {$i}  times Run ---"); $startTime = microtime(true); try { $messageCompensationCrontab->execute(); $executionTime = round((microtime(true) - $startTime) * 1000, 2); $this->info("ExecuteComplete，consume time : {$executionTime}ms"); } catch (Throwable $e) { $this->error('Execution failed: ' . $e->getMessage()); } if ($i < $times) { $this->info('Wait 5  seconds ...'); sleep(5); } } $this->info('loopRunComplete！'); } else { $this->info('RunMessageCompensationTask...'); $startTime = microtime(true); try { $messageCompensationCrontab->execute(); $executionTime = round((microtime(true) - $startTime) * 1000, 2); $this->info("TaskExecuteComplete，consume time : {$executionTime}ms"); } catch (Throwable $e) { $this->error('TaskExecution failed: ' . $e->getMessage()); } } } } 