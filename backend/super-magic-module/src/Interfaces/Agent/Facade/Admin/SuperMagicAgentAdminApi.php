<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\SuperMagic\Interfaces\Agent\Facade\Admin; use App\Application\Flow\Service\MagicFlowAppService; use App\Domain\Flow\Entity\MagicFlowToolSetEntity; use App\Infrastructure\Util\ShadowCode\ShadowCode; use Delightful\ApiResponse\Annotation\ApiResponse; use Delightful\SuperMagic\Application\Agent\Service\SuperMagicAgentAiOptimizeAppService; use Delightful\SuperMagic\Application\Agent\Service\SuperMagicAgentAppService; use Delightful\SuperMagic\Domain\Agent\Entity\ValueObject\Query\SuperMagicAgentQuery; use Delightful\SuperMagic\Domain\Agent\Entity\ValueObject\SuperMagicAgentOptimizationType; use Delightful\SuperMagic\Interfaces\Agent\Assembler\BuiltinToolAssembler; use Delightful\SuperMagic\Interfaces\Agent\Assembler\SuperMagicAgentAssembler; use Delightful\SuperMagic\Interfaces\Agent\DTO\BuiltinToolDTO; use Delightful\SuperMagic\Interfaces\Agent\DTO\SuperMagicAgentDTO; use Delightful\SuperMagic\Interfaces\Agent\FormRequest\SuperMagicAgentAiOptimizeFormRequest; use Delightful\SuperMagic\Interfaces\Agent\FormRequest\SuperMagicAgentOrderFormRequest; use Delightful\SuperMagic\Interfaces\Agent\FormRequest\SuperMagicAgentQueryFormRequest; use Delightful\SuperMagic\Interfaces\Agent\FormRequest\SuperMagicAgentSaveFormRequest; use Hyperf\Di\Annotation\Inject; #[ApiResponse(version: 'low_code')] class SuperMagicAgentAdminApi extends AbstractSuperMagicAdminApi { #[Inject] protected SuperMagicAgentAppService $superMagicAgentAppService; #[Inject] protected SuperMagicAgentAiOptimizeAppService $superMagicAgentAiOptimizeAppService; #[Inject] protected MagicFlowAppService $magicFlowAppService; public function save(SuperMagicAgentSaveFormRequest $request) { $authorization = $this->getAuthorization(); $requestData = $request->validated(); $DTO = new SuperMagicAgentDTO($requestData); $promptShadow = $request->input('prompt_shadow'); if ($promptShadow) { $promptShadow = json_decode(ShadowCode::unShadow($promptShadow), true); $DTO->setPrompt($promptShadow); } $DO = SuperMagicAgentAssembler::createDO($DTO); $entity = $this->superMagicAgentAppService->save($authorization, $DO); $users = $this->superMagicAgentAppService->getUsers($entity->getOrganizationCode(), [$entity->getCreator(), $entity->getModifier()]); return SuperMagicAgentAssembler::createDTO($entity, $users); } public function queries(SuperMagicAgentQueryFormRequest $request) { $authorization = $this->getAuthorization(); $requestData = $request->validated(); $query = new SuperMagicAgentQuery($requestData); $page = $this->createPage(); $result = $this->superMagicAgentAppService->queries($authorization, $query, $page); return SuperMagicAgentAssembler::createCategorizedListDTO( frequent: $result['frequent'], all: $result['all'], total: $result['total'] ); } public function show(string $code) { $authorization = $this->getAuthorization(); $withToolSchema = (bool) $this->request->input('with_tool_schema', false); $entity = $this->superMagicAgentAppService->show($authorization, $code, $withToolSchema); $withPromptString = (bool) $this->request->input('with_prompt_string', false); $users = $this->superMagicAgentAppService->getUsers($entity->getOrganizationCode(), [$entity->getCreator(), $entity->getModifier()]); return SuperMagicAgentAssembler::createDTO($entity, $users, $withPromptString); } public function destroy(string $code) { $authorization = $this->getAuthorization(); $result = $this->superMagicAgentAppService->delete($authorization, $code); return ['success' => $result]; } public function enable(string $code) { $authorization = $this->getAuthorization(); $entity = $this->superMagicAgentAppService->enable($authorization, $code); $users = $this->superMagicAgentAppService->getUsers($entity->getOrganizationCode(), [$entity->getCreator(), $entity->getModifier()]); return SuperMagicAgentAssembler::createDTO($entity, $users); } public function disable(string $code) { $authorization = $this->getAuthorization(); $entity = $this->superMagicAgentAppService->disable($authorization, $code); $users = $this->superMagicAgentAppService->getUsers($entity->getOrganizationCode(), [$entity->getCreator(), $entity->getModifier()]); return SuperMagicAgentAssembler::createDTO($entity, $users); } /** * SaveAgentlineColumnSequential.*/ public function saveOrder(SuperMagicAgentOrderFormRequest $request) { $authorization = $this->getAuthorization(); $requestData = $request->validated(); $orderConfig = [ 'frequent' => $requestData['frequent'] ?? [], 'all' => $requestData['all'], ]; $this->superMagicAgentAppService->saveOrderConfig($authorization, $orderConfig); return ['message' => 'Agent order saved successfully']; } /** * getBuilt-inToollist.*/ public function tools() { return BuiltinToolAssembler::createToolCategoryListDTO(); } /** * AIOptimizeAgent.*/ public function aiOptimize(SuperMagicAgentAiOptimizeFormRequest $request) { $authorization = $this->getAuthorization(); $requestData = $request->validated(); // CreateOptimizeTypeEnumInstance (FormRequest ValidateEnsureValidproperty) $optimizationType = SuperMagicAgentOptimizationType::fromString($requestData['optimization_type']); // Use SuperMagicAgentAssembler Create entity $DTO = new SuperMagicAgentDTO($requestData['agent']); $promptShadow = $request->input('agent.prompt_shadow'); if ($promptShadow) { $promptShadow = json_decode(ShadowCode::unShadow($promptShadow), true); $DTO->setPrompt($promptShadow); } $agentEntity = SuperMagicAgentAssembler::createDO($DTO); // OnlyinOptimizeContent time onlyQueryToolinformation $availableTools = []; if ($optimizationType === SuperMagicAgentOptimizationType::OptimizeContent) { // CurrentuserAvailableToollist $builtinTools = BuiltinToolAssembler::createToolListDTO(); $customToolSets = $this->magicFlowAppService->queryToolSets($authorization, false, false)['list'] ?? []; // MergeBuilt-inToolAndCustomToolFor unifiedformat $availableTools = $this->mergeAvailableTools($builtinTools, $customToolSets); } // callOptimizeService $optimizedEntity = $this->superMagicAgentAiOptimizeAppService->optimizeAgent( $authorization, $optimizationType, $agentEntity, $availableTools ); return [ 'optimization_type' => $optimizationType->value, 'agent' => SuperMagicAgentAssembler::createDTO($optimizedEntity), ]; } /** * MergeBuilt-inToolAndCustomToolFor unifiedformat. * @param array<BuiltinToolDTO> $builtinTools * @param array<MagicFlowToolSetEntity> $customToolSets*/ private function mergeAvailableTools(array $builtinTools, array $customToolSets): array { $tools = []; // Process/HandleBuilt-inTool foreach ($builtinTools as $tool) { $tools[$tool->getCode()] = [ 'code' => $tool->getCode(), 'name' => $tool->getName(), 'description' => $tool->getDescription(), 'required' => $tool->isRequired(), 'type' => 'builtin', ]; } // Process/HandleCustomTool foreach ($customToolSets as $customToolSet) { foreach ($customToolSet->getTools() as $tool) { $tools[$tool['code']] = [ 'code' => $tool['code'], 'name' => $tool['name'], 'description' => $tool['description'], 'required' => false, 'type' => 'custom', ]; } } return $tools; } } 