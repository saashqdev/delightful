# File service
:80 {
    # Root directory for uploaded files
    root * /srv/files


    # Add a dedicated prefix path for the file service
    @static_files {
        path /files/*
    }

    # Handle OPTIONS preflight requests
    @options {
        method OPTIONS
        path /files/*
    }

    handle @options {
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "*"
        header Access-Control-Max-Age "3600"
        respond 204
    }

    # Serve static files for matching paths
    handle @static_files {
        uri strip_prefix /files
        file_server browse
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "*"
        header Access-Control-Max-Age "3600"
    }


    # WebSocket handling
    @websockets {
        header Connection *Upgrade*
        header Upgrade websocket
    }

    # Reverse proxy WebSocket requests
    reverse_proxy @websockets {
        to delightful-service:9502
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_down Access-Control-Allow-Origin *
    }

    # Reverse proxy API service
    reverse_proxy /api/* {
        to delightful-service:9501
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_down Access-Control-Allow-Origin *
    }

    # Reverse proxy API service
    reverse_proxy /v1/* {
        to delightful-service:9501
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_down Access-Control-Allow-Origin *
    }

    # By default proxy all other requests to the delightful-web service
    reverse_proxy {
        to delightful-web:8080
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }

    # Logging configuration
    log {
        output stdout
        format console
    }
}
