<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Application\SuperAgent\Service; use App\Application\Chat\Service\DelightfulAccountAppService; use App\Domain\Contact\Entity\AccountEntity; use App\Domain\Contact\Entity\DelightfulUserEntity; use App\Domain\Contact\Entity\ValueObject\AccountStatus; use App\Domain\Contact\Entity\ValueObject\DataIsolation; use App\Domain\Contact\Entity\ValueObject\UserType; use App\Domain\Contact\Service\DelightfulUserDomainService; use App\ErrorCode\GenericErrorCode; use App\Infrastructure\Core\Exception\ExceptionBuilder; use App\Interfaces\Authorization\Web\DelightfulUserAuthorization; use Delightful\BeDelightful\Domain\SuperAgent\Constant\AgentConstant; use Hyperf\Logger\LoggerFactory; use Psr\Log\LoggerInterface; use Throwable; class AccountAppService extends AbstractAppService { protected LoggerInterface $logger; public function __construct( private readonly DelightfulAccountAppService $magicAccountAppService, private readonly DelightfulUserDomainService $userDomainService, protected LoggerFactory $loggerFactory, ) { $this->logger = $this->loggerFactory->get(get_class($this)); } /** * @throws Throwable */ public function initAccount(string $organizationCode): array { // Querywhether already through store inBe DelightfulAccount, If store inThen notUpdate $dataIsolation = new DataIsolation(); $dataIsolation->setCurrentOrganizationCode($organizationCode); $aiUserEntity = $this->userDomainService->getByAiCode($dataIsolation, AgentConstant::SUPER_DELIGHTFUL_CODE); if (! empty($aiUserEntity)) { ExceptionBuilder::throw(GenericErrorCode::SystemError, 'account.super_magic_already_created'); } // InitializeAccount $accountDTO = new AccountEntity(); $accountDTO->setAiCode(AgentConstant::SUPER_DELIGHTFUL_CODE); $accountDTO->setStatus(AccountStatus::Normal); $accountDTO->setRealName('Be Delightful'); $userDTO = new DelightfulUserEntity(); $userDTO->setAvatarUrl('default'); $userDTO->setNickName('Be Delightful'); $userDTO->setDescription('Be DelightfulAccount，do not touch'); $authorization = new DelightfulUserAuthorization(); $authorization->setOrganizationCode($organizationCode); $authorization->setUserType(UserType::Human); try { $userEntity = $this->magicAccountAppService->aiRegister($userDTO, $authorization, AgentConstant::SUPER_DELIGHTFUL_CODE, $accountDTO); return $userEntity->toArray(); } catch (Throwable $e) { $this->logger->error('InitializeBe DelightfulAccountFailed，originalbecause：' . $e->getMessage()); throw $e; } } } 