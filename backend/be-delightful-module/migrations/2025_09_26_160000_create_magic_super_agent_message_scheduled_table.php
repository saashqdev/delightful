<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ use Hyperf\Database\Migrations\Migration; use Hyperf\Database\Schema\Blueprint; use Hyperf\Database\Schema\Schema; return new class extends Migration { /** * Run the migrations. */ public function up(): void { Schema::create('magic_super_agent_message_scheduled', function (Blueprint $table) { $table->bigInteger('id')->primary()->comment('primary keyID (SnowflakeID)'); $table->string('user_id', 128)->comment('user ID'); $table->string('organization_code', 64)->comment('userOrganization code'); $table->string('task_name', 255)->comment('scheduled taskname'); $table->string('message_type', 64)->comment('message type'); $table->json('message_content')->comment('message content'); $table->bigInteger('workspace_id')->unsigned()->comment('workspace ID'); $table->bigInteger('project_id')->unsigned()->comment('project ID'); $table->bigInteger('topic_id')->unsigned()->comment('topic ID'); $table->tinyInteger('completed')->default(0)->comment('yesnoComplete: 0- un Complete, 1-completed'); $table->tinyInteger('enabled')->default(1)->comment('whether enabled: 0-disabled, 1-enabled'); $table->dateTime('deadline')->Nullable()->comment('end time'); $table->string('remark', 500)->default('')->comment('note'); $table->json('time_config')->comment('configuration information'); $table->bigInteger('task_scheduler_crontab_id')->Nullable()->comment('TaskScheduleDevice definedwhentask ID'); $table->string('created_uid', 36)->default('')->comment('Creator user ID'); $table->string('updated_uid', 36)->default('')->comment('Updater user ID'); $table->timestamp('deleted_at')->Nullable()->comment('deleted time'); $table->timestamps(); // add index // 1. MainQueryindex (OverwriteBaseQuery + SortOptimize) // forway: user_id + organization_code + deleted_at + updated_at Sort $table->index(['user_id', 'organization_code', 'deleted_at', 'updated_at'], 'idx_user_org_deleted_updated'); // 2. WorkspaceQueryindex // forway: workspace_id + user_id + organization_code + deleted_at Filter $table->index(['workspace_id', 'user_id', 'organization_code', 'deleted_at'], 'idx_workspace_user_org_deleted'); // 3. ProjectQueryindex // forway: project_id + user_id + organization_code + deleted_at Filter $table->index(['project_id', 'user_id', 'organization_code', 'deleted_at'], 'idx_project_user_org_deleted'); // 4. StatusQueryindex // forway: enabled + completed + deleted_at StatusFilter $table->index(['enabled', 'completed', 'deleted_at'], 'idx_enabled_completed_deleted'); // 5. DeadlinewhenintervalQueryindex // forway: deadline + enabled + deleted_at fixedwhenTaskmanagement $table->index(['deadline', 'enabled', 'deleted_at'], 'idx_deadline_enabled_deleted'); }); } /** * Reverse the migrations. */ public function down(): void { } }; 