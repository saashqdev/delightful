<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Application\SuperAgent\Service; use App\Application\Kernel\AbstractKernelAppService; use App\Domain\Contact\Entity\ValueObject\DataIsolation; use App\Domain\Contact\Service\DelightfulDepartmentUserDomainService; use App\Domain\Provider\Service\ModelFilter\PackageFilterInterface; use App\Infrastructure\Core\Exception\ExceptionBuilder; use App\Infrastructure\Core\Traits\DataIsolationTrait; use App\Interfaces\Authorization\Web\DelightfulUserAuthorization; use Delightful\BeDelightful\Domain\SuperAgent\Entity\ProjectEntity; use Delightful\BeDelightful\Domain\SuperAgent\Entity\ValueObject\MemberRole; use Delightful\BeDelightful\Domain\SuperAgent\Service\ProjectDomainService; use Delightful\BeDelightful\Domain\SuperAgent\Service\ProjectMemberDomainService; use Delightful\BeDelightful\ErrorCode\SuperAgentErrorCode; class AbstractAppService extends AbstractKernelAppService { use DataIsolationTrait; /** * getusercanaccessedProjectEntity (defaultGreater than readableRole). * * @return ProjectEntity ProjectEntity*/ public function getAccessibleProject(int $projectId, string $userId, string $organizationCode, MemberRole $requiredRole = MemberRole::VIEWER): ProjectEntity { $projectDomainService = di(ProjectDomainService::class); $packageFilterService = di(PackageFilterInterface::class); $projectEntity = $projectDomainService->getProjectNotUserId($projectId); /*if ($projectEntity->getUserOrganizationCode() !== $organizationCode) { $logger->error('Project access denied', [ 'projectId' => $projectId, 'userId' => $userId, 'organizationCode' => $organizationCode, 'projectUserOrganizationCode' => $projectEntity->getUserOrganizationCode(), ]); ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); }*/ // If is Creator, directlyReturn if ($projectEntity->getUserId() === $userId) { return $projectEntity; } // JudgewhetherEnableShareProject if (! $projectEntity->getIsCollaborationEnabled()) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } // Validateidentity $delightfulUserAuthorization = new DelightfulUserAuthorization(); $delightfulUserAuthorization->setOrganizationCode($organizationCode); $delightfulUserAuthorization->setId($userId); $this->validateRoleHigherOrEqual($delightfulUserAuthorization, $projectId, $requiredRole); // JudgewhetherPaid plan if (! $packageFilterService->isPaidSubscription($projectEntity->getUserOrganizationCode())) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } return $projectEntity; } /** * getusercanaccessedProjectEntity (Greater thanEditRole).*/ public function getAccessibleProjectWithEditor(int $projectId, string $userId, string $organizationCode): ProjectEntity { return $this->getAccessibleProject($projectId, $userId, $organizationCode, MemberRole::EDITOR); } /** * getusercanaccessedProjectEntity (Greater thanmanagementRole).*/ public function getAccessibleProjectWithManager(int $projectId, string $userId, string $organizationCode): ProjectEntity { return $this->getAccessibleProject($projectId, $userId, $organizationCode, MemberRole::MANAGE); } /** * Validatemanagement person  or All person Permission.*/ protected function validateManageOrOwnerPermission(DelightfulUserAuthorization $delightfulUserAuthorization, int $projectId): void { $projectDomainService = di(ProjectDomainService::class); $projectEntity = $projectDomainService->getProjectNotUserId($projectId); // JudgewhetherEnableShareProject if (! $projectEntity->getIsCollaborationEnabled()) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } $this->validateRoleHigherOrEqual($delightfulUserAuthorization, $projectId, MemberRole::MANAGE); } /** * ValidatecanEdit person Permission.*/ protected function validateEditorPermission(DelightfulUserAuthorization $delightfulUserAuthorization, int $projectId): void { $projectDomainService = di(ProjectDomainService::class); $projectEntity = $projectDomainService->getProjectNotUserId($projectId); // JudgewhetherEnableShareProject if (! $projectEntity->getIsCollaborationEnabled()) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } $this->validateRoleHigherOrEqual($delightfulUserAuthorization, $projectId, MemberRole::EDITOR); } /** * ValidateReadablePermission.*/ protected function validateViewerPermission(DelightfulUserAuthorization $delightfulUserAuthorization, int $projectId): void { $projectDomainService = di(ProjectDomainService::class); $projectEntity = $projectDomainService->getProjectNotUserId($projectId); // JudgewhetherEnableShareProject if (! $projectEntity->getIsCollaborationEnabled()) { ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } $this->validateRoleHigherOrEqual($delightfulUserAuthorization, $projectId, MemberRole::VIEWER); } /** * ValidateCurrentuserRolewhetherGreater thanOr equalspecifiedRole.*/ protected function validateRoleHigherOrEqual(DelightfulUserAuthorization $delightfulUserAuthorization, int $projectId, MemberRole $requiredRole): void { $projectMemberService = di(ProjectMemberDomainService::class); $delightfulDepartmentUserDomainService = di(DelightfulDepartmentUserDomainService::class); $userId = $delightfulUserAuthorization->getId(); $projectMemberEntity = $projectMemberService->getMemberByProjectAndUser($projectId, $userId); if ($projectMemberEntity && $projectMemberEntity->getRole()->isHigherOrEqualThan($requiredRole)) { return; } $dataIsolation = DataIsolation::create($delightfulUserAuthorization->getOrganizationCode(), $userId); $departmentIds = $delightfulDepartmentUserDomainService->getDepartmentIdsByUserId($dataIsolation, $userId, true); $projectMemberEntities = $projectMemberService->getMembersByProjectAndDepartmentIds($projectId, $departmentIds); foreach ($projectMemberEntities as $projectMemberEntity) { if ($projectMemberEntity->getRole()->isHigherOrEqualThan($requiredRole)) { return; } } ExceptionBuilder::throw(SuperAgentErrorCode::PROJECT_ACCESS_DENIED); } } 