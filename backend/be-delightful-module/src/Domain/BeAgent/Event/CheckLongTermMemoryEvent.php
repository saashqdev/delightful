<?php declare(strict_types=1); /** * Copyright (c) Be Delightful , Distributed under the MIT software license */ namespace Delightful\BeDelightful\Domain\BeAgent\Event; use App\Domain\Chat\DTO\Agent\SenderExtraDTO; use App\Domain\Chat\DTO\Message\TextContentInterface; use App\Domain\Chat\Entity\DelightfulMessageEntity; use App\Domain\Chat\Entity\DelightfulSeqEntity; use App\Domain\Contact\Entity\AccountEntity; use App\Domain\Contact\Entity\DelightfulUserEntity; use App\Infrastructure\Core\AbstractEvent; use Hyperf\Codec\Json; /** * Check whether long-term memory event is needed.*/ class CheckLongTermMemoryEvent extends AbstractEvent { public function __construct( public AccountEntity $agentAccountEntity, public DelightfulUserEntity $agentUserEntity, public AccountEntity $senderAccountEntity, public DelightfulUserEntity $senderUserEntity, public DelightfulSeqEntity $seqEntity, public ?DelightfulMessageEntity $messageEntity, public SenderExtraDTO $senderExtraDTO, ) { } public function getOrganizationCode(): string { return $this->senderUserEntity->getOrganizationCode(); } public function getUserId(): string { return $this->senderUserEntity->getUserId(); } public function getAgentUserId(): string { return $this->agentUserEntity->getUserId(); } public function getConversationId(): string { return $this->seqEntity->getConversationId() ?? ''; } public function getChatTopicId(): string { return $this->seqEntity->getExtra()?->getTopicId() ?? ''; } public function getPrompt(): string { $messageStruct = $this->messageEntity?->getContent(); if ($messageStruct instanceof TextContentInterface) { return $messageStruct->getTextContent(); } return ''; } public function getAttachments(): string { $attachments = $this->messageEntity?->getContent()?->getAttachments() ?? []; return ! empty($attachments) ? Json::encode($attachments) : ''; } public function getInstructions(): array { return $this->messageEntity?->getContent()?->getInstructs() ?? []; } public function getMentions(): ?string { // Simplified implementation, Avoid complex type checking return Null; } public function getRawContent(): ?string { // Due to complex logic required for building original content, Return basic information here return Json::encode([ 'seq_id' => $this->seqEntity->getSeqId(), 'message_id' => $this->seqEntity->getMessageId(), 'conversation_id' => $this->seqEntity->getConversationId(), ]); } /** * Get event ID (Use seq_id as event unique identifier).*/ public function getEventId(): string { return $this->seqEntity->getSeqId(); } /** * Convert to array format. * * @return array Event data array*/ public function toArray(): array { return [ 'seq_id' => $this->seqEntity->getSeqId(), 'organization_code' => $this->getOrganizationCode(), 'user_id' => $this->getUserId(), 'agent_user_id' => $this->getAgentUserId(), 'conversation_id' => $this->getConversationId(), 'chat_topic_id' => $this->getChatTopicId(), 'prompt' => $this->getPrompt(), 'attachments' => $this->getAttachments(), 'instructions' => $this->getInstructions(), 'mentions' => $this->getMentions(), 'raw_content' => $this->getRawContent(), ]; } } 
