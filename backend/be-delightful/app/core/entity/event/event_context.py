"""
Event context module

Provides event context class for carrying data during event propagation
"""

import uuid
from typing import List, Optional

from pydantic import BaseModel, ConfigDict, Field

from app.core.entity.attachment import Attachment


class EventContext(BaseModel):
    """Event context for passing data between multiple listeners

    Event context allows multiple listeners to share data, especially useful when later listeners need
    to use data generated by earlier listeners.

    During tool execution, a tool may trigger multiple events, these events should share
    the same event context to pass data between events.
    """
    # Predefined context fields
    attachments: List[Attachment] = Field(default_factory=list)
    # Mark whether finish_task tool has been called
    finish_task_called: bool = Field(default=False)
    # Mark whether todo_items have changed, need to update steps
    steps_changed: bool = Field(default=False)
    # Event context ID
    id: str = Field(default_factory=str)

    model_config = ConfigDict(arbitrary_types_allowed=True)

    def __init__(self, **kwargs):
        super().__init__(**kwargs)

        self.id = str(uuid.uuid4())

    def add_attachment(self, attachment: Attachment) -> None:
        """Add attachment to context

        Args:
            attachment: Attachment object to add
        """
        self.attachments.append(attachment)

    def get_attachment_by_key(self, key: str) -> Optional[Attachment]:
        """Get attachment by key

        Args:
            key: Attachment's object_key

        Returns:
            Found attachment object, returns None if not found
        """
        for attachment in self.attachments:
            if attachment.key == key:
                return attachment
        return None
