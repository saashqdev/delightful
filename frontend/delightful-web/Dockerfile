# ===== Base Image Configuration =====
# Base image: node:18-alpine
ARG IMAGE_SOURCE
ARG NODE_IMAGE=${IMAGE_SOURCE}node:18-alpine
# =================================================

# build
FROM ${NODE_IMAGE} AS builder

WORKDIR /app

COPY package.json ./

RUN npm install pnpm --location=global && \
    # Install patch-package to ensure @feb/formily packages correctly
    npm install patch-package -g && \
    pnpm install

COPY . .

RUN pnpm build

# deploy
FROM ${NODE_IMAGE} as runner

# Redefine environment variables in the runner stage
ARG CI_COMMIT_SHA
ARG CI_COMMIT_TAG
ENV DELIGHTFUL_APP_SHA=${CI_COMMIT_SHA}
ENV DELIGHTFUL_APP_VERSION=${CI_COMMIT_TAG}

WORKDIR /app

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/server ./server

COPY server/package.json ./

RUN npm install && \
    # Remove temporary files generated by node build
    rm -rf /tmp/node-compile-cache

CMD ["node", "./server/app.cjs"]

EXPOSE 8080
